<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITSCG | Prenotazione Ministage Orientamento</title>
    <!-- Tailwind CSS CDN per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- jsPDF CDN per la generazione dei PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .tab-active { border-bottom: 4px solid #4f46e5; color: #4f46e5; font-weight: 700; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 1.5rem; height: 1.5rem; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-button-primary { background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .modal-button-primary:hover:enabled { background-color: #4338ca; }
        .modal-button-secondary { background-color: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .modal-button-secondary:hover { background-color: #e5e7eb; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-bottom: 4px solid transparent;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }
        .tab-button:hover:not(.tab-active) {
            border-bottom: 4px solid #c7d2fe; /* light indigo */
        }
        .date-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .date-card:hover:not(.cursor-not-allowed) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Messaggio di Notifica (SnackBar) -->
    <div id="message-box" class="fixed top-5 right-5 hidden p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 opacity-0" role="alert"></div>

    <!-- Contenitore Principale -->
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header e Stato -->
        <header class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-4 md:mb-0">ITSCG | Prenotazioni Ministage</h1>
            <div class="flex items-center space-x-4">
                <!-- Bottone Chatbot -->
                <a href="chatbot.html" target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 01-4.24-.958l-.6 1.258A1 1 0 014 20.94V19a9 9 0 1117-7z"></path></svg>
                    <span>Chatbot ITSCG</span>
                </a>
                <button id="open-docente-login-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md">
                    Accesso Docente
                </button>
            </div>
        </header>

        <!-- Spinner di Caricamento Iniziale -->
        <div id="loading-spinner" class="flex flex-col items-center justify-center p-12 bg-white rounded-xl shadow-lg mt-12">
            <div class="spinner border-indigo-500 border-t-indigo-700 w-8 h-8"></div>
            <p id="loading-status" class="mt-4 text-lg text-gray-600">Connessione a Firebase...</p>
        </div>

        <!-- ========================================================================= -->
        <!-- VISTA STUDENTE (Default) -->
        <!-- ========================================================================= -->
        <div id="student-main-view" class="space-y-8 hidden">
            
            <!-- SEZIONE INFORMATIVA DETTAGLIATA -->
            <section class="bg-indigo-50 p-6 rounded-xl shadow-md border-l-4 border-indigo-500 space-y-4">
                <p class="text-lg font-extrabold text-red-600">‚ö†Ô∏è ATTENZIONE: Documento di Conferma Importante!</p>
                <p class="text-gray-700">Conservare il PDF di conferma e presentarlo all'ingresso il giorno dello Stage. </p>
                <p class="text-gray-700">Presentarsi almeno 10 minuti prima dell' orario indicato. </p>
                
                <p class="text-sm text-gray-500 pt-3">Organizzazione a cura delle Funzioni Orientamento: Prof. ssa Mariagrazia Calabrese e Prof. ssa Laura Corvi. ITSCG PRIMO LEVI DI SEREGNO, VIA BRIANTINA 68.</p>

                <div id="cancellation-section" class="pt-4 border-t border-indigo-200 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                    <p class="text-yellow-800 font-medium">Hai gi√† prenotato ma devi annullare? Utilizza il tuo codice prenotazione.</p>
                    <button id="open-cancellation-modal-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 shadow-lg">
                        Annulla Prenotazione
                    </button>
                </div>
            </section>

            <!-- 1. SELEZIONE CORSO -->
            <section id="course-selection-view" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Scegli l'Indirizzo di Studio per il tuo Ministage:</h2>
                <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- I corsi saranno renderizzati qui -->
                </div>
            </section>

            <!-- 2. SELEZIONE DATA (Dopo aver scelto il corso) -->
            <section id="date-selection-view" class="hidden bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center space-x-4 mb-6 border-b pb-4">
                    <button id="back-to-courses-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Torna agli Indirizzi
                    </button>
                    <h2 id="selected-course-title" class="text-xl font-bold text-gray-800"></h2>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Seleziona una data e un orario disponibile:</h3>
                <div id="dates-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Le date saranno renderizzate qui -->
                </div>
            </section>
        </div>
        
        <!-- ========================================================================= -->
        <!-- VISTA DOCENTE -->
        <!-- ========================================================================= -->
        <div id="docente-view" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-indigo-700">Dashboard Docente | Gestione Prenotazioni</h2>
                    <button id="logout-docente-btn" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md">
                        Logout
                    </button>
                </div>

                <!-- Tabs di Navigazione -->
                <div class="flex border-b mb-6 overflow-x-auto whitespace-nowrap">
                    <button id="tab-bookings" class="tab-button tab-active">Prenotazioni Attive</button>
                    <button id="tab-cancellations" class="tab-button">Log Annullamenti</button>
                </div>
                
                <!-- Contenuto Tab 1: Prenotazioni Attive -->
                <div id="content-bookings" class="tab-content space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                            <label class="flex items-center space-x-2 text-gray-600">
                                Filtra per Data:
                                <select id="date-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full"></select>
                            </label>
                            <button id="export-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 w-full sm:w-auto">
                                Esporta in CSV
                            </button>
                        </div>
                        <button id="open-delete-modal-btn" class="bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-xl transition duration-200 w-full sm:w-auto">
                            Cancella tutti i dati
                        </button>
                    </div>

                    <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Codice</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Studente</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Corso</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Data</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Orario</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Scuola Media</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Contatti</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Iscritto il</th>
                                </tr>
                            </thead>
                            <tbody id="bookings-table-body" class="bg-white divide-y divide-gray-100">
                                <!-- I dati delle prenotazioni attive saranno qui -->
                            </tbody>
                        </table>
                        <p id="no-bookings-message" class="hidden p-4 text-center text-gray-500">Nessuna prenotazione attiva trovata per il filtro selezionato.</p>
                    </div>
                </div>

                <!-- Contenuto Tab 2: Log Annullamenti -->
                <div id="content-cancellations" class="tab-content hidden space-y-6">
                    <p class="text-sm text-gray-500 mb-4">Registro di tutte le prenotazioni che sono state annullate dagli utenti. Questi posti sono stati ripristinati.</p>
                    <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Codice Annullato</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Nome Studente</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Corso</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Data/Ora Originale</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Annullato il</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Motivazione</th>
                                </tr>
                            </thead>
                            <tbody id="cancellations-table-body" class="bg-white divide-y divide-gray-100">
                                <!-- I log di cancellazione saranno qui -->
                            </tbody>
                        </table>
                        <p id="no-cancellations-message" class="hidden p-4 text-center text-gray-500">Nessun annullamento registrato finora.</p>
                    </div>
                </div>

            </div>
        </div>
        <!-- Modali (lasciate identiche per funzionalit√†) -->
        <!-- Modale Prenotazione Studente -->
        <div id="booking-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-indigo-700">Conferma Iscrizione al Ministage</h3>
                <p class="text-gray-600">Stai per prenotare un posto per l'indirizzo <strong id="modal-course-name"></strong> in data <strong id="modal-date"></strong>.</p>
                
                <form id="booking-form" class="space-y-4">
                    <input type="hidden" id="booking-course-id" name="courseId">
                    <input type="hidden" id="booking-date" name="date">

                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome e Cognome dello Studente <span class="text-red-500">*</span></label>
                        <input type="text" id="student-name" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-school" class="block text-sm font-medium text-gray-700">Scuola Media di Provenienza <span class="text-red-500">*</span></label>
                        <input type="text" id="student-school" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-email" class="block text-sm font-medium text-gray-700">Email di Contatto (per la conferma PDF) <span class="text-red-500">*</span></label>
                        <input type="email" id="student-email" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-phone" class="block text-sm font-medium text-gray-700">Cellulare di Contatto <span class="text-red-500">*</span></label>
                        <input type="tel" id="student-phone" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <p class="text-xs text-red-500">ATTENZIONE: Verr√† generato un PDF di conferma OBBLIGATORIO da presentare all'ingresso.</p>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-modal-btn" class="modal-button-secondary">Chiudi</button>
                        <button type="submit" id="confirm-booking-btn" class="modal-button-primary flex items-center">
                            Conferma e Genera PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale Annullamento Studente -->
        <div id="cancellation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-red-600">Annulla la tua Prenotazione</h3>
                <p class="text-gray-600">Inserisci il codice di prenotazione che hai ricevuto via PDF per annullare la tua iscrizione.</p>
                
                <form id="cancellation-form" class="space-y-4">
                    <div>
                        <label for="cancellation-code" class="block text-sm font-medium text-gray-700">Codice Prenotazione (es: ABC123XYZ) <span class="text-red-500">*</span></label>
                        <input type="text" id="cancellation-code" required minlength="10" maxlength="10" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500 uppercase">
                    </div>
                    <div>
                        <label for="cancellation-reason" class="block text-sm font-medium text-gray-700">Motivazione (Opzionale)</label>
                        <textarea id="cancellation-reason" rows="3" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-cancellation-modal-btn" class="modal-button-secondary">Annulla</button>
                        <button type="submit" id="confirm-cancellation-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-md flex items-center">
                            Annulla la mia Prenotazione
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale Login Docente -->
        <div id="docente-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4">
                <h3 class="text-xl font-bold text-gray-800">Accesso Riservato Docente</h3>
                <p class="text-sm text-gray-500">Inserisci le credenziali per accedere alla dashboard di gestione.</p>
                
                <form id="docente-login-form" class="space-y-4">
                    <div>
                        <label for="docente-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="docente-username" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="docente-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="docente-password" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="document.getElementById('docente-login-modal').classList.add('hidden')" class="modal-button-secondary">Chiudi</button>
                        <button type="submit" class="modal-button-primary">
                            Accedi
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modale Eliminazione Dati Docente -->
        <div id="delete-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-red-700">CANCELLAZIONE DATI COMPLETA</h3>
                <p class="text-sm text-gray-600">Questa azione √® IRREVERSIBILE ed eliminer√† tutte le prenotazioni e i log di annullamento dal database Firebase per questo progetto.</p>
                <p class="text-sm font-bold text-red-700">Procedi solo se necessario per azzerare l'anno accademico.</p>
                
                <form id="docente-delete-form" class="space-y-4">
                    <div>
                        <label for="docente-delete-password" class="block text-sm font-medium text-gray-700">Password Docente per Conferma <span class="text-red-500">*</span></label>
                        <input type="password" id="docente-delete-password" required class="mt-1 block w-full border-red-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-delete-modal-btn" class="modal-button-secondary">Annulla</button>
                        <button type="submit" id="confirm-delete-btn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-md flex items-center">
                            CONFERMA ELIMINAZIONE DATI
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- ========================================================================= -->
    <!-- LOGICA JAVASCRIPT E FIREBASE (Modulo Unico) -->
    <!-- ========================================================================= -->
    <script type="module">
        // =========================================================================
        // üìö IMPORTAZIONI FIREBASE
        // =========================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, addDoc, onSnapshot, serverTimestamp, 
            deleteDoc, getDocs, doc, setLogLevel, writeBatch, runTransaction, where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Impostiamo il livello di log per il debug (opzionale)
        setLogLevel('error');
        
        // =========================================================================
        // ‚öôÔ∏è CONFIGURAZIONE FIREBASE E VARIABILI DI STATO
        // =========================================================================
        
        // CONFIGURAZIONE GLOBALE/FALLBACK (per ambiente Canvas)
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const canvasAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Configurazione di fallback se i globali non sono presenti
        const fallbackConfig = {
            apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
            authDomain: "progetto-63fb3.firebaseapp.com",
            projectId: "progetto-63fb3", 
            storageBucket: "progetto-63fb3.firebasestorage.app",
            messagingSenderId: "883088850197",
            appId: "1:883088850197:web:29b8573ea43555041b3d1c",
            measurementId: "G-2PNR8PQHDR"
        };

        const firebaseConfig = Object.keys(canvasFirebaseConfig).length > 0 ? canvasFirebaseConfig : fallbackConfig;
        const PROJECT_ID_AS_APP_ID = canvasAppId === 'default-app-id' ? firebaseConfig.projectId : canvasAppId;
        
        // Variabili Firebase e Stato Globale
        let db = null;
        let auth = null;
        let userId = null;
        let isDocente = false; 
        
        const MAX_SLOTS = 4; // Posti fissi per ogni slot data/corso UNICO (incluso l'orario)
        let currentBookings = []; 
        let currentCancellations = [];
        let currentAvailability = {}; 
        let currentCourseId = null; 
        
        // Credenziali Docente Fisse (Utilizzate solo per la simulazione di login)
        const DOCENTE_USERNAME = 'docente';
        const DOCENTE_PASSWORD = 'its2025'; // Password di esempio

        // Collezioni: tutte pubbliche per permettere ai non autenticati (studenti anonimi) di leggere/scrivere
        const BOOKINGS_COLLECTION_PATH = `/artifacts/${PROJECT_ID_AS_APP_ID}/public/data/bookings`;
        const CANCELLATIONS_COLLECTION_PATH = `/artifacts/${PROJECT_ID_AS_APP_ID}/public/data/cancellations`;
        
        // Struttura fissa dei corsi (gli stessi definiti nell'HTML originale)
        const COURSES = [
            { id: 'SA', name: 'Liceo Scientifico Opzione Scienze Applicate', color: 'bg-red-100 text-red-800', icon: '<svg class="w-8 h-8 text-red-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2m-6 4v2m6-2v2m-6 4v2m6-2v2M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2zM9 8h6M9 12h6M9 16h6"></path></svg>', dates: [ '2025-11-03|Luned√¨|11:50-13:50', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|11:50-13:50', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|11:50-13:50', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|11:50-13:50', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|11:50-13:50', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|11:50-13:50', '2025-12-15|Luned√¨|11:50-13:50', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'SM', name: 'Sistema Moda', color: 'bg-purple-100 text-purple-800', icon: '<svg class="w-8 h-8 text-purple-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13v8a1 1 0 001 1h8a1 1 0 001-1v-8m-7 0H7m0 0l-1-2m1 2l1-2m7 2h-4m-4 0l-1-2m1 2l1-2m-1 2H7"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'RM', name: 'Relazioni Internazionali per il Marketing', color: 'bg-blue-100 text-blue-800', icon: '<svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v5m0 0a2 2 0 100 4 2 2 0 000-4zM12 8V6a2 2 0 100-4 2 2 0 000 4z"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'LG', name: 'Logistica Corso Quadriennale', color: 'bg-green-100 text-green-800', icon: '<svg class="w-8 h-8 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-4 4m0 0l-4-4m4 4V7"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'CT', name: 'Costruzione Ambiente e Territorio', color: 'bg-orange-100 text-orange-800', icon: '<svg class="w-8 h-8 text-orange-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] }
        ];

        // Elementi DOM
        const coursesContainer = document.getElementById('courses-container');
        const messageBox = document.getElementById('message-box');
        const bookingModal = document.getElementById('booking-modal');
        const cancellationModal = document.getElementById('cancellation-modal');
        const bookingForm = document.getElementById('booking-form');
        const cancellationForm = document.getElementById('cancellation-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingStatus = document.getElementById('loading-status');
        const docenteLoginModal = document.getElementById('docente-login-modal');
        const docenteLoginForm = document.getElementById('docente-login-form');
        const studentMainView = document.getElementById('student-main-view');
        const docenteView = document.getElementById('docente-view');
        const dateFilter = document.getElementById('date-filter');
        const deleteDataModal = document.getElementById('delete-data-modal');
        const docenteDeleteForm = document.getElementById('docente-delete-form');
        const courseSelectionView = document.getElementById('course-selection-view');
        const dateSelectionView = document.getElementById('date-selection-view');

        // =========================================================================
        // üõ†Ô∏è FUNZIONI UTILITY
        // =========================================================================

        /**
         * Mostra un messaggio di notifica (snackbar) all'utente.
         * @param {string} message Il testo del messaggio.
         * @param {string} type Il tipo ('success', 'error', 'warning', 'info').
         */
        function showMessage(message, type = 'info') {
            const box = messageBox;
            let bgColor = 'bg-blue-500';
            let textColor = 'text-white';

            switch (type) {
                case 'success': bgColor = 'bg-green-500'; break;
                case 'error': bgColor = 'bg-red-600'; break;
                case 'warning': bgColor = 'bg-yellow-500'; textColor = 'text-gray-900'; break;
                case 'info': bgColor = 'bg-indigo-500'; break;
            }

            box.className = `fixed top-5 right-5 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-300 ${bgColor} ${textColor} opacity-0`;
            box.innerHTML = message;

            // Mostra il box
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('opacity-100'), 10);

            // Nascondi dopo 5 secondi
            setTimeout(() => {
                box.classList.remove('opacity-100');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 5000);
        }

        /**
         * Genera un codice di prenotazione univoco di 10 caratteri.
         * @returns {string} Codice alfanumerico in maiuscolo.
         */
        function generateBookingCode() {
            return Math.random().toString(36).substring(2, 12).toUpperCase();
        }

        /**
         * Formatta un timestamp di Firestore in una stringa leggibile (giorno/mese/anno ore:minuti).
         * @param {object} timestamp Il campo timestamp di Firestore.
         * @returns {string} Data e ora formattate.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Formatta la stringa data/ora (YYYY-MM-DD|Giorno|HH:MM-HH:MM) per la visualizzazione.
         * @param {string} dateString La stringa nel formato 'YYYY-MM-DD|Giorno|Orario'.
         * @returns {{date: string, day: string, time: string, fullDate: string}} Oggetto con i componenti.
         */
        function parseDateString(dateString) {
            const [date, day, time] = dateString.split('|');
            const [year, month, dayOfMonth] = date.split('-');
            return {
                date: `${dayOfMonth}/${month}/${year}`,
                day: day,
                time: time,
                fullDate: date // YYYY-MM-DD
            };
        }

        /**
         * Genera il PDF di conferma utilizzando jsPDF.
         * @param {object} bookingData I dati della prenotazione.
         */
        function generatePDF(bookingData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 15;
            
            // Configurazione del font per l'Italiano
            doc.setFont('Helvetica');

            // Titolo Principale
            doc.setFontSize(22);
            doc.setTextColor(79, 70, 229); // Indigo-600
            doc.text('ITSCG - ISTITUTO TECNICO E LICEO SCIENTIFICO', pageWidth / 2, y, { align: 'center' });
            y += 8;

            doc.setFontSize(18);
            doc.setTextColor(31, 41, 55); // Gray-800
            doc.text('Conferma Prenotazione Ministage Orientamento', pageWidth / 2, y, { align: 'center' });
            y += 15;

            // Sezione Informazioni Chiave (Box)
            const boxWidth = pageWidth * 0.8;
            const boxX = (pageWidth - boxWidth) / 2;
            
            doc.setFillColor(238, 242, 255); // Indigo-50
            doc.rect(boxX, y, boxWidth, 50, 'F');
            
            doc.setFontSize(14);
            doc.setTextColor(79, 70, 229); // Indigo-600
            doc.setFont('Helvetica', 'Bold');
            doc.text(`Codice di Prenotazione (OBBLIGATORIO):`, boxX + 5, y + 8);
            
            doc.setFontSize(24);
            doc.setTextColor(220, 38, 38); // Red-600
            doc.text(bookingData.code, pageWidth / 2, y + 25, { align: 'center' });
            doc.setFont('Helvetica', 'Normal');
            
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128); // Gray-500
            doc.text('Conservare e presentare questo codice all\'ingresso.', pageWidth / 2, y + 42, { align: 'center' });
            y += 60;

            // Dettagli Prenotazione
            const details = [
                { label: 'Studente:', value: bookingData.studentName },
                { label: 'Scuola Media:', value: bookingData.studentSchool },
                { label: 'Indirizzo Scelto:', value: bookingData.courseName },
                { label: 'Data Stage:', value: bookingData.date },
                { label: 'Orario Stage:', value: bookingData.time },
                { label: 'Email Contatto:', value: bookingData.studentEmail },
                { label: 'Cellulare Contatto:', value: bookingData.studentPhone },
                { label: 'Prenotato il:', value: formatTimestamp(bookingData.bookedAt) },
            ];
            
            doc.setFontSize(12);
            doc.setTextColor(31, 41, 55); // Gray-800
            doc.setFont('Helvetica', 'Bold');
            doc.text('Dettagli Iscrizione:', boxX, y);
            y += 5;
            
            doc.setFont('Helvetica', 'Normal');
            details.forEach(detail => {
                doc.text(detail.label, boxX, y);
                doc.setFont('Helvetica', 'Bold');
                doc.text(detail.value, boxX + 45, y); // Offset per il valore
                doc.setFont('Helvetica', 'Normal');
                y += 7;
            });

            y += 10;
            
            // Istruzioni Importanti
            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81); // Gray-700
            doc.setFont('Helvetica', 'Bold');
            doc.text('ISTRUZIONI IMPORTANTI:', boxX, y);
            y += 5;
            
            doc.setFont('Helvetica', 'Normal');
            doc.text('- Presentarsi almeno 10 minuti prima dell\'orario indicato.', boxX, y); y += 5;
            doc.text('- Portare una copia di questo documento (digitale o cartacea).', boxX, y); y += 5;
            doc.text('- Il Ministage si terr√† presso: ITSCG PRIMO LEVI DI SEREGNO, VIA BRIANTINA 68.', boxX, y); y += 5;

            // Genera il file
            doc.save(`ITSCG_Prenotazione_${bookingData.courseId}_${bookingData.date.replace(/\//g, '-')}.pdf`);
        }

        // =========================================================================
        // üîÑ LOGICA FIREBASE E GESTIONE DELLO STATO
        // =========================================================================

        /**
         * Ottiene un riferimento alla collezione per le prenotazioni.
         * @returns {object} Riferimento alla collezione.
         */
        function getBookingsCollection() {
            return collection(db, BOOKINGS_COLLECTION_PATH);
        }

        /**
         * Ottiene un riferimento alla collezione per gli annullamenti.
         * @returns {object} Riferimento alla collezione.
         */
        function getCancellationsCollection() {
            return collection(db, CANCELLATIONS_COLLECTION_PATH);
        }

        /**
         * Processa le prenotazioni e calcola la disponibilit√†.
         * @param {Array<Object>} bookings L'array delle prenotazioni attive.
         */
        function calculateAvailability(bookings) {
            const availability = {};
            
            // Inizializza tutti gli slot con la capienza massima
            COURSES.forEach(course => {
                course.dates.forEach(dateString => {
                    const key = `${course.id}|${dateString}`;
                    availability[key] = {
                        courseId: course.id,
                        dateString: dateString,
                        maxSlots: MAX_SLOTS,
                        booked: 0,
                    };
                });
            });

            // Aggiorna il conteggio basato sulle prenotazioni attive
            bookings.forEach(booking => {
                const key = `${booking.courseId}|${booking.dateString}`;
                if (availability[key]) {
                    availability[key].booked += 1;
                }
            });

            currentAvailability = availability;
            
            // Se siamo nella vista studente e abbiamo selezionato un corso, aggiorna i bottoni delle date
            if (!isDocente && currentCourseId) {
                renderDates(currentCourseId);
            }
        }

        /**
         * Ascolta le prenotazioni in tempo reale.
         */
        function startBookingsListener() {
            const q = query(getBookingsCollection());
            onSnapshot(q, (snapshot) => {
                currentBookings = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    currentBookings.push({ id: doc.id, ...data });
                });
                
                console.log(`[Firestore] Trovate ${currentBookings.length} prenotazioni attive.`);
                calculateAvailability(currentBookings);
                
                if (isDocente) {
                    renderDocenteDashboard();
                } else {
                    // Assicurati che la vista studente sia pronta dopo il caricamento iniziale
                    loadingSpinner.classList.add('hidden');
                    studentMainView.classList.remove('hidden');
                    courseSelectionView.classList.remove('hidden');
                    renderCourses();
                }
            }, (error) => {
                console.error("Errore nell'ascolto delle prenotazioni:", error);
                // Non usare alert.
                showMessage("Errore di connessione al database. Riprova pi√π tardi.", 'error');
                loadingStatus.textContent = "Errore di caricamento dati.";
            });
        }

        /**
         * Ascolta gli annullamenti in tempo reale.
         */
        function startCancellationsListener() {
            const q = query(getCancellationsCollection());
            onSnapshot(q, (snapshot) => {
                currentCancellations = [];
                snapshot.forEach((doc) => {
                    currentCancellations.push({ id: doc.id, ...doc.data() });
                });
                console.log(`[Firestore] Trovati ${currentCancellations.length} annullamenti.`);
                
                if (isDocente) {
                    renderCancellationsLog();
                }
            }, (error) => {
                console.error("Errore nell'ascolto degli annullamenti:", error);
            });
        }

        // =========================================================================
        // üè† VISTA STUDENTE - RENDERING E INTERAZIONE
        // =========================================================================

        /**
         * Renderizza le schede dei corsi nella sezione di selezione.
         */
        function renderCourses() {
            coursesContainer.innerHTML = '';
            COURSES.forEach(course => {
                const totalAvailability = course.dates.length * MAX_SLOTS;
                let totalBooked = 0;
                
                course.dates.forEach(dateString => {
                    const key = `${course.id}|${dateString}`;
                    totalBooked += currentAvailability[key]?.booked || 0;
                });

                const card = document.createElement('div');
                card.className = `p-6 rounded-xl shadow-lg border-t-8 border-indigo-500 bg-white date-card`;
                card.setAttribute('data-course-id', course.id);
                card.innerHTML = `
                    ${course.icon}
                    <h3 class="text-xl font-extrabold text-gray-900 mb-2">${course.name} (${course.id})</h3>
                    <p class="text-sm ${course.color.replace('bg-', 'text-')} font-medium">${course.id === 'LG' ? 'Corso Quadriennale' : 'Corso Ordinario'}</p>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <p class="text-sm font-semibold text-gray-700">Posti totali disponibili:</p>
                        <p class="text-lg font-bold text-indigo-600">${totalAvailability - totalBooked} / ${totalAvailability}</p>
                    </div>
                    <button class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg transition duration-150">
                        Visualizza Date
                    </button>
                `;
                card.addEventListener('click', () => handleCourseSelect(course.id));
                coursesContainer.appendChild(card);
            });
        }

        /**
         * Gestisce la selezione di un corso e mostra la vista delle date.
         * @param {string} courseId L'ID del corso selezionato.
         */
        function handleCourseSelect(courseId) {
            currentCourseId = courseId;
            const course = COURSES.find(c => c.id === courseId);
            
            document.getElementById('selected-course-title').textContent = `Date Disponibili per: ${course.name}`;
            courseSelectionView.classList.add('hidden');
            dateSelectionView.classList.remove('hidden');
            
            renderDates(courseId);
        }

        /**
         * Renderizza le schede delle date disponibili per il corso selezionato.
         * @param {string} courseId L'ID del corso.
         */
        function renderDates(courseId) {
            const datesContainer = document.getElementById('dates-container');
            datesContainer.innerHTML = '';
            
            const course = COURSES.find(c => c.id === courseId);
            if (!course) return;

            course.dates.forEach(dateString => {
                const key = `${courseId}|${dateString}`;
                const slot = currentAvailability[key];
                
                if (!slot) {
                    console.warn(`Disponibilit√† non trovata per la chiave: ${key}`);
                    return;
                }

                const { date, day, time } = parseDateString(dateString);
                const availableSlots = slot.maxSlots - slot.booked;
                const isFull = availableSlots <= 0;
                
                const card = document.createElement('div');
                card.className = `date-card p-4 rounded-xl shadow-md border ${isFull ? 'bg-gray-200 border-gray-300 cursor-not-allowed' : 'bg-white border-indigo-200 hover:border-indigo-500'}`;
                card.setAttribute('data-date-string', dateString);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium ${isFull ? 'text-gray-500' : 'text-indigo-600'}">${day}</span>
                        ${isFull ? `<span class="px-2 py-1 text-xs font-bold rounded-full bg-red-500 text-white">ESAURITO</span>` : `<span class="px-2 py-1 text-xs font-bold rounded-full bg-green-100 text-green-700">${availableSlots} posti</span>`}
                    </div>
                    <p class="text-2xl font-extrabold ${isFull ? 'text-gray-500' : 'text-gray-800'} mt-1">${date}</p>
                    <p class="text-lg font-semibold ${isFull ? 'text-gray-500' : 'text-gray-700'}">${time}</p>
                    <button class="mt-3 w-full text-sm font-semibold py-2 rounded-lg transition duration-150 ${isFull ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600 text-white'}" ${isFull ? 'disabled' : ''}>
                        ${isFull ? 'Completo' : 'Prenota Ora'}
                    </button>
                `;
                
                if (!isFull) {
                    card.addEventListener('click', () => openBookingModal(course, dateString));
                }
                
                datesContainer.appendChild(card);
            });
        }

        /**
         * Apre il modale di prenotazione e pre-popola i dati.
         * @param {object} course Il corso selezionato.
         * @param {string} dateString La stringa data/ora selezionata.
         */
        function openBookingModal(course, dateString) {
            const { date, day, time } = parseDateString(dateString);
            
            document.getElementById('modal-course-name').textContent = course.name;
            document.getElementById('modal-date').textContent = `${day}, ${date} dalle ${time}`;
            
            document.getElementById('booking-course-id').value = course.id;
            document.getElementById('booking-date').value = dateString;
            
            bookingModal.classList.remove('hidden');
        }

        /**
         * Gestisce la logica di prenotazione (Form Submit).
         * @param {Event} e L'evento di submit.
         */
        async function handleBookingFormSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('confirm-booking-btn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div> Prenotazione...';

            const courseId = document.getElementById('booking-course-id').value;
            const dateString = document.getElementById('booking-date').value;
            const studentName = document.getElementById('student-name').value.trim();
            const studentSchool = document.getElementById('student-school').value.trim();
            const studentEmail = document.getElementById('student-email').value.trim();
            const studentPhone = document.getElementById('student-phone').value.trim();
            const bookingCode = generateBookingCode();
            
            const course = COURSES.find(c => c.id === courseId);
            const dateDetails = parseDateString(dateString);
            const slotKey = `${courseId}|${dateString}`;

            if (!course) {
                showMessage("Errore: Corso non trovato.", 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                return;
            }

            try {
                // Esecuzione Transazione Atomica (importante per non overbook)
                const newBooking = await runTransaction(db, async (transaction) => {
                    // 1. Rileggi i dati di disponibilit√† per la validazione nella transazione
                    const currentSlot = currentAvailability[slotKey];
                    if (!currentSlot || currentSlot.booked >= currentSlot.maxSlots) {
                        throw new Error("Posti esauriti! Riprova con un'altra data.");
                    }
                    
                    // 2. Controllo duplicato sulla stessa data
                    // Nota: non si pu√≤ usare `getDocs` o query `where` con `transaction.get`, quindi simuliamo il controllo
                    // basandoci sul fatto che onSnapshot ha gi√† caricato i dati aggiornati
                    const isDuplicate = currentBookings.some(b => 
                        b.studentName.toUpperCase() === studentName.toUpperCase() && 
                        b.dateString === dateString
                    );
                    
                    if (isDuplicate) {
                         throw new Error(`Risulta gi√† una prenotazione attiva con il nome ${studentName} per questa data/orario.`);
                    }

                    // 3. Creare la nuova prenotazione
                    const bookingData = {
                        code: bookingCode,
                        courseId: courseId,
                        courseName: course.name,
                        dateString: dateString,
                        date: dateDetails.date,
                        time: dateDetails.time,
                        studentName: studentName,
                        studentSchool: studentSchool,
                        studentEmail: studentEmail,
                        studentPhone: studentPhone,
                        bookedAt: serverTimestamp(),
                    };
                    
                    // Aggiungi il nuovo documento di prenotazione
                    transaction.set(doc(getBookingsCollection()), bookingData);
                    
                    return bookingData;
                });

                // Dopo la transazione riuscita:
                bookingModal.classList.add('hidden');
                bookingForm.reset();
                
                // Simula i dati per il PDF (il timestamp deve essere simulato/stimato)
                const bookingDataForPdf = {
                    ...newBooking,
                    bookedAt: { toDate: () => new Date() }, // Simula il timestamp per la generazione PDF immediata
                };
                
                generatePDF(bookingDataForPdf);
                showMessage("Prenotazione completata! Il PDF di conferma √® stato scaricato.", 'success');
                
            } catch (error) {
                console.error("Errore durante la prenotazione:", error);
                if (error.message.includes("esauriti")) {
                    showMessage(error.message, 'warning');
                } else if (error.message.includes("duplicata") || error.message.includes("nome")) {
                    showMessage("Prenotazione duplicata rilevata: " + error.message.split(':').pop(), 'warning');
                } else {
                    showMessage("Errore imprevisto durante la prenotazione. Riprova. " + (error.code || ''), 'error');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        }

        /**
         * Gestisce la logica di annullamento (Form Submit).
         * @param {Event} e L'evento di submit.
         */
        async function handleCancellationFormSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('confirm-cancellation-btn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div> Annullamento...';
            
            const code = document.getElementById('cancellation-code').value.trim().toUpperCase();
            const reason = document.getElementById('cancellation-reason').value.trim();

            try {
                let bookingData = null;
                
                // 1. Cerca la prenotazione tramite il codice
                const q = query(getBookingsCollection(), where('code', '==', code));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    throw new Error("Codice di prenotazione non valido o gi√† annullato.");
                }

                const docSnapshot = snapshot.docs[0];
                const bookingDocId = docSnapshot.id;
                bookingData = docSnapshot.data();
                
                // 2. Esegui l'annullamento in transazione (cancellazione e log)
                await runTransaction(db, async (transaction) => {
                    const bookingRef = doc(getBookingsCollection(), bookingDocId);

                    // Aggiungi il log di annullamento
                    const cancellationLog = {
                        ...bookingData, // Copia tutti i dati della prenotazione
                        originalBookingId: bookingDocId,
                        cancelledAt: serverTimestamp(),
                        cancellationReason: reason || 'Non specificata',
                        status: 'ANNULLED'
                    };
                    
                    // Aggiungi alla collezione annullamenti
                    transaction.set(doc(getCancellationsCollection()), cancellationLog);
                    
                    // Elimina la prenotazione attiva
                    transaction.delete(bookingRef);
                });

                cancellationModal.classList.add('hidden');
                cancellationForm.reset();
                showMessage(`Prenotazione con codice ${code} annullata con successo. Il posto √® stato liberato.`, 'success');

            } catch (error) {
                console.error("Errore durante l'annullamento:", error);
                showMessage(error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        }

        // =========================================================================
        // üë®‚Äçüè´ VISTA DOCENTE - RENDERING E INTERAZIONE
        // =========================================================================

        /**
         * Simula il login del docente.
         * @param {Event} e L'evento di submit.
         */
        async function docenteLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('docente-username').value.trim();
            const password = document.getElementById('docente-password').value.trim();
            
            if (username === DOCENTE_USERNAME && password === DOCENTE_PASSWORD) {
                isDocente = true;
                docenteLoginModal.classList.add('hidden');
                studentMainView.classList.add('hidden');
                docenteView.classList.remove('hidden');
                // Aggiorna bottone in alto a destra
                document.getElementById('open-docente-login-btn').textContent = 'Dashboard';
                document.getElementById('open-docente-login-btn').classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-800');
                document.getElementById('open-docente-login-btn').classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'text-white');
                
                // Ricarica la dashboard
                renderDocenteDashboard();
                showMessage('Accesso Docente effettuato con successo.', 'success');
            } else {
                showMessage('Credenziali non valide. Riprova.', 'error');
            }
        }

        /**
         * Gestisce il logout del docente.
         */
        function docenteLogout() {
            isDocente = false;
            docenteView.classList.add('hidden');
            studentMainView.classList.remove('hidden');
            // Aggiorna bottone in alto a destra
            document.getElementById('open-docente-login-btn').textContent = 'Accesso Docente';
            document.getElementById('open-docente-login-btn').classList.remove('bg-indigo-500', 'hover:bg-indigo-600', 'text-white');
            document.getElementById('open-docente-login-btn').classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-800');
            docenteLoginForm.reset();
            showMessage('Logout effettuato.', 'info');
            // Ritorna alla vista iniziale
            handleCourseSelect(currentCourseId || COURSES[0].id); // Mantiene il contesto se possibile
        }

        /**
         * Renderizza la dashboard Docente con tutti i dati.
         */
        function renderDocenteDashboard() {
            if (!isDocente) return;
            
            // Assicura che la tab attiva sia renderizzata
            const activeTabId = document.querySelector('.tab-active')?.id;
            if (activeTabId === 'tab-cancellations') {
                renderCancellationsLog();
            } else {
                renderBookingsTable();
            }
        }

        /**
         * Renderizza la tabella delle prenotazioni attive con filtri.
         */
        function renderBookingsTable() {
            const tableBody = document.getElementById('bookings-table-body');
            const noBookingsMessage = document.getElementById('no-bookings-message');
            const filterValue = dateFilter.value;
            
            // 1. Popola il filtro data
            const uniqueDates = Array.from(new Set(currentBookings.map(b => b.dateString)));
            dateFilter.innerHTML = '<option value="all">Tutte le Date</option>';
            uniqueDates.sort().forEach(dateString => {
                const { date, day, time } = parseDateString(dateString);
                const option = document.createElement('option');
                option.value = dateString;
                option.textContent = `${day}, ${date} (${time})`;
                dateFilter.appendChild(option);
            });
            dateFilter.value = filterValue; // Mantiene il filtro selezionato

            // 2. Filtra i dati
            let filteredBookings = currentBookings;
            if (filterValue !== 'all') {
                filteredBookings = currentBookings.filter(b => b.dateString === filterValue);
            }
            
            // Ordina per data/ora e poi per nome
            filteredBookings.sort((a, b) => {
                const dateA = a.dateString;
                const dateB = b.dateString;
                if (dateA < dateB) return -1;
                if (dateA > dateB) return 1;
                return a.studentName.localeCompare(b.studentName);
            });

            // 3. Renderizza la tabella
            tableBody.innerHTML = '';
            
            if (filteredBookings.length === 0) {
                noBookingsMessage.classList.remove('hidden');
                return;
            }
            noBookingsMessage.classList.add('hidden');

            filteredBookings.forEach(booking => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50';
                
                row.insertCell().textContent = booking.code;
                row.insertCell().textContent = booking.studentName;
                row.insertCell().textContent = booking.courseName;
                row.insertCell().textContent = booking.date;
                row.insertCell().textContent = booking.time;
                row.insertCell().textContent = booking.studentSchool;
                row.insertCell().innerHTML = `<span class="block text-sm font-semibold">${booking.studentEmail}</span><span class="block text-xs text-gray-500">${booking.studentPhone}</span>`;
                row.insertCell().textContent = formatTimestamp(booking.bookedAt);
            });
        }

        /**
         * Renderizza il log degli annullamenti.
         */
        function renderCancellationsLog() {
            const tableBody = document.getElementById('cancellations-table-body');
            const noCancellationsMessage = document.getElementById('no-cancellations-message');

            // Ordina per data di annullamento decrescente
            currentCancellations.sort((a, b) => {
                if (!a.cancelledAt || !b.cancelledAt) return 0;
                return b.cancelledAt.toDate() - a.cancelledAt.toDate();
            });

            tableBody.innerHTML = '';

            if (currentCancellations.length === 0) {
                noCancellationsMessage.classList.remove('hidden');
                return;
            }
            noCancellationsMessage.classList.add('hidden');

            currentCancellations.forEach(cancellation => {
                const row = tableBody.insertRow();
                row.className = 'text-sm bg-red-50 hover:bg-red-100';
                
                row.insertCell().textContent = cancellation.code;
                row.insertCell().textContent = cancellation.studentName;
                row.insertCell().textContent = cancellation.courseName;
                row.insertCell().textContent = `${cancellation.date} (${cancellation.time})`;
                row.insertCell().textContent = formatTimestamp(cancellation.cancelledAt);
                row.insertCell().textContent = cancellation.cancellationReason.substring(0, 50) + (cancellation.cancellationReason.length > 50 ? '...' : '');
            });
        }

        /**
         * Esporta i dati attivi filtrati in formato CSV.
         */
        function exportToCSV() {
            const filterValue = dateFilter.value;
            let dataToExport = currentBookings;

            if (filterValue !== 'all') {
                dataToExport = currentBookings.filter(b => b.dateString === filterValue);
            }
            
            if (dataToExport.length === 0) {
                showMessage("Nessun dato da esportare per il filtro selezionato.", 'warning');
                return;
            }
            
            // Headers del CSV
            const headers = [
                "Codice Prenotazione", "Nome Studente", "Scuola Media", "Corso ID", "Corso Nome",
                "Data Stage (GG/MM/AAAA)", "Orario Stage", "Email", "Cellulare", "Iscritto il"
            ];
            
            // Mappa i dati
            const csvRows = dataToExport.map(booking => [
                booking.code,
                booking.studentName,
                booking.studentSchool,
                booking.courseId,
                booking.courseName,
                booking.date,
                booking.time,
                booking.studentEmail,
                booking.studentPhone,
                formatTimestamp(booking.bookedAt)
            ].map(item => `"${(item || '').toString().replace(/"/g, '""')}"`).join(';')); // Usa ; come separatore
            
            // Combina intestazioni e righe
            const csvContent = [headers.join(';'), ...csvRows].join('\n');
            
            // Crea il blob e scarica il file
            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' }); // Aggiunge BOM per Excel
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = filterValue === 'all' ? 'ITSCG_Prenotazioni_Tutte.csv' : `ITSCG_Prenotazioni_${filterValue.replace(/\|/g, '_')}.csv`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage(`Esportazione di ${dataToExport.length} righe completata.`, 'success');
        }

        /**
         * Gestisce l'eliminazione completa di tutte le collezioni (Prenotazioni e Annullamenti).
         * @param {Event} e L'evento di submit.
         */
        async function handleDeleteAllData(e) {
            e.preventDefault();
            
            const passwordInput = document.getElementById('docente-delete-password');
            const password = passwordInput.value.trim();
            
            if (password !== DOCENTE_PASSWORD) {
                showMessage("Password docente errata.", 'error');
                passwordInput.value = '';
                return;
            }
            
            const submitBtn = document.getElementById('confirm-delete-btn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div> Eliminazione... ATTENDERE';

            const collectionsToDelete = [
                getBookingsCollection(), 
                getCancellationsCollection()
            ];
            let totalDeleted = 0;

            try {
                for (const colRef of collectionsToDelete) {
                    // Esegui query per ottenere tutti i documenti
                    const snapshot = await getDocs(colRef);
                    
                    // Crea un batch per eliminare tutti i documenti
                    if (!snapshot.empty) {
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        totalDeleted += snapshot.docs.length;
                    }
                }
                
                deleteDataModal.classList.add('hidden');
                docenteDeleteForm.reset();
                
                showMessage(`Eliminazione completa riuscita! Rimossi ${totalDeleted} documenti da tutte le collezioni.`, 'success');
                // onSnapshot aggiorner√† la dashboard automaticamente
            } catch (error) {
                console.error("Errore durante l'eliminazione completa:", error);
                showMessage("Errore fatale durante l'eliminazione dei dati.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        }

        // =========================================================================
        // üöÄ INIZIALIZZAZIONE GLOBALE
        // =========================================================================

        /**
         * Inizializza l'applicazione: Firebase e Autenticazione.
         */
        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                loadingStatus.textContent = "Autenticazione...";

                // Mantieni la sessione docente (se loggato)
                await setPersistence(auth, browserSessionPersistence);

                // Autenticazione (anonima per studenti, o con token se fornito)
                if (canvasAuthToken) {
                    await signInWithCustomToken(auth, canvasAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loadingStatus.textContent = "Caricamento dati di disponibilit√†...";
                        
                        // Avvia i listener in tempo reale
                        startBookingsListener();
                        startCancellationsListener();
                        
                        // Se c'√® una sessione docente simulata (tramite variabile locale), mostra la dashboard
                        if (isDocente) {
                            loadingSpinner.classList.add('hidden');
                            docenteView.classList.remove('hidden');
                            document.getElementById('open-docente-login-btn').textContent = 'Dashboard';
                            document.getElementById('open-docente-login-btn').classList.remove('bg-gray-100', 'hover:bg-gray-200');
                            document.getElementById('open-docente-login-btn').classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'text-white');
                        }
                        
                    } else {
                        console.log("Utente disconnesso/anonimo.");
                        loadingStatus.textContent = "In attesa di autenticazione...";
                    }
                });
                
            } catch (error) {
                console.error("Errore fatale nell'inizializzazione di Firebase:", error);
                loadingStatus.textContent = `Errore critico: ${error.code || error.message}`;
                showMessage("Impossibile connettersi al servizio di prenotazione.", 'error');
            }
        }

        // =========================================================================
        // üîå GESTIONE EVENTI DOM
        // =========================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initApp();

            // Eventi Studente
            document.getElementById('back-to-courses-btn').addEventListener('click', () => {
                dateSelectionView.classList.add('hidden');
                courseSelectionView.classList.remove('hidden');
                currentCourseId = null;
                renderCourses(); // Per aggiornare il conteggio dei posti totali
            });

            document.getElementById('open-cancellation-modal-btn').addEventListener('click', () => {
                cancellationModal.classList.remove('hidden');
            });
            
            document.getElementById('close-cancellation-modal-btn').addEventListener('click', () => {
                cancellationModal.classList.add('hidden');
                cancellationForm.reset();
            });

            document.getElementById('close-modal-btn').addEventListener('click', () => {
                bookingModal.classList.add('hidden');
                bookingForm.reset();
            });

            bookingForm.addEventListener('submit', handleBookingFormSubmit);
            cancellationForm.addEventListener('submit', handleCancellationFormSubmit);

            // Eventi Docente
            document.getElementById('open-docente-login-btn').addEventListener('click', () => {
                if (isDocente) {
                    // Se gi√† loggato, apre direttamente la dashboard
                    studentMainView.classList.add('hidden');
                    docenteView.classList.remove('hidden');
                    renderDocenteDashboard();
                } else {
                    // Altrimenti, apre il modale di login
                    docenteLoginModal.classList.remove('hidden');
                }
            });

            docenteLoginForm.addEventListener('submit', docenteLogin);
            document.getElementById('logout-docente-btn').addEventListener('click', docenteLogout);
            
            // Tabs Docente
            document.getElementById('tab-bookings').addEventListener('click', () => {
                document.querySelector('.tab-active')?.classList.remove('tab-active');
                document.getElementById('tab-bookings').classList.add('tab-active');
                document.getElementById('content-cancellations').classList.add('hidden');
                document.getElementById('content-bookings').classList.remove('hidden');
                renderBookingsTable(); // Ricarica in caso di filtri
            });

            document.getElementById('tab-cancellations').addEventListener('click', () => {
                document.querySelector('.tab-active')?.classList.remove('tab-active');
                document.getElementById('tab-cancellations').classList.add('tab-active');
                document.getElementById('content-bookings').classList.add('hidden');
                document.getElementById('content-cancellations').classList.remove('hidden');
                renderCancellationsLog();
            });
            
            // Filtro e Export Docente
            dateFilter.addEventListener('change', renderBookingsTable);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            
            // Eliminazione Dati Docente
            document.getElementById('open-delete-modal-btn').addEventListener('click', () => {
                deleteDataModal.classList.remove('hidden');
            });
            document.getElementById('close-delete-modal-btn').addEventListener('click', () => {
                deleteDataModal.classList.add('hidden');
                docenteDeleteForm.reset();
            });
            docenteDeleteForm.addEventListener('submit', handleDeleteAllData);
        });
    </script>
