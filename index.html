<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Ministage | ITSCG Primo Levi Seregno</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter per un look moderno -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Icone Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Libreria per il Grafico a Torta -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Libreria per la generazione di PDF (Ricevuta) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Stili Personalizzati e Animazione di Sfondo -->
    <style>
        :root {
            --color-primary: #1D4ED8; /* Blu Scuro ITSCG */
            --color-secondary: #FBBF24; /* Giallo Acceso */
            --color-accent: #EC4899; /* Rosa/Magenta */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Sfondo Scuro */
            color: #E2E8F0;
        }
        /* Stile per l'animazione di sfondo a particelle */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%);
        }
        .card {
            background-color: rgba(30, 41, 59, 0.9); /* Sfondo semi-trasparente per il contenuto */
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background-color: var(--color-primary);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1E40AF;
            transform: scale(1.02);
        }
        .input-style {
            background-color: #334155;
            border: 1px solid #475569;
            color: white;
        }
        .table-header {
            background-color: var(--color-secondary);
            color: #1F2937;
        }
        /* Animazione per i titoli */
        .title-animate {
            background: linear-gradient(90deg, var(--color-accent), var(--color-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Custom scrollbar per un look più pulito */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Animazione di Sfondo a Particelle (Simulazione creativa) -->
    <div id="particles-js"></div>
    <script>
        // Funzione per creare un semplice effetto di "stelle cadenti" o particelle luminose
        // Non uso una libreria esterna come particles.js per aderire alle best practice di un singolo file,
        // ma simulo l'effetto con CSS e JS semplici.
        function createParticle(container) {
            const particle = document.createElement('div');
            particle.className = 'absolute w-1 h-1 rounded-full bg-white opacity-0 animate-pulse';
            
            const size = Math.random() * 2 + 1;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            
            const x = Math.random() * container.offsetWidth;
            const y = Math.random() * container.offsetHeight;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;

            const duration = Math.random() * 5 + 5; // 5-10s
            const delay = Math.random() * 5; // 0-5s delay
            
            particle.style.animation = `fade-in-out ${duration}s infinite ease-in-out alternate ${delay}s`;

            container.appendChild(particle);
        }

        function initParticles() {
            const container = document.getElementById('particles-js');
            if (!container) return;
            const numParticles = 100;
            for (let i = 0; i < numParticles; i++) {
                createParticle(container);
            }
        }

        // Aggiungi l'animazione CSS
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `@keyframes fade-in-out {
            0%, 100% { opacity: 0.1; transform: translateY(0); }
            50% { opacity: 0.8; transform: translateY(100vh) rotate(360deg); }
        }`;
        document.head.appendChild(styleSheet);
        
        window.onload = () => {
             // Inizializza le particelle solo dopo che la finestra è caricata
            initParticles();
            // Inizializza Firebase e l'autenticazione
            initializeAppAndAuth();
        };
    </script>
    
    <!-- Contenitore Principale con Padding -->
    <main class="relative z-10 p-4 md:p-8 lg:p-12">

        <!-- Header e Home Page Dettagliata -->
        <header class="text-center py-16 mb-12 rounded-xl card">
            <div class="flex flex-col items-center">
                <!-- Spazio per Logo e Nome Scuola -->
                <div class="mb-4">
                    <!-- Sostituire con l'URL del Logo Reale -->
                    <img src="https://placehold.co/100x100/1D4ED8/FFFFFF?text=Logo" alt="Logo ITSCG Primo Levi" class="h-20 w-20 rounded-full mx-auto shadow-xl animate-spin-slow">
                </div>
                <h1 class="text-5xl md:text-6xl font-extrabold mb-2 title-animate">
                    Ready For Stage!
                </h1>
                <p class="text-xl text-gray-400 mb-8">
                    ITSCG Primo Levi di Seregno | La tua scelta, il tuo futuro.
                </p>
            </div>
            
            <!-- Testo Bozza e Caratteristiche Scuola -->
            <div class="max-w-4xl mx-auto text-left space-y-6">
                <h2 class="text-3xl font-bold text-white mb-4">I Ministage di Orientamento: Vivi la Scuola!</h2>
                <p class="text-gray-300 leading-relaxed border-l-4 border-color-secondary pl-4">
                    Per supportare al meglio l'importante scelta della scuola superiore, il nostro Istituto ITSCG Primo Levi, situato in **Via Briantina 68 a Seregno**, organizza dei **Ministage di Orientamento**. Questi ti permetteranno di vivere un'esperienza diretta all'interno delle nostre aule, immerso nel metodo didattico che ci contraddistingue.
                </p>
                <div class="grid md:grid-cols-3 gap-6 pt-4">
                    <div class="p-4 rounded-lg bg-indigo-900/50 shadow-lg flex items-start space-x-3">
                        <i data-lucide="compass" class="h-6 w-6 text-color-secondary flex-shrink-0"></i>
                        <div>
                            <h3 class="font-semibold text-lg text-white">Obiettivo: Consapevolezza</h3>
                            <p class="text-sm text-gray-300">Sciogli i dubbi e valuta l'ambiente scolastico prima di fare la tua scelta definitiva. Sperimenta materie e approcci didattici.</p>
                        </div>
                    </div>
                    <div class="p-4 rounded-lg bg-indigo-900/50 shadow-lg flex items-start space-x-3">
                        <i data-lucide="clock3" class="h-6 w-6 text-color-secondary flex-shrink-0"></i>
                        <div>
                            <h3 class="font-semibold text-lg text-white">Durata: Due Ore Immersive</h3>
                            <p class="text-sm text-gray-300">Ogni esperienza dura circa due ore, permettendoti di assistere a due lezioni curricolari in una classe reale.</p>
                        </div>
                    </div>
                    <div class="p-4 rounded-lg bg-indigo-900/50 shadow-lg flex items-start space-x-3">
                        <i data-lucide="user-check" class="h-6 w-6 text-color-secondary flex-shrink-0"></i>
                        <div>
                            <h3 class="font-semibold text-lg text-white">Tutoraggio Garantito</h3>
                            <p class="text-sm text-gray-300">Sarai sempre accompagnato da un docente o uno studente tutor pronto a rispondere a ogni tua domanda.</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Indicatore Connessione DB -->
        <div id="db-status-container" class="fixed top-4 right-4 z-50 p-3 rounded-full shadow-lg flex items-center space-x-2 transition-all duration-300 bg-red-900/50">
            <div id="db-status-dot" class="w-3 h-3 rounded-full bg-red-500 animate-ping"></div>
            <span id="db-status-text" class="text-sm font-medium text-white">Connessione DB in corso...</span>
        </div>
        
        <!-- SEZIONE PRENOTAZIONI (CENTRALE) -->
        <section id="booking-section" class="py-12">
            <h2 class="text-4xl font-bold text-center mb-10 title-animate">
                Prenota il tuo Ministage (Max 4 Posti per Data)
            </h2>

            <div id="addresses-container" class="space-y-16">
                <!-- Le tabelle degli indirizzi verranno iniettate qui dal JavaScript -->
                <div class="text-center p-8 text-xl text-gray-400" id="loading-message">
                    Caricamento indirizzi e disponibilità...
                </div>
            </div>
        </section>
        
        <hr class="border-t border-gray-700 my-16">

        <!-- SEZIONE CALENDARIO E FEEDBACK -->
        <section id="utility-section" class="grid lg:grid-cols-2 gap-12 py-12">
            
            <!-- Calendario Semplificato -->
            <div class="card p-6 rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold title-animate mb-6 flex items-center">
                    <i data-lucide="calendar" class="mr-3 h-7 w-7 text-color-accent"></i> Calendario Scolastico (Orientamento)
                </h2>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 rounded-lg bg-indigo-900/50 text-white font-semibold">Novembre</div>
                    <div class="p-3 rounded-lg bg-color-primary/80 text-white font-semibold transform scale-105">Dicembre</div>
                    <div class="p-3 rounded-lg bg-indigo-900/50 text-white font-semibold">Gennaio</div>
                </div>
                <p class="mt-4 text-sm text-gray-400">Le date dei Ministage si concentrano in questi mesi, come indicato nelle tabelle di prenotazione.</p>
            </div>

            <!-- Modulo Feedback Costruttivo -->
            <div class="card p-6 rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold title-animate mb-6 flex items-center">
                    <i data-lucide="send" class="mr-3 h-7 w-7 text-color-accent"></i> Inviaci un Feedback Costruttivo
                </h2>
                <form id="feedback-form" class="space-y-4">
                    <div>
                        <label for="fb-name" class="block text-sm font-medium text-gray-300">Nome e Cognome</label>
                        <input type="text" id="fb-name" name="name" required class="input-style mt-1 block w-full rounded-md p-3">
                    </div>
                    <div>
                        <label for="fb-indirizzo" class="block text-sm font-medium text-gray-300">Indirizzo di Studio (Opzionale)</label>
                        <select id="fb-indirizzo" name="indirizzo" class="input-style mt-1 block w-full rounded-md p-3">
                            <option value="">Seleziona Indirizzo</option>
                            <!-- Opzioni generate da JS -->
                        </select>
                    </div>
                    <div>
                        <label for="fb-message" class="block text-sm font-medium text-gray-300">Messaggio (Suggerimenti e Critiche)</label>
                        <textarea id="fb-message" name="message" rows="4" required class="input-style mt-1 block w-full rounded-md p-3"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn-primary flex items-center py-3 px-6 rounded-lg text-white font-semibold hover:bg-indigo-700 transition">
                            Invia Feedback <i data-lucide="mail-check" class="ml-2 h-5 w-5"></i>
                        </button>
                    </div>
                    <p id="feedback-message" class="text-center pt-2 font-medium"></p>
                </form>
            </div>
        </section>

        <hr class="border-t border-gray-700 my-16">

        <!-- SEZIONE GRAFICO STATISTICHE (Accessibile a tutti) -->
        <section class="py-12">
            <h2 class="text-4xl font-bold text-center mb-10 title-animate">
                Statistiche Aggiornate in Tempo Reale
            </h2>
            <div class="flex justify-center">
                <div class="card p-6 rounded-xl shadow-2xl w-full md:w-3/5 lg:w-2/5">
                    <h3 class="text-xl font-semibold text-white mb-4">Prenotazioni per Indirizzo</h3>
                    <div class="relative h-96">
                        <canvas id="stagePieChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SEZIONE ADMIN (Pulsante di Accesso) -->
        <section class="text-center py-12">
            <button id="admin-login-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform hover:scale-105">
                Area Admin (Accesso Riservato)
            </button>
        </section>

    </main>
    
    <!-- FOOTER -->
    <footer class="relative z-10 bg-gray-900/70 py-8 mt-16 border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center text-sm text-gray-400">
            <p>&copy; ITSCG Primo Levi di Seregno - Tutti i diritti riservati.</p>
            <div class="flex space-x-4 mt-4 md:mt-0 items-center">
                <!-- Placeholder Chatbot -->
                <a href="chatbot-placeholder.html" target="_blank" class="text-color-secondary hover:text-white transition font-semibold flex items-center">
                     <i data-lucide="message-square" class="mr-1 h-4 w-4"></i> Chatbot Aiuto
                </a>
                <!-- Link Privacy -->
                <a href="https://www.leviseregno.edu.it/privacy" target="_blank" class="hover:text-white transition">Privacy Policy</a>
            </div>
        </div>
    </footer>

    <!-- MODAL (Generico per Prenotazione/Admin/Messaggi) -->
    <div id="main-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center hidden">
        <div id="modal-content" class="card p-8 rounded-xl w-11/12 md:w-2/3 lg:w-1/3 max-h-full overflow-y-auto transform scale-95 transition-all duration-300">
            <!-- Il contenuto del modal verrà iniettato qui (Form Prenotazione o Admin Panel) -->
        </div>
    </div>
    
    <!-- FIREBASE AND JAVASCRIPT LOGIC -->
    <script type="module">
        // Importa le funzioni Firebase necessarie
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, increment, limit, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Impostazione del livello di log (Debug)
        setLogLevel('debug');

        // Configurazione e Globals
        // NOTE: Usiamo il placeholder firebaseConfig qui, ma la configurazione reale
        // viene presa dalle variabili globali __firebase_config del Canvas.
        const firebaseConfig = {
            apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
            authDomain: "progetto-63fb3.firebaseapp.com",
            projectId: "progetto-63fb3",
            storageBucket: "progetto-63fb3.firebasestorage.app",
            messagingSenderId: "883088850197",
            appId: "1:883088850197:web:29b8573ea43555041b3d1c",
            measurementId: "G-2PNR8PQHDR"
        };
        
        // Variabili Globali
        let app, db, auth;
        let userId = null;
        let isAdmin = false;

        // Variabili globali fornite da Canvas (verranno popolate a runtime)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // USO LE VARIABILI GLOBALI DEL CANVAS PER LA CONFIGURAZIONE
        const initialFirebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : firebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Credenziali Admin (usate per l'interfaccia, la vera auth è gestita da Firebase)
        const ADMIN_EMAIL = "orientamento@leviseregno.edu.it";
        const ADMIN_PASSWORD = "march corv 25@"; 
        
        // Struttura degli Indirizzi aggiornata in base all'immagine dell'utente
        const INDIRIZZI = {
            LSSA: { name: "Liceo Scientifico Scienze Applicate", color: "bg-red-600", desc: "Approfondimento delle materie scientifiche e tecnologiche." },
            CAT: { name: "Costruzioni Ambiente e Territorio", color: "bg-amber-600", desc: "Geometria, Costruzioni, Sostenibilità e topografia." },
            LCQ: { name: "Logistica Corso Quadriennale", color: "bg-green-600", desc: "Gestione dei processi logistici, innovazione e trasporti in soli 4 anni." },
            RIM: { name: "Relazioni Internazionali per il Marketing", color: "bg-blue-600", desc: "Lingue, Marketing, Diritto e commercio globale." },
            SM: { name: "Sistema Moda", color: "bg-purple-600", desc: "Design, produzione e promozione nel settore tessile-abbigliamento." },
            LSCE: { name: "Liceo Scientifico con Curvatura Economica", color: "bg-pink-600", desc: "Scienze Applicate integrate con l'economia aziendale (NOVITÀ)." },
        };
        
        // Date di Ministage (Date Fittizie per Inizializzazione - 5 date)
        const DATES = [
            { date: "15 Novembre 2025", time: "09:00 - 11:00", id: "d1" },
            { date: "29 Novembre 2025", time: "14:30 - 16:30", id: "d2" },
            { date: "13 Dicembre 2025", time: "09:00 - 11:00", id: "d3" },
            { date: "10 Gennaio 2026", time: "14:30 - 16:30", id: "d4" },
            { date: "24 Gennaio 2026", time: "09:00 - 11:00", id: "d5" },
        ];
        
        // Posti massimi per data (Richiesto: 4)
        const MAX_SPOTS_PER_DATE = 4;


        // --- FUNZIONI DI BASE E UTILITY ---
        
        /** Gestisce l'interfaccia utente del modale. */
        function toggleModal(show, contentHTML = '') {
            const modal = document.getElementById('main-modal');
            const modalContent = document.getElementById('modal-content');
            if (show) {
                modalContent.innerHTML = contentHTML;
                modal.classList.remove('hidden');
                setTimeout(() => modalContent.classList.add('scale-100', 'opacity-100'), 10);
                modalContent.classList.remove('scale-95', 'opacity-0');
            } else {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modalContent.innerHTML = '';
                }, 300);
            }
        }

        /** Funzione di utility per ritardi con exponential backoff */
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        /** Aggiorna lo stato visivo della connessione DB. */
        function updateDbStatus(isConnected) {
            const dot = document.getElementById('db-status-dot');
            const text = document.getElementById('db-status-text');
            const container = document.getElementById('db-status-container');
            
            if (isConnected) {
                dot.classList.remove('bg-red-500', 'animate-ping');
                dot.classList.add('bg-green-500');
                text.textContent = isAdmin ? 'Connesso: ADMIN' : 'Connesso: Studente';
                container.classList.add('bg-green-900/50');
                container.classList.remove('bg-red-900/50');
            } else {
                dot.classList.remove('bg-green-500');
                dot.classList.add('bg-red-500', 'animate-ping');
                text.textContent = 'Connessione DB Fallita';
                container.classList.add('bg-red-900/50');
                container.classList.remove('bg-green-900/50');
            }
        }
        
        // --- FUNZIONI FIREBASE ---

        /** Inizializzazione Firebase e Autenticazione. */
        async function initializeAppAndAuth() {
            try {
                // USARE initialFirebaseConfig CHE È IL CONFIG REALE DAL CANVAS
                app = initializeApp(initialFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Gestione Autenticazione
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAdmin = user.email === ADMIN_EMAIL;
                        updateDbStatus(true);
                        
                        if (isAdmin) {
                             document.getElementById('admin-login-button').textContent = "Area Admin (Esci)";
                             // Se è admin, inizializza i dati degli stage se non esistono
                             await initializeStageData();
                        }
                        // Avvia tutti gli ascoltatori una volta che l'autenticazione è pronta
                        setupListeners();
                    } else {
                        // Tentativo di accesso anonimo se non c'è token personalizzato
                        if (!initialAuthToken) {
                            await signInAnonymously(auth);
                        }
                        // Se l'utente è null dopo il tentantivo, lo stato non è pronto
                        if (auth.currentUser) {
                             userId = auth.currentUser.uid;
                             setupListeners();
                        }
                        updateDbStatus(true);
                    }
                });

                // Autenticazione iniziale con token (se fornito dal canvas)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Errore durante l'inizializzazione di Firebase:", error);
                updateDbStatus(false);
            }
        }
        
        /** Inizializza i dati di stage/date in Firestore se non esistono. (Solo Admin) */
        async function initializeStageData() {
             if (!isAdmin) return;
             
             console.log("Controllo/Inizializzazione dati stage...");
             
             try {
                 for (const [key, indirizzo] of Object.entries(INDIRIZZI)) {
                     const stageRef = doc(db, 'stages', key);
                     const stageSnap = await getDoc(stageRef);
                     
                     if (!stageSnap.exists()) {
                         // Crea il documento stage se non esiste
                         await setDoc(stageRef, {
                             name: indirizzo.name,
                             max_capacity: MAX_SPOTS_PER_DATE
                         });
                         console.log(`Creato stage: ${indirizzo.name}`);
                     }
                     
                     // Controlla le date
                     for (const date of DATES) {
                         // Usa una collection pubblica per le date/disponibilità
                         const dateRef = doc(db, `artifacts/${appId}/public/data/stages/${key}/dates/${date.id}`);
                         const dateSnap = await getDoc(dateRef);
                         
                         if (!dateSnap.exists()) {
                             await setDoc(dateRef, {
                                 date: date.date,
                                 time: date.time,
                                 max_spots: MAX_SPOTS_PER_DATE,
                                 available_spots: MAX_SPOTS_PER_DATE,
                                 bookings_count: 0,
                                 indirizzo: key
                             });
                         }
                     }
                 }
                 console.log("Inizializzazione stage completata.");
             } catch (e) {
                 console.error("Errore nell'inizializzazione dei dati stage:", e);
             }
         }

        /** Ascoltatori in tempo reale (onSnapshot) per aggiornare UI e Grafico. */
        function setupListeners() {
            // Nasconde il messaggio di caricamento
            document.getElementById('loading-message').style.display = 'none';

            // 1. Ascoltatore per le tabelle di prenotazione (COLLECTION PUBBLICA)
            Object.keys(INDIRIZZI).forEach(indirizzoKey => {
                const datesCollectionRef = collection(db, `artifacts/${appId}/public/data/stages/${indirizzoKey}/dates`);
                onSnapshot(datesCollectionRef, (snapshot) => {
                    const datesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Assicurati che tutte le date necessarie siano presenti, anche se non nel DB (fallback)
                    const fullDatesData = DATES.map(d => {
                        const dbData = datesData.find(dd => dd.id === d.id);
                        return dbData || { 
                            ...d, 
                            available_spots: MAX_SPOTS_PER_DATE, 
                            max_spots: MAX_SPOTS_PER_DATE, 
                            bookings_count: 0, 
                            indirizzo: indirizzoKey 
                        };
                    });

                    renderAddressTable(indirizzoKey, fullDatesData);
                    updateChart(indirizzoKey, fullDatesData);
                }, (error) => console.error("Errore onSnapshot dates:", error));
            });
            
            // 2. Ascoltatore per tutti i feedback (Solo Admin)
            const feedbackRef = collection(db, `artifacts/${appId}/public/data/feedback`);
            onSnapshot(feedbackRef, (snapshot) => {
                const feedbackList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Aggiorna l'admin dashboard se è aperto
                if (isAdmin && document.getElementById('admin-modal-title')) {
                    renderAdminFeedback(feedbackList);
                }
            }, (error) => console.error("Errore onSnapshot feedback:", error));

            // 3. Ascoltatore per tutte le prenotazioni (Solo Admin - COLLECTION PRIVATA PER BOOKINGS)
            const bookingsRef = collection(db, `artifacts/${appId}/public/data/bookings`);
            onSnapshot(bookingsRef, (snapshot) => {
                const bookingList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Aggiorna l'admin dashboard se è aperto
                if (isAdmin && document.getElementById('admin-modal-title')) {
                    renderAdminBookings(bookingList);
                }
            }, (error) => console.error("Errore onSnapshot bookings:", error));
        }
        
        // --- FUNZIONI DI RENDERING UI ---

        /** Rendering della tabella di prenotazione per un indirizzo specifico. */
        function renderAddressTable(indirizzoKey, datesData) {
            const indirizzo = INDIRIZZI[indirizzoKey];

            // Ordina le date in base all'array fisso DATES per mantenere l'ordine cronologico/logico
            const sortedDates = DATES.map(d => datesData.find(dd => dd.id === d.id) || d);

            const tableHtml = `
                <div class="card p-6 rounded-xl shadow-2xl ${indirizzo.color.replace('bg-', 'border-').replace('-600', '-500')} border-4">
                    <h3 class="text-3xl font-bold mb-4 flex items-center text-white">
                        <span class="w-2 h-8 ${indirizzo.color} mr-3 rounded"></span>
                        ${indirizzo.name} (${indirizzoKey})
                    </h3>
                    <p class="text-gray-400 mb-6">${indirizzo.desc}</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Orario</th>
                                    <th class="px-6 py-3 text-center text-sm font-semibold uppercase tracking-wider">Disponibilità</th>
                                    <th class="px-6 py-3 text-center text-sm font-semibold uppercase tracking-wider">Azione</th>
                                </tr>
                            </thead>
                            <tbody class="bg-gray-800 divide-y divide-gray-700">
                                ${sortedDates.map(date => {
                                    // Usa i dati aggiornati o i valori di default
                                    const spots = date.available_spots !== undefined ? date.available_spots : MAX_SPOTS_PER_DATE; 
                                    const maxSpots = date.max_spots !== undefined ? date.max_spots : MAX_SPOTS_PER_DATE;
                                    const isAvailable = spots > 0;
                                    const availabilityColor = isAvailable ? (spots <= 1 ? 'text-yellow-400' : 'text-green-400') : 'text-red-500';
                                    const buttonClass = isAvailable 
                                        ? 'bg-color-accent hover:bg-pink-700 transform hover:scale-105' 
                                        : 'bg-gray-500 cursor-not-allowed opacity-70';

                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${date.date}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${date.time}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold ${availabilityColor}">
                                                ${spots} / ${maxSpots}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                                <button 
                                                    class="py-2 px-4 rounded-full text-white font-semibold transition-all ${buttonClass}"
                                                    ${isAvailable ? `onclick="showBookingForm('${indirizzoKey}', '${date.id}', '${date.date} - ${date.time}')"` : 'disabled'}
                                                >
                                                    ${isAvailable ? 'Prenota Ora' : 'Esaurito'}
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('addresses-container');
            let tableWrapper = document.getElementById(`table-${indirizzoKey}`);
            
            if (!tableWrapper) {
                // Crea il contenitore della tabella se non esiste
                tableWrapper = document.createElement('div');
                tableWrapper.id = `table-${indirizzoKey}`;
                container.appendChild(tableWrapper);
            }
            
            tableWrapper.innerHTML = tableHtml;
        }
        
        // --- LOGICA PRENOTAZIONE ---

        /** Mostra il modulo di prenotazione nel modale. */
        window.showBookingForm = (indirizzoKey, dateId, dateLabel) => {
            const indirizzoName = INDIRIZZI[indirizzoKey].name;
            
            const formHtml = `
                <button onclick="toggleModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
                <h2 class="text-3xl font-bold title-animate mb-6 border-b border-gray-700 pb-3">Modulo di Prenotazione</h2>
                <p class="mb-4 text-lg text-white font-medium">Stage: ${indirizzoName}</p>
                <p class="mb-6 text-lg text-color-secondary font-medium">Data/Ora: ${dateLabel}</p>
                <form id="student-booking-form" class="space-y-4">
                    <input type="hidden" name="indirizzoKey" value="${indirizzoKey}">
                    <input type="hidden" name="dateId" value="${dateId}">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-300">Nome</label>
                        <input type="text" id="nome" name="nome" required class="input-style mt-1 block w-full rounded-md p-3">
                    </div>
                    <div>
                        <label for="cognome" class="block text-sm font-medium text-gray-300">Cognome</label>
                        <input type="text" id="cognome" name="cognome" required class="input-style mt-1 block w-full rounded-md p-3">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300">Email (per Ricevuta)</label>
                        <input type="email" id="email" name="email" required class="input-style mt-1 block w-full rounded-md p-3">
                    </div>
                    <div>
                        <label for="scuola" class="block text-sm font-medium text-gray-300">Scuola Media di Provenienza</label>
                        <input type="text" id="scuola" name="scuola" required class="input-style mt-1 block w-full rounded-md p-3">
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="btn-primary flex items-center py-3 px-6 rounded-lg text-white font-semibold transition-all duration-300 transform hover:scale-105">
                            Conferma Prenotazione <i data-lucide="zap" class="ml-2 h-5 w-5"></i>
                        </button>
                    </div>
                    <p id="booking-message" class="text-center pt-2 font-medium"></p>
                </form>
            `;
            toggleModal(true, formHtml);
            lucide.createIcons(); // Ricarica le icone nel modal

            document.getElementById('student-booking-form').addEventListener('submit', handleBookingSubmit);
        }

        /** Gestisce l'invio del modulo di prenotazione. */
        async function handleBookingSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const indirizzoKey = form.elements['indirizzoKey'].value;
            const dateId = form.elements['dateId'].value;
            const nome = form.elements['nome'].value;
            const cognome = form.elements['cognome'].value;
            const email = form.elements['email'].value;
            const scuola = form.elements['scuola'].value;
            const bookingMessage = document.getElementById('booking-message');

            bookingMessage.textContent = 'Elaborazione prenotazione...';
            bookingMessage.classList.remove('text-red-500', 'text-green-500');
            bookingMessage.classList.add('text-color-secondary');

            // Percorso della data (COLLECTION PUBBLICA)
            const dateRef = doc(db, `artifacts/${appId}/public/data/stages/${indirizzoKey}/dates/${dateId}`);
            // Percorso della prenotazione (COLLECTION PUBBLICA)
            const bookingRef = collection(db, `artifacts/${appId}/public/data/bookings`);
            let success = false;
            let transactionBookingId = null;

            // Transazione per decrementare i posti disponibili in modo sicuro
            try {
                await runTransaction(db, async (transaction) => {
                    const dateDoc = await transaction.get(dateRef);
                    if (!dateDoc.exists()) {
                        throw new Error("Data di stage non trovata!");
                    }

                    const newSpots = dateDoc.data().available_spots - 1;
                    if (newSpots < 0) {
                        throw new Error("Posti esauriti. La transazione è fallita.");
                    }

                    // 1. Decrementa i posti disponibili
                    transaction.update(dateRef, { 
                        available_spots: newSpots,
                        bookings_count: increment(1)
                    });
                    
                    // 2. Registra la prenotazione (consegnato come documento separato)
                    const dateInfo = DATES.find(d => d.id === dateId);
                    const newBookingData = {
                        nome,
                        cognome,
                        email,
                        scuola,
                        indirizzoKey,
                        indirizzoName: INDIRIZZI[indirizzoKey].name,
                        dateId,
                        dateLabel: `${dateInfo.date} - ${dateInfo.time}`,
                        timestamp: new Date().toISOString(),
                        userId: auth.currentUser.uid,
                        cancellation_code: crypto.randomUUID().substring(0, 8).toUpperCase()
                    };

                    const newBookingDoc = doc(bookingRef);
                    transactionBookingId = newBookingDoc.id;
                    transaction.set(newBookingDoc, newBookingData);
                    
                    success = true;
                });
            } catch (e) {
                console.error("Errore durante la prenotazione:", e);
                bookingMessage.textContent = e.message.includes('esauriti') 
                    ? "Ci dispiace, i posti sono stati appena esauriti!" 
                    : `Errore di sistema: ${e.message}`;
                bookingMessage.classList.add('text-red-500');
                success = false;
            }

            if (success) {
                bookingMessage.textContent = 'Prenotazione Effettuata con Successo!';
                bookingMessage.classList.remove('text-color-secondary');
                bookingMessage.classList.add('text-green-500');
                
                const dateInfo = DATES.find(d => d.id === dateId);
                
                // Aggiorna il modale con la schermata di successo
                const successContent = `
                    <button onclick="toggleModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                    <div class="text-center p-4">
                        <i data-lucide="check-circle" class="h-16 w-16 mx-auto text-green-500 mb-4 animate-bounce-slow"></i>
                        <h2 class="text-3xl font-bold text-white mb-2">Congratulazioni, ${nome}!</h2>
                        <p class="text-gray-300 mb-6">La tua prenotazione è confermata per il Ministage **${INDIRIZZI[indirizzoKey].name}** in data **${dateInfo.date}**.</p>
                        
                        <div class="bg-gray-700/50 p-4 rounded-lg mb-6 text-left text-sm">
                             <p class="font-semibold text-white">Codice Prenotazione:</p> 
                             <p class="text-color-secondary text-lg">${transactionBookingId}</p>
                             <p class="mt-2 text-gray-400">Conserva questo codice! Serve per riferimenti e future cancellazioni.</p>
                        </div>

                        <button onclick="downloadReceipt('${nome}', '${cognome}', '${INDIRIZZI[indirizzoKey].name}', '${dateInfo.date} - ${dateInfo.time}', '${transactionBookingId}')" class="btn-primary flex items-center justify-center w-full py-3 px-6 rounded-lg text-white font-semibold transition-all duration-300 transform hover:scale-105">
                            <i data-lucide="download" class="mr-2 h-5 w-5"></i> Scarica Ricevuta PDF
                        </button>
                        
                        <p class="mt-4 text-xs text-gray-500">
                            Per la cancellazione, ti preghiamo di contattare la segreteria fornendo il Codice Prenotazione.
                        </p>
                    </div>
                `;
                document.getElementById('modal-content').innerHTML = successContent;
                lucide.createIcons();
            }
        }
        
        /** Genera e scarica la ricevuta PDF. */
        window.downloadReceipt = (nome, cognome, indirizzo, dataOra, bookingId) => {
             // Utilizza window.jsPDF come alias per la libreria
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const docTitle = "Ricevuta Prenotazione Ministage ITSCG Primo Levi";
            const schoolName = "ITSCG Primo Levi di Seregno";
            const schoolAddress = "Via Briantina 68, Seregno (MB)";
            const logoText = "Logo ITSCG"; // Sostituire con un logo se possibile

            // 1. Header (Simulazione Logo)
            doc.setFontSize(22);
            doc.setTextColor('#1D4ED8'); // Colore Primario
            doc.text(logoText, 15, 20); 
            doc.setFontSize(10);
            doc.setTextColor('#334155');
            doc.text(schoolAddress, 15, 25);
            
            doc.setDrawColor('#1D4ED8');
            doc.setLineWidth(1);
            doc.line(15, 30, 195, 30); // Linea separatrice

            // 2. Titolo Ricevuta
            doc.setFontSize(18);
            doc.setTextColor('#0F172A');
            doc.text(docTitle, 105, 45, null, null, 'center');

            // 3. Dettagli Prenotazione
            doc.setFontSize(12);
            doc.setTextColor('#334155');
            let y = 60;
            const detail = (label, value, isHighlight = false) => {
                doc.text(`${label}:`, 20, y);
                doc.setFont(undefined, isHighlight ? 'bold' : 'normal');
                doc.setTextColor(isHighlight ? '#1D4ED8' : '#0F172A');
                doc.text(value, 80, y);
                doc.setFont(undefined, 'normal');
                doc.setTextColor('#334155');
                y += 8;
            };

            detail('Studente', `${nome} ${cognome}`);
            detail('Codice Prenotazione', bookingId, true);
            detail('Indirizzo Scelto', indirizzo);
            detail('Data e Orario', dataOra, true);
            detail('Rilascio', new Date().toLocaleDateString('it-IT'));
            
            doc.setDrawColor('#1D4ED8');
            doc.rect(15, 10, 180, 150); // Bordo del documento

            // 4. Note Importanti
            y += 10;
            doc.setFontSize(14);
            doc.setTextColor('#1D4ED8');
            doc.text("NOTE IMPORTANTI", 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setTextColor('#334155');
            doc.text("Questa ricevuta conferma la registrazione al Ministage.", 20, y);
            y += 5;
            doc.text("Per eventuali modifiche o cancellazioni, si prega di comunicare il Codice Prenotazione alla segreteria.", 20, y);

            doc.save(`Ricevuta_Ministage_${cognome}.pdf`);
        }

        // --- LOGICA FEEDBACK ---
        
        /** Gestisce l'invio del modulo di feedback. */
        document.getElementById('feedback-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const messageEl = document.getElementById('feedback-message');
            messageEl.textContent = 'Invio in corso...';
            messageEl.classList.remove('text-red-500', 'text-green-500');
            messageEl.classList.add('text-color-secondary');

            const feedbackData = {
                name: form.elements['name'].value,
                indirizzo: form.elements['indirizzo'].value || 'Non specificato',
                message: form.elements['message'].value,
                timestamp: new Date().toISOString(),
                user_id: auth.currentUser?.uid || 'anonymous'
            };

            try {
                // Salva il feedback in Firestore (COLLECTION PUBBLICA)
                await addDoc(collection(db, `artifacts/${appId}/public/data/feedback`), feedbackData);
                
                messageEl.textContent = 'Feedback inviato con successo! Ti ringraziamo.';
                messageEl.classList.remove('text-color-secondary');
                messageEl.classList.add('text-green-500');
                form.reset();
            } catch (error) {
                console.error("Errore invio feedback:", error);
                messageEl.textContent = `Errore nell'invio: ${error.message}`;
                messageEl.classList.add('text-red-500');
            }
        });
        
        // Popola le opzioni del select Indirizzo nel form Feedback
        (function populateFeedbackIndirizzi() {
            const select = document.getElementById('fb-indirizzo');
            Object.values(INDIRIZZI).forEach(indirizzo => {
                const option = document.createElement('option');
                option.value = indirizzo.name;
                option.textContent = indirizzo.name;
                select.appendChild(option);
            });
        })();

        // --- LOGICA ADMIN DASHBOARD ---
        
        /** Gestisce il click sul pulsante Admin. */
        document.getElementById('admin-login-button').addEventListener('click', () => {
             if (isAdmin) {
                 auth.signOut();
                 isAdmin = false;
                 document.getElementById('admin-login-button').textContent = "Area Admin (Accesso Riservato)";
                 // Chiudi modale se aperto e riavvia l'anonimo
                 toggleModal(false);
                 signInAnonymously(auth);
                 return;
             }
             
             // Modale di Login
             const loginHtml = `
                 <button onclick="toggleModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                     <i data-lucide="x" class="h-6 w-6"></i>
                 </button>
                 <h2 class="text-3xl font-bold title-animate mb-6 border-b border-gray-700 pb-3">Accesso Area Amministrativa</h2>
                 <p class="mb-4 text-gray-400">Inserisci le credenziali di Orientamento per accedere ai dati riservati.</p>
                 <form id="admin-login-form" class="space-y-4">
                     <div>
                         <label for="admin-email" class="block text-sm font-medium text-gray-300">Email</label>
                         <input type="email" id="admin-email" value="${ADMIN_EMAIL}" required class="input-style mt-1 block w-full rounded-md p-3">
                     </div>
                     <div>
                         <label for="admin-password" class="block text-sm font-medium text-gray-300">Password</label>
                         <input type="password" id="admin-password" value="${ADMIN_PASSWORD}" required class="input-style mt-1 block w-full rounded-md p-3">
                     </div>
                     <div class="pt-4 flex justify-end">
                         <button type="submit" class="bg-red-600 hover:bg-red-700 flex items-center py-3 px-6 rounded-lg text-white font-semibold transition-all duration-300 transform hover:scale-105">
                             Accedi
                         </button>
                     </div>
                     <p id="admin-login-message" class="text-center pt-2 font-medium"></p>
                 </form>
             `;
             toggleModal(true, loginHtml);
             lucide.createIcons();
             document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
        });
        
        /** Gestisce l'accesso Admin (client-side check + Firebase Auth). */
        async function handleAdminLogin(e) {
            e.preventDefault();
            const form = e.target;
            const email = form.elements['admin-email'].value;
            const password = form.elements['admin-password'].value;
            const messageEl = document.getElementById('admin-login-message');
            
            if (password !== ADMIN_PASSWORD) {
                messageEl.textContent = "Password errata. Riprova.";
                messageEl.classList.add('text-red-500');
                return;
            }

            messageEl.textContent = 'Accesso in corso...';
            messageEl.classList.remove('text-red-500', 'text-green-500');
            messageEl.classList.add('text-color-secondary');

            try {
                // Tentativo di accesso Firebase con le credenziali (necessario per rispettare le regole)
                await signInWithEmailAndPassword(auth, email, password);
                
                isAdmin = true;
                updateDbStatus(true);
                document.getElementById('admin-login-button').textContent = "Area Admin (Esci)";
                
                // Chiudi il modale di login e apri la dashboard
                showAdminDashboard();
            } catch (error) {
                console.error("Errore Firebase Admin Login:", error);
                messageEl.textContent = 'Errore di autenticazione Firebase. Controlla la console.';
                messageEl.classList.add('text-red-500');
            }
        }
        
        /** Mostra la Dashboard Admin completa. */
        async function showAdminDashboard() {
            if (!isAdmin) {
                // Non usare alert()!
                console.error("Accesso negato.");
                return;
            }

            const dashboardHtml = `
                <button onclick="toggleModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
                <h2 id="admin-modal-title" class="text-3xl font-bold title-animate mb-6 border-b border-gray-700 pb-3 flex items-center">
                    <i data-lucide="shield" class="mr-3 h-7 w-7 text-red-500"></i> Dashboard Amministrativa
                </h2>
                <div class="space-y-8">
                    <!-- Sezione 1: Statistiche Prenotazioni (Riutilizza il grafico) -->
                    <div class="card p-4 rounded-lg bg-gray-700/50">
                        <h3 class="text-xl font-semibold text-white mb-3">Statistiche Generali Prenotazioni</h3>
                        <p class="text-sm text-gray-300">Il grafico a torta qui sotto mostra la distribuzione in tempo reale delle prenotazioni per indirizzo (come nella pagina principale).</p>
                    </div>

                    <!-- Sezione 2: Tutte le Prenotazioni -->
                    <div class="card p-4 rounded-lg bg-gray-700/50 max-h-96 overflow-y-auto">
                        <h3 class="text-xl font-semibold text-white mb-3 flex items-center">
                            <i data-lucide="list-checks" class="mr-2 h-5 w-5 text-color-secondary"></i> Tutte le Prenotazioni
                        </h3>
                        <div id="admin-bookings-list" class="space-y-3">
                            <p class="text-gray-400">Caricamento in corso...</p>
                        </div>
                    </div>
                    
                    <!-- Sezione 3: Tutti i Feedback -->
                    <div class="card p-4 rounded-lg bg-gray-700/50 max-h-96 overflow-y-auto">
                        <h3 class="text-xl font-semibold text-white mb-3 flex items-center">
                            <i data-lucide="message-square" class="mr-2 h-5 w-5 text-color-accent"></i> Tutti i Feedback Ricevuti
                        </h3>
                        <div id="admin-feedback-list" class="space-y-3">
                            <p class="text-gray-400">Caricamento in corso...</p>
                        </div>
                    </div>
                </div>
            `;
            
            toggleModal(true, dashboardHtml);
            lucide.createIcons();
            
            // Attiva i listener per popolare le liste in tempo reale
            // NOTE: I listener sono già attivi in setupListeners(), ma li riattiviamo qui per sicurezza
            // e per avere il rendering immediato nella dashboard.
            const bookingsRef = collection(db, `artifacts/${appId}/public/data/bookings`);
            const feedbackRef = collection(db, `artifacts/${appId}/public/data/feedback`);
            
            onSnapshot(bookingsRef, (snapshot) => {
                const bookingList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminBookings(bookingList);
            }, (error) => console.error("Errore onSnapshot bookings (Admin):", error));
            
            onSnapshot(feedbackRef, (snapshot) => {
                const feedbackList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminFeedback(feedbackList);
            }, (error) => console.error("Errore onSnapshot feedback (Admin):", error));
        }

        /** Rendering lista prenotazioni Admin. */
        function renderAdminBookings(bookings) {
            const container = document.getElementById('admin-bookings-list');
            if (!container) return; // Non renderizza se la dashboard non è aperta

            if (bookings.length === 0) {
                container.innerHTML = '<p class="text-gray-400">Nessuna prenotazione trovata.</p>';
                return;
            }
            
            container.innerHTML = bookings.map(b => `
                <div class="p-3 border-b border-gray-600 flex justify-between items-center hover:bg-gray-800 rounded-md transition">
                    <div>
                        <p class="font-semibold text-white">${b.nome} ${b.cognome}</p>
                        <p class="text-sm text-color-secondary">${b.indirizzoName} - ${b.dateLabel}</p>
                        <p class="text-xs text-gray-400">Codice: ${b.cancellation_code}</p>
                    </div>
                    <button onclick="handleBookingDeletion('${b.id}', '${b.indirizzoKey}', '${b.dateId}')" class="text-red-400 hover:text-red-500 ml-4 p-2 rounded-full hover:bg-red-900/50 transition" title="Cancella Prenotazione e ripristina Posto">
                        <i data-lucide="trash-2" class="h-5 w-5"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        /** Gestisce la cancellazione di una prenotazione (Admin only). */
        async function handleBookingDeletion(bookingId, indirizzoKey, dateId) {
             // Sostituisci confirm() con un modale personalizzato (non implementato per brevità, ma essenziale)
             if (!window.confirm(`Sei sicuro di voler cancellare la prenotazione ${bookingId}? L'azione ripristinerà un posto disponibile.`)) return;

             // Percorsi delle collection pubbliche
             const bookingRef = doc(db, `artifacts/${appId}/public/data/bookings`, bookingId);
             const dateRef = doc(db, `artifacts/${appId}/public/data/stages/${indirizzoKey}/dates/${dateId}`);
             
             try {
                 await runTransaction(db, async (transaction) => {
                     // 1. Cancella il documento di prenotazione
                     transaction.delete(bookingRef);
                     
                     // 2. Incrementa i posti disponibili
                     transaction.update(dateRef, {
                         available_spots: increment(1),
                         bookings_count: increment(-1)
                     });
                 });
                 console.log("Cancellazione e ripristino posti completato con successo.");
             } catch (e) {
                 console.error("Errore durante la cancellazione:", e);
                 // Sostituisci alert()
                 window.alert("Errore durante la cancellazione della prenotazione: " + e.message);
             }
        }

        /** Rendering lista feedback Admin. */
        function renderAdminFeedback(feedbackList) {
            const container = document.getElementById('admin-feedback-list');
            if (!container) return;

            if (feedbackList.length === 0) {
                container.innerHTML = '<p class="text-gray-400">Nessun feedback ricevuto.</p>';
                return;
            }
            
            container.innerHTML = feedbackList.map(f => `
                <div class="p-3 rounded-lg border border-gray-700 bg-gray-900 hover:bg-gray-800 transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-color-accent">${f.name} (${f.indirizzo})</p>
                            <p class="text-xs text-gray-500">${new Date(f.timestamp).toLocaleDateString('it-IT')}</p>
                        </div>
                        <button onclick="handleFeedbackDeletion('${f.id}')" class="text-red-400 hover:text-red-500 ml-4 p-2 rounded-full hover:bg-red-900/50 transition" title="Elimina Feedback">
                            <i data-lucide="trash-2" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <p class="mt-2 text-gray-300 italic">"${f.message}"</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        /** Gestisce l'eliminazione di un feedback (Admin only). */
        async function handleFeedbackDeletion(feedbackId) {
            // Sostituisci confirm()
            if (!window.confirm(`Sei sicuro di voler eliminare il feedback ${feedbackId}?`)) return;

            const feedbackRef = doc(db, `artifacts/${appId}/public/data/feedback`, feedbackId);
            try {
                await deleteDoc(feedbackRef);
                console.log("Feedback eliminato con successo.");
            } catch (e) {
                console.error("Errore durante l'eliminazione del feedback:", e);
                // Sostituisci alert()
                window.alert("Errore durante l'eliminazione del feedback: " + e.message);
            }
        }

        // --- LOGICA GRAFICO A TORTA ---
        
        let stageChart = null;
        let chartDataMap = {}; // Mappa per aggregare i dati da onSnapshot
        
        /** Aggiorna la mappa dei dati per il grafico. */
        function updateChart(indirizzoKey, datesData) {
            let totalBookings = datesData.reduce((acc, curr) => acc + (curr.bookings_count || 0), 0);
            chartDataMap[indirizzoKey] = totalBookings;
            renderChart();
        }

        /** Rendering o Aggiornamento del grafico a torta. */
        function renderChart() {
            const ctx = document.getElementById('stagePieChart').getContext('2d');
            const labels = Object.keys(INDIRIZZI).map(key => INDIRIZZI[key].name);
            const data = labels.map(name => {
                const key = Object.keys(INDIRIZZI).find(k => INDIRIZZI[k].name === name);
                return chartDataMap[key] || 0;
            });
            
            // Colori vivaci per il grafico
            const colors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#9333EA', '#EC4899'];

            if (stageChart) {
                stageChart.data.datasets[0].data = data;
                stageChart.update();
            } else {
                stageChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#0F172A',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#E2E8F0',
                                    font: { family: 'Inter' }
                                }
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // Attiva le icone Lucide all'inizio
        lucide.createIcons();
        
    </script>
</body>
</html>
