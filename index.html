<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Ministage ITSCG Primo Levi</title>
    <!-- Caricamento Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configurazione Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .cancellation-btn-fixed {
            background-color: #fef2f2; /* red-50 */
            color: #ef4444; /* red-500 */
            border: 1px solid #fecaca; /* red-200 */
        }
        .cancellation-btn-fixed:hover {
            background-color: #fee2e2; /* red-100 */
        }
        .docente-access-btn {
            background-color: #4f46e5; /* indigo-600 */
        }
        .docente-access-btn:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 700;
        }
        /* Stile per il Modale */
        .modal-content {
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Messaggi di sistema/Notifiche (Modificato per essere un div standard) -->
    <div id="message-box" class="fixed top-5 right-5 p-4 rounded-xl shadow-xl text-white z-[100] transition-opacity duration-300 opacity-0 hidden" role="alert">
        Messaggio di notifica
    </div>

    <!-- Spinner di caricamento nascosto -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex flex-col items-center justify-center z-[90] hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
        <p id="loading-status" class="mt-4 text-white text-lg font-semibold">Caricamento dati...</p>
    </div>

    <main class="relative">
        <div class="fixed top-0 left-0 right-0 z-40 bg-white shadow-lg p-4 mb-8">
            <div class="container mx-auto max-w-5xl flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 justify-end items-center">
                <!-- Pulsante Annulla Prenotazione -->
                <button id="open-cancellation-modal-btn" class="cancellation-btn-fixed inline-flex items-center px-6 py-2 text-sm font-bold rounded-xl shadow-md transition duration-300 w-full sm:w-auto justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Annulla la mia Prenotazione
                </button>
<a href="chatbot.html" id="open-chatbot-link" class="fixed bottom-6 right-6 p-3 rounded-full shadow-lg transition duration-300 z-50">
    <button id="open-chatbot-btn" class="chatbot-btn-fixed">
        <div class="chatbot-icon-container">
            <img id="chatbot-rotating-image" src="foto_chatbot.png" alt="Chatbot Icon" class="w-8 h-8"/>
        </div>
    </button>
</a>
                <!-- Pulsante Accesso Docenti -->
                <button id="open-docente-login-btn" class="docente-access-btn px-6 py-2 text-sm font-bold text-white rounded-xl transition duration-300 w-full sm:w-auto justify-center flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1m18-7V9a3 3 0 00-3-3h-2M11 5V4a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2"></path></svg>
                    <span id="docente-login-text">Area Riservata Docenti</span>
                </button>
            </div>
        </div>

        <div class="container mx-auto p-4 sm:p-6 lg:p-10 max-w-5xl pt-32 sm:pt-24 md:pt-20">

            <!-- WARNING Message (TESTO MODIFICATO) -->
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8 rounded-xl shadow-md" role="alert">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <p class="font-bold text-lg">⚠️ ATTENZIONE: Documento di Conferma Importante!</p>
                </div>
                <p class="mt-2 text-sm">
                    È fondamentale conservare il PDF di conferma generato al momento della prenotazione e presentarlo all'ingresso il giorno dello Stage. 
                </p>
            </div>

            <!-- HEADER PRINCIPALE -->
            <header class="bg-white p-6 md:p-10 rounded-xl shadow-xl mb-8 border-t-4 border-indigo-600">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                    Il Ministage di Orientamento ITSCG Primo Levi
                </h1>
                <p class="text-lg text-gray-600 mt-4 leading-relaxed">
                    Per supportare al meglio l'importante scelta della scuola superiore, il nostro Istituto organizza dei Ministage di Orientamento, che permetteranno agli studenti di terza media di vivere un'esperienza diretta all'interno delle nostre aule. L'esperienza complessiva dura circa due ore.
                </p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- SEZIONE 1: COS'È UN MINISTAGE -->
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
                        <h2 class="text-2xl font-bold text-gray-800">Cos'è un Ministage?</h2>
                    </div>
                    <p class="text-gray-700">
                        È un'opportunità per gli studenti di terza media di trascorrere alcune ore presso la nostra scuola, inseriti direttamente in una classe. Lo scopo è far sperimentare in modo immersivo l'ambiente scolastico, i metodi di insegnamento e le materie di studio, facilitando così una scelta più consapevole.
                    </p>
                </section>

                <!-- SEZIONE 2: COME SI SVOLGE -->
                <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.001 12.001 0 002.944 12v6.655c0 .245.09.48.257.653L7 22l-1.92-2.195"></path></svg>
                        <h2 class="text-2xl font-bold text-gray-800">Come si svolge?</h2>
                    </div>
                    <ul class="space-y-3 text-gray-700 list-none pl-0">
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Assegnazione a una classe e accoglienza da un docente o tutor.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Partecipazione come uditore attivo a due ore di lezione consecutive curricolari.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Durata complessiva dell'esperienza: circa due ore.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Tutoraggio costante per supporto e domande.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Tutti i Lunedì e Mercoledì di Novembre e i primi tre di Dicembre i ragazzi seguiranno due ore di lezione (2°e3° oppure 5°-6° o 7°) presso il nostro istituto.</span>
                        </li>
                    </ul>
                </section>

                <!-- SEZIONE 3: OBIETTIVI (Ora occupa l'intera riga) -->
                <section class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg border-l-4 border-teal-500">
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-teal-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v14c-1.4 1.4-3.5 1.7-6 1.7s-4.6-.3-6-1.7zm12-14v14c-1.4 1.4-3.5 1.7-6 1.7s-4.6-.3-6-1.7"></path></svg>
                        <h2 class="text-2xl font-bold text-gray-800">Obiettivi principali</h2>
                    </div>
                    <ul class="space-y-2 text-gray-700 list-disc pl-5">
                        <li>Valutare l'ambiente e interagire con gli studenti.</li>
                        <li>Comprendere l'approccio didattico e il livello richiesto.</li>
                        <li>Sciogliere i dubbi sul percorso di studi.</li>
                    </ul>
                </section>
            </main>

            <!-- CONTENUTO DINAMICO STUDENTE/DOCENTE -->
            <div id="app-content-area" class="mt-12">
                <!-- VISTA STUDENTE -->
                <div id="student-main-view" class="space-y-10">
                    <h2 class="text-4xl font-extrabold text-gray-800 text-center mb-10">Scegli il tuo Indirizzo</h2>
                    
                    <!-- Vista 1: Selezione Corso -->
                    <div id="course-selection-view" class="space-y-12">
                        <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <!-- Le schede dei corsi saranno generate qui -->
                        </div>
                    </div>
                    
                    <!-- Vista 2: Selezione Data per Corso Specifico (Nascosta inizialmente) -->
                    <div id="date-selection-view" class="hidden space-y-6 p-6 bg-white rounded-xl shadow-xl border-t-4 border-indigo-600">
                        <button id="back-to-courses-btn" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 transition duration-150 border border-indigo-200 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Torna agli Indirizzi
                        </button>
                        <h3 class="text-3xl font-bold text-gray-800 border-b pb-2">Date disponibili per: <span id="selected-course-title" class="text-indigo-600"></span></h3>
                        <div id="dates-container" class="space-y-4">
                            <!-- Le date disponibili per il corso selezionato saranno generate qui -->
                        </div>
                    </div>
                </div>

                <!-- VISTA DOCENTE (Nascosta inizialmente) -->
                <div id="docente-view" class="hidden space-y-8 mt-12">
                    <div class="flex justify-between items-center bg-indigo-700 p-4 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-extrabold text-white">Pannello di Gestione Docenti</h2>
                        <div class="flex items-center space-x-4">
                            <button id="docente-logout-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-500 rounded-md hover:bg-indigo-400 transition duration-150 shadow-md flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1"></path></svg>
                                Esci
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <div class="flex justify-start border-b border-gray-200">
                            <button id="tab-bookings" class="tab-button px-4 py-3 text-gray-600 transition duration-150 tab-active">Prenotazioni Attive</button>
                            <button id="tab-cancellations" class="tab-button px-4 py-3 text-gray-600 transition duration-150">Storico Annullamenti</button>
                            <button id="tab-manage" class="tab-button px-4 py-3 text-gray-600 transition duration-150">Gestione Dati</button>
                        </div>

                        <!-- Tab Content 1: Prenotazioni Attive -->
                        <div id="content-bookings" class="tab-content pt-6">
                            <div class="mb-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 items-center">
                                <label for="date-filter" class="text-sm font-medium text-gray-700 whitespace-nowrap">Filtra per Data/Ora:</label>
                                <select id="date-filter" class="block w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="all">Tutte le date</option>
                                    <!-- Options popolate via JS -->
                                </select>
                            </div>
                            <div id="bookings-list" class="space-y-4">
                                <!-- Bookings list will be rendered here -->
                            </div>
                        </div>

                        <!-- Tab Content 2: Storico Annullamenti -->
                        <div id="content-cancellations" class="tab-content hidden pt-6">
                            <div id="cancellations-list" class="space-y-4">
                                <!-- Cancellations list will be rendered here -->
                            </div>
                        </div>

                        <!-- Tab Content 3: Gestione Dati -->
                        <div id="content-manage" class="tab-content hidden pt-6 border-t mt-4 border-red-200">
                            <div class="p-4 bg-red-50 rounded-lg border border-red-200 space-y-4">
                                <h4 class="text-xl font-bold text-red-700">Azione Irreversibile</h4>
                                <p class="text-red-600">
                                    Questo pulsante permette di cancellare TUTTI i dati di prenotazione e annullamento attivi da Firestore (inclusi i documenti generati automaticamente). Utilizzare solo per pulizia annuale o in caso di errore critico.
                                </p>
                                <button id="open-delete-modal-btn" class="px-6 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150 shadow-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    Elimina Tutti i Dati
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- FINE VISTA DOCENTE -->

            </div>
            <!-- FINE CONTENUTO DINAMICO -->


            <!-- SEZIONE 4: ORGANIZZAZIONE E CONTATTI (Footer-like) -->
            <footer class="mt-8 pt-6 border-t border-gray-300">
                <div class="bg-gray-100 p-6 rounded-xl text-center shadow-inner">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Organizzazione e Contatti</h3>
                    <p class="text-gray-700 mb-4">Organizzazione a cura delle Funzioni Orientamento:</p>

                    <div class="space-y-1">
                        <p class="text-lg font-medium text-indigo-700">
                            Prof. ssa Laura Corvi e Prof. ssa Mariagrazia Calabrese
                        </p>
                        <p class="text-gray-600">
                            ITSCG PRIMO LEVI DI SEREGNO
                        </p>
                        <p class="text-gray-600">
                            VIA BRIANTINA 68
                        </p>
                    </div>
                </div>
            </footer>
            
            <!-- Piè di pagina -->
            <div class="mt-16 pt-8 border-t border-gray-300 flex justify-center">
                <div class="w-full max-w-4xl text-center">
                    <p class="text-xs text-gray-400">© 2025 ITSCG Primo Levi. Tutti i diritti riservati.</p>
                    <p class="text-xs text-gray-400">ID Utente Corrente: <span id="current-user-id" class="font-mono">In attesa...</span></p>
                </div>
            </div>

        </div> <!-- end container -->

    </main>


    <!-- Modale di Prenotazione -->
    <div id="booking-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-lg rounded-xl shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-indigo-600">Conferma Prenotazione Stage</h3>
            <p class="text-gray-600 mb-2">Stage: <span id="modal-course-name" class="font-bold"></span></p>
            <p class="text-gray-600 mb-4">Data: <span id="modal-date" class="font-bold"></span></p>
            
            <form id="booking-form" class="space-y-4">
                <input type="hidden" id="booking-course-id">
                <input type="hidden" id="booking-date">

                <div>
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Nome e Cognome dello Studente</label>
                    <input type="text" id="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="student-school" class="block text-sm font-medium text-gray-700">Scuola Media di Provenienza</label>
                    <input type="text" id="student-school" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome completo della tua scuola media">
                </div>
                <div>
                    <label for="student-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="student-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="student-phone" class="block text-sm font-medium text-gray-700">Cellulare</label>
                    <input type="tel" id="student-phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="close-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                    <button type="submit" id="confirm-booking-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">Conferma e Genera PDF</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale di Cancellazione -->
    <div id="cancellation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-lg rounded-xl shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-red-600">Cancellazione Prenotazione</h3>
            
            <p class="text-gray-600 mb-4 text-sm">Per annullare, inserisci il codice di prenotazione univoco che trovi nel PDF di conferma. L'annullamento è immediato.</p>
            
            <form id="cancellation-form" class="space-y-4">
                <div>
                    <label for="cancellation-code" class="block text-sm font-medium text-gray-700">Codice Prenotazione</label>
                    <input type="text" id="cancellation-code" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Esempio: X3H4K9J2">
                </div>
                <div>
                    <label for="cancellation-reason" class="block text-sm font-medium text-gray-700">Motivazione della Cancellazione</label>
                    <textarea id="cancellation-reason" rows="2" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Es. Ho già partecipato ad un altro stage."></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="close-cancellation-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                    <button type="submit" id="confirm-cancellation-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150 shadow-md">Conferma Cancellazione</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modale Login Docente -->
    <div id="docente-login-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-sm rounded-xl shadow-2xl border-t-8 border-indigo-700">
            <div class="text-center mb-6">
                <svg class="w-12 h-12 mx-auto text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-1a3 3 0 00-3-3H8a3 3 0 00-3 3v1h12zm-9-10a4 4 0 11-8 0 4 4 0 018 0zm-7 0a7 7 0 1014 0 7 7 0 00-14 0zm15 10a4 4 0 100-8 4 4 0 000 8zM12 11a4 4 0 100-8 4 4 0 000 8z"></path></svg>
                <h3 class="text-2xl font-bold mt-3 text-indigo-800">Accesso Riservato Docenti</h3>
                <p class="text-gray-500 text-sm">Inserisci le credenziali ITSCG.</p>
            </div>
            
            <form id="docente-login-form" class="space-y-4">
                <div>
                    <label for="docente-username" class="block text-sm font-medium text-gray-700">Nome Utente</label>
                    <input type="text" id="docente-username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="docente-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="docente-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="flex justify-end pt-4">
                    <button type="submit" id="confirm-docente-login-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">Accedi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale di Eliminazione Dati Totale -->
    <div id="delete-data-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-sm rounded-xl shadow-2xl border-t-8 border-red-700">
            <div class="text-center mb-6">
                <svg class="w-12 h-12 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <h3 class="text-2xl font-bold mt-3 text-red-800">Conferma Eliminazione Globale</h3>
                <p class="text-gray-500 text-sm font-bold mt-2">
                    ATTENZIONE: Questa azione ELIMINERÀ IRREVERSIBILMENTE tutte le prenotazioni attive e lo storico annullamenti dal database.
                </p>
            </div>
            
            <form id="docente-delete-form" class="space-y-4">
                <div>
                    <label for="docente-delete-password" class="block text-sm font-medium text-gray-700">Reinserisci Password Docente</label>
                    <input type="password" id="docente-delete-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                </div>
                
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="close-delete-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                    <button type="submit" id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150 shadow-md">Conferma Eliminazione Dati</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Importazioni JavaScript e Logica di Applicazione Firebase -->
    <script type="module">
        // Importazioni Firebase necessarie per Auth, Firestore, e Query
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, where, addDoc, 
            onSnapshot, serverTimestamp, deleteDoc, getDocs, doc, setLogLevel, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Imposta il livello di log di Firestore su Debug per aiutare con il debugging
        setLogLevel('debug');

        // --- Variabili Globali del Canvas per Firebase (Obbligatorie) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let firebaseConfig = {};

        if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            console.warn("Configurazione Firebase non fornita dall'ambiente. Utilizzo della configurazione specifica dell'utente.");
            
            // ====================================================================================
            // CONFIGURAZIONE FIREBASE SPECIFICA (Configurazione fittizia/placeholder)
            // ====================================================================================
            firebaseConfig = {
                apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
                authDomain: "progetto-63fb3.firebaseapp.com",
                projectId: "progetto-63fb3", 
                storageBucket: "progetto-63fb3.firebasestorage.app",
                messagingSenderId: "883088850197",
                appId: "1:883088850197:web:29b8573ea43555041b3d1c",
            };
        }
        // --- Fine Configurazione Firebase ---

        // Variabili Firebase e Stato
        let db = null;
        let auth = null;
        let userId = null;
        let isDocente = false; 
        let isAuthReady = false; // Flag per attendere l'autenticazione

        // --- Stato Globale ---
        const MAX_SLOTS = 4; // Posti fissi per ogni slot data/corso
        let currentBookings = []; 
        let currentCancellations = [];
        let currentAvailability = {}; // Mappa { courseId_date: count }
        let currentCourseId = null; // Stato per la navigazione
        
        // Credenziali Docente Fisse (solo per simulazione di login, non per Firebase Auth)
        const DOCENTE_USERNAME = 'docente';
        const DOCENTE_PASSWORD = 'its2025'; 

        // Struttura fissa dei corsi
        const COURSES = [
            { id: 'liceo-scientifico', name: 'Liceo Scientifico Opzione Scienze Applicate', color: 'bg-blue-100 text-blue-800', icon: '<svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2zM9 8h6M9 12h6M9 16h6"></path></svg>' }, 
            { id: 'sistema-moda', name: 'Sistema Moda', color: 'bg-pink-100 text-pink-800', icon: '<svg class="w-8 h-8 text-pink-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13v8a1 1 0 001 1h8a1 1 0 001-1v-8m-7 0H7m0 0l-1-2m1 2l1-2m7 2h-4m-4 0l-1-2m1 2l1-2m-1 2H7"></path></svg>' },
            { id: 'relazioni-marketing', name: 'Relazioni Internazionali per il Marketing', color: 'bg-yellow-100 text-yellow-800', icon: '<svg class="w-8 h-8 text-yellow-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v5m0 0a2 2 0 100 4 2 2 0 000-4zM12 8V6a2 2 0 100-4 2 2 0 000 4z"></path></svg>' },
            { id: 'logistica-quadriennale', name: 'Logistica Corso Quadriennale', color: 'bg-indigo-100 text-indigo-800', icon: '<svg class="w-8 h-8 text-indigo-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-4 4m0 0l-4-4m4 4V7"></path></svg>' },
            { id: 'costruzione-territorio', name: 'Costruzione Ambiente e Territorio', color: 'bg-purple-100 text-purple-800', icon: '<svg class="w-8 h-8 text-purple-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>' }
        ];

        const PROGRAMMED_DATES_WITH_TIMES = [
            // Lunedì 12:50-14:40 (2h) e Mercoledì 8:50-10:50 (2h)
            { date: '2025-11-03', day: 'Lunedì', time: '12:50-14:40' },
            { date: '2025-11-05', day: 'Mercoledì', time: '8:50-10:50' },
            { date: '2025-11-10', day: 'Lunedì', time: '12:50-14:40' },
            { date: '2025-11-12', day: 'Mercoledì', time: '8:50-10:50' },
            { date: '2025-11-17', day: 'Lunedì', time: '12:50-14:40' },
            { date: '2025-11-19', day: 'Mercoledì', time: '8:50-10:50' },
            { date: '2025-11-24', day: 'Lunedì', time: '12:50-14:40' },
            { date: '2025-11-26', day: 'Mercoledì', time: '8:50-10:50' },
            { date: '2025-12-01', day: 'Lunedì', time: '12:50-14:40' },
            { date: '2025-12-03', day: 'Mercoledì', time: '8:50-10:50' },
            { date: '2025-12-08', day: 'Lunedì', time: '12:50-14:40' },
            { date: '2025-12-10', day: 'Mercoledì', time: '8:50-10:50' },
            { date: '2025-12-15', day: 'Lunedì', time: '12:50-14:40' },
            { date: '2025-12-17', day: 'Mercoledì', time: '8:50-10:50' }
        ];
        const PROGRAMMED_DATES = PROGRAMMED_DATES_WITH_TIMES;
        
        const PDF_SIGNATURE = 'ITSCG PRIMO LEVI DI SEREGNO VIA BRIANTINA 68 - Funzioni Orientamento: Prof. ssa Laura Corvi e Prof. ssa Maria Grazia Calabrese';
        
        // Elementi DOM
        const coursesContainer = document.getElementById('courses-container');
        const messageBox = document.getElementById('message-box');
        const bookingModal = document.getElementById('booking-modal');
        const cancellationModal = document.getElementById('cancellation-modal');
        const bookingForm = document.getElementById('booking-form');
        const cancellationForm = document.getElementById('cancellation-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingStatus = document.getElementById('loading-status');
        const docenteLoginModal = document.getElementById('docente-login-modal');
        const docenteLoginForm = document.getElementById('docente-login-form');
        const studentMainView = document.getElementById('student-main-view');
        const docenteView = document.getElementById('docente-view');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const dateFilter = document.getElementById('date-filter');
        const deleteDataModal = document.getElementById('delete-data-modal');
        const docenteDeleteForm = document.getElementById('docente-delete-form');
        
        // Nuovi elementi per la navigazione Studente
        const courseSelectionView = document.getElementById('course-selection-view');
        const dateSelectionView = document.getElementById('date-selection-view');
        const selectedCourseTitle = document.getElementById('selected-course-title');
        const datesContainer = document.getElementById('dates-container');

        // Pulsanti
        const docenteLogoutBtn = document.getElementById('docente-logout-btn');
        const docenteLoginText = document.getElementById('docente-login-text');

        // Collezioni Firestore
        // Le prenotazioni sono pubbliche in modo che tutti i client possano calcolare la disponibilità
        const BOOKINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/bookings`;
        const CANCELLATIONS_COLLECTION_PATH = `/artifacts/${appId}/public/data/cancellations`;


        // --- Funzioni di Utility ---

        function showLoading(status) {
            loadingStatus.textContent = status;
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        function generateUniqueCode(length = 8) {
            // Codice alfanumerico per la conferma di prenotazione
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `fixed top-20 right-5 p-4 rounded-xl shadow-xl z-[100] transition-opacity duration-300 opacity-100 text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            messageBox.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 5000); 
        }

        function resetFormsAndModals() {
            bookingModal.classList.add('hidden');
            cancellationModal.classList.add('hidden');
            docenteLoginModal.classList.add('hidden');
            deleteDataModal.classList.add('hidden');
            bookingForm.reset();
            cancellationForm.reset();
            docenteLoginForm.reset();
            docenteDeleteForm.reset();
        }
        
        /**
         * Simula la generazione di un PDF scaricando un file di testo.
         */
        function generateAndDownloadPDF(bookingData, bookingCode) {
            const course = COURSES.find(c => c.id === bookingData.courseId);
            const dateObj = PROGRAMMED_DATES.find(d => d.date === bookingData.date);
            const formattedDate = dateObj ? `${dateObj.day} ${new Date(dateObj.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })} (${dateObj.time})` : bookingData.date;


            const pdfContent = `
=====================================================
    CONFERMA DI PRENOTAZIONE MINISTAGE ITSCG
=====================================================

CODICE PRENOTAZIONE UNIVOCO: ${bookingCode}

-----------------------------------------------------
DETTAGLI STAGE
-----------------------------------------------------
Indirizzo Selezionato: ${course.name}
Data e Orario: ${formattedDate}

-----------------------------------------------------
DATI STUDENTE
-----------------------------------------------------
Nome e Cognome: ${bookingData.studentName}
Scuola di Provenienza: ${bookingData.studentSchool}
Email di Contatto: ${bookingData.studentEmail}
Cellulare di Contatto: ${bookingData.studentPhone}

-----------------------------------------------------
NOTE IMPORTANTI
-----------------------------------------------------
* Conserva e presenta questo codice/documento all'ingresso.
* Si prega di arrivare 10 minuti prima dell'orario stabilito.
* L'esperienza ha una durata di circa due ore.

=====================================================
Organizzazione a cura di:
${PDF_SIGNATURE}
Data Generazione: ${new Date().toLocaleDateString('it-IT')}
=====================================================
            `.trim();

            const blob = new Blob([pdfContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Conferma_Ministage_${bookingCode}.txt`; // Download come TXT (simulando PDF)
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Gestione Modali e Navigazione ---
        document.getElementById('close-modal-btn').addEventListener('click', resetFormsAndModals);
        document.getElementById('open-cancellation-modal-btn').addEventListener('click', () => cancellationModal.classList.remove('hidden'));
        document.getElementById('close-cancellation-modal-btn').addEventListener('click', resetFormsAndModals);
        document.getElementById('open-docente-login-btn').addEventListener('click', () => docenteLoginModal.classList.remove('hidden'));
        document.getElementById('open-delete-modal-btn').addEventListener('click', () => deleteDataModal.classList.remove('hidden'));
        document.getElementById('close-delete-modal-btn').addEventListener('click', resetFormsAndModals);
        
        // Listener per tornare alla Home Studente
        document.getElementById('back-to-courses-btn').addEventListener('click', () => {
            currentCourseId = null;
            renderStudentView('home');
        });

        // Gestione Tab Docente
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                switchTab(e.target.id.replace('tab-', ''));
            });
        });
        
        // --- Funzioni di Rendering Viste ---

        // Funzione per gestire la visualizzazione Studente/Docente
        function renderStudentView(view) {
            docenteView.classList.add('hidden');
            studentMainView.classList.remove('hidden');
            
            if (view === 'home') {
                courseSelectionView.classList.remove('hidden');
                dateSelectionView.classList.add('hidden');
                renderCourses(); 
            } else if (view === 'dates' && currentCourseId) {
                courseSelectionView.classList.add('hidden');
                dateSelectionView.classList.remove('hidden');
                renderCourseDates(currentCourseId); 
            }
        }

        function renderDocenteView() {
            // Aggiorna UI Login Docente
            docenteLoginText.textContent = 'Logout Docente';
            document.getElementById('open-docente-login-btn').removeEventListener('click', () => docenteLoginModal.classList.remove('hidden'));
            document.getElementById('open-docente-login-btn').addEventListener('click', handleDocenteLogout);

            studentMainView.classList.add('hidden');
            docenteView.classList.remove('hidden');

            // Popola il filtro data
            populateDateFilter();
            
            // Inizializza sulla prima tab
            switchTab('bookings');

            // Renderizza le liste con i dati aggiornati
            renderBookingsList();
            renderCancellationsList();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            document.getElementById(`tab-${tabId}`).classList.add('tab-active');
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
        }
        
        // Renderizza le schede dei corsi nella vista home
        function renderCourses() {
            coursesContainer.innerHTML = COURSES.map(course => {
                return `
                    <div data-id="${course.id}" class="course-card ${course.color} bg-opacity-70 p-6 rounded-xl shadow-lg border-t-4 border-indigo-600 cursor-pointer hover:shadow-2xl transition duration-300 transform hover:scale-[1.02]">
                        <div class="flex items-center space-x-4">
                            ${course.icon}
                            <h3 class="text-xl font-bold text-gray-800">${course.name}</h3>
                        </div>
                        <p class="mt-4 text-sm text-gray-700">Clicca per vedere le date disponibili e prenotare il tuo stage orientativo in questo indirizzo.</p>
                    </div>
                `;
            }).join('');

            // Aggiungi listener per la selezione del corso
            document.querySelectorAll('.course-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const courseElement = e.currentTarget;
                    currentCourseId = courseElement.getAttribute('data-id');
                    const courseName = COURSES.find(c => c.id === currentCourseId).name;
                    selectedCourseTitle.textContent = courseName;
                    renderStudentView('dates');
                });
            });
        }
        
        // Renderizza le date disponibili per il corso selezionato
        function renderCourseDates(courseId) {
            const course = COURSES.find(c => c.id === courseId);
            if (!course) return; // Non dovrebbe succedere
            
            datesContainer.innerHTML = PROGRAMMED_DATES.map(dateObj => {
                const key = `${courseId}_${dateObj.date}`;
                const bookedCount = currentAvailability[key] || 0;
                const available = MAX_SLOTS - bookedCount;
                const isFull = available <= 0;

                const formattedDate = new Date(dateObj.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
                const statusClass = isFull ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600';
                const buttonClass = isFull ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700';

                return `
                    <div class="flex flex-col sm:flex-row items-center justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="mb-2 sm:mb-0">
                            <p class="text-lg font-semibold text-gray-800">${dateObj.day}, ${formattedDate}</p>
                            <p class="text-sm text-gray-500">Orario: ${dateObj.time}</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium px-3 py-1 rounded-full ${statusClass}">
                                Posti: ${isFull ? 'COMPLETO' : `${available} di ${MAX_SLOTS}`}
                            </span>
                            <button 
                                data-course-id="${course.id}" 
                                data-course-name="${course.name}"
                                data-date="${dateObj.date}"
                                data-formatted-date="${dateObj.day}, ${formattedDate} (${dateObj.time})"
                                class="open-booking-modal-btn px-4 py-2 text-sm font-medium text-white rounded-md transition duration-150 shadow-md ${buttonClass}" 
                                ${isFull ? 'disabled' : ''}
                            >
                                Prenota
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Aggiungi listener per aprire la modale di prenotazione
            document.querySelectorAll('.open-booking-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const courseId = e.currentTarget.getAttribute('data-course-id');
                    const courseName = e.currentTarget.getAttribute('data-course-name');
                    const date = e.currentTarget.getAttribute('data-date');
                    const formattedDate = e.currentTarget.getAttribute('data-formatted-date');

                    document.getElementById('modal-course-name').textContent = courseName;
                    document.getElementById('modal-date').textContent = formattedDate;
                    document.getElementById('booking-course-id').value = courseId;
                    document.getElementById('booking-date').value = date;

                    bookingModal.classList.remove('hidden');
                });
            });
        }

        // --- Gestione Stato Docente ---

        function handleDocenteLogout() {
            signOut(auth).then(() => {
                isDocente = false;
                docenteLoginText.textContent = 'Area Riservata Docenti';
                document.getElementById('open-docente-login-btn').removeEventListener('click', handleDocenteLogout);
                document.getElementById('open-docente-login-btn').addEventListener('click', () => docenteLoginModal.classList.remove('hidden'));
                renderStudentView('home'); // Torna alla vista studente
                showMessage('Logout Docente effettuato con successo.', 'success');
            }).catch(error => {
                console.error("Logout Docente fallito:", error);
                showMessage('Errore durante il logout.', 'error');
            });
        }


        // --- Gestione Dati Firestore ---
        
        // Listener per Prenotazioni e Cancellazioni
        function setupDataListeners() {
            if (!db || !isAuthReady) {
                console.log("Database o Autenticazione non pronti per i listener.");
                return;
            }
            
            showLoading("Caricamento prenotazioni in tempo reale...");

            // 1. Prenotazioni Attive (tutte le prenotazioni non cancellate)
            const bookingsQuery = query(collection(db, BOOKINGS_COLLECTION_PATH));
            onSnapshot(bookingsQuery, (snapshot) => {
                currentBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Ricalcola la disponibilità
                currentAvailability = {};
                currentBookings.forEach(booking => {
                    const key = `${booking.courseId}_${booking.date}`;
                    currentAvailability[key] = (currentAvailability[key] || 0) + 1;
                });

                // Aggiorna l'interfaccia utente
                if (docenteView.classList.contains('hidden')) {
                     // Se siamo in vista studente, aggiorna solo se siamo nella vista date
                    if (currentCourseId) renderCourseDates(currentCourseId);
                    else renderCourses(); // Altrimenti, aggiorna le card dei corsi
                } else {
                    renderBookingsList();
                }
                hideLoading();
            }, (error) => {
                console.error("Errore nel listener prenotazioni:", error);
                showMessage("Errore nel caricamento delle prenotazioni. Riprova.", "error");
                hideLoading();
            });

            // 2. Storico Annullamenti
            const cancellationsQuery = query(collection(db, CANCELLATIONS_COLLECTION_PATH));
            onSnapshot(cancellationsQuery, (snapshot) => {
                currentCancellations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                
                if (!docenteView.classList.contains('hidden')) {
                    renderCancellationsList();
                }
            }, (error) => {
                console.error("Errore nel listener annullamenti:", error);
            });
        }

        // --- Submission Handler Studente ---

        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            resetFormsAndModals();
            showLoading('Salvataggio prenotazione...');

            const courseId = document.getElementById('booking-course-id').value;
            const date = document.getElementById('booking-date').value;
            const studentName = document.getElementById('student-name').value;
            const studentSchool = document.getElementById('student-school').value;
            const studentEmail = document.getElementById('student-email').value;
            const studentPhone = document.getElementById('student-phone').value;
            const bookingCode = generateUniqueCode();
            
            const bookingKey = `${courseId}_${date}`;
            const currentBooked = currentAvailability[bookingKey] || 0;

            if (currentBooked >= MAX_SLOTS) {
                showMessage('Errore: I posti per questa data/corso sono appena terminati.', 'error');
                hideLoading();
                return;
            }

            const bookingData = {
                bookingCode,
                courseId,
                date,
                studentName,
                studentSchool,
                studentEmail,
                studentPhone,
                userId: userId, // ID utente Firebase anonimo o autenticato
                timestamp: serverTimestamp(),
            };

            try {
                await addDoc(collection(db, BOOKINGS_COLLECTION_PATH), bookingData);
                
                // Genera e scarica il PDF di conferma
                generateAndDownloadPDF(bookingData, bookingCode);

                showMessage(`Prenotazione confermata! Codice: ${bookingCode}. Il documento è stato scaricato.`, 'success');
            } catch (error) {
                console.error("Errore durante la prenotazione:", error);
                showMessage("Errore durante la prenotazione. Riprova più tardi.", "error");
            } finally {
                hideLoading();
            }
        });

        cancellationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            resetFormsAndModals();
            showLoading('Cancellazione in corso...');

            const code = document.getElementById('cancellation-code').value.toUpperCase();
            const reason = document.getElementById('cancellation-reason').value;

            // 1. Trova la prenotazione per codice
            const bookingToCancel = currentBookings.find(b => b.bookingCode === code);

            if (!bookingToCancel) {
                showMessage('Codice di prenotazione non valido o già annullato.', 'error');
                hideLoading();
                return;
            }

            try {
                // 2. Registra l'annullamento nello storico
                const cancellationData = {
                    ...bookingToCancel, // Copia tutti i dati di prenotazione
                    originalBookingId: bookingToCancel.id,
                    cancellationReason: reason,
                    cancellationTimestamp: serverTimestamp()
                };
                delete cancellationData.id; // Rimuove l'ID Firestore originale per non sovrascrivere
                
                await addDoc(collection(db, CANCELLATIONS_COLLECTION_PATH), cancellationData);
                
                // 3. Elimina la prenotazione attiva
                await deleteDoc(doc(db, BOOKINGS_COLLECTION_PATH, bookingToCancel.id));

                showMessage(`Prenotazione ${code} annullata con successo.`, 'success');
            } catch (error) {
                console.error("Errore durante la cancellazione:", error);
                showMessage("Errore durante la cancellazione. Riprova più tardi.", "error");
            } finally {
                hideLoading();
            }
        });

        // --- Submission Handler Docente ---

        docenteLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('docente-username').value;
            const password = document.getElementById('docente-password').value;
            
            resetFormsAndModals();

            if (username === DOCENTE_USERNAME && password === DOCENTE_PASSWORD) {
                isDocente = true;
                renderDocenteView();
                showMessage('Accesso Docente riuscito.', 'success');
            } else {
                showMessage('Credenziali Docente non valide.', 'error');
            }
        });

        docenteDeleteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            resetFormsAndModals();
            showLoading('Eliminazione globale dati in corso...');

            const password = document.getElementById('docente-delete-password').value;

            if (password !== DOCENTE_PASSWORD) {
                showMessage('Password Docente errata. Operazione annullata.', 'error');
                hideLoading();
                return;
            }

            try {
                const batch = writeBatch(db);
                let deleteCount = 0;

                // 1. Eliminazione Prenotazioni
                const bookingsSnapshot = await getDocs(collection(db, BOOKINGS_COLLECTION_PATH));
                bookingsSnapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                    deleteCount++;
                });

                // 2. Eliminazione Storico Annullamenti
                const cancellationsSnapshot = await getDocs(collection(db, CANCELLATIONS_COLLECTION_PATH));
                cancellationsSnapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                    deleteCount++;
                });

                await batch.commit();

                showMessage(`Successo! Eliminati ${deleteCount} documenti totali (prenotazioni e annullamenti).`, 'success');
            } catch (error) {
                console.error("Errore durante l'eliminazione globale:", error);
                showMessage("Errore fatale durante l'eliminazione globale dei dati.", "error");
            } finally {
                hideLoading();
                // Ricarica la vista docente per mostrare liste vuote
                renderDocenteView();
            }
        });


        // --- Funzioni di Rendering Viste Docente ---

        function populateDateFilter() {
            // Raccoglie tutte le combinazioni uniche data + orario
            const uniqueDates = PROGRAMMED_DATES.map(d => ({
                value: `${d.date}_${d.time}`,
                text: `${d.day}, ${new Date(d.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'long' })} (${d.time})`
            }));

            // Rimuove i duplicati e ordina cronologicamente (se necessario)
            const optionsHtml = uniqueDates.map(d => `<option value="${d.value}">${d.text}</option>`).join('');

            dateFilter.innerHTML = `<option value="all">Tutte le date</option>${optionsHtml}`;
            dateFilter.removeEventListener('change', renderBookingsList);
            dateFilter.addEventListener('change', renderBookingsList);
        }

        function renderBookingsList() {
            if (!isDocente) return;
            
            const filterValue = dateFilter.value;
            const [filterDate, filterTime] = filterValue.split('_');

            let filteredBookings = currentBookings;

            if (filterValue !== 'all') {
                 filteredBookings = currentBookings.filter(booking => 
                    booking.date === filterDate
                 );
                 // Nota: L'orario è implicitamente gestito dalla data unica programmata.
            }
            
            const groupedBookings = filteredBookings.reduce((acc, booking) => {
                const course = COURSES.find(c => c.id === booking.courseId);
                const dateObj = PROGRAMMED_DATES.find(d => d.date === booking.date);
                const groupKey = `${booking.courseId} - ${booking.date}`;
                
                if (!acc[groupKey]) {
                    acc[groupKey] = {
                        courseName: course ? course.name : 'Corso Sconosciuto',
                        dateDisplay: dateObj ? `${dateObj.day}, ${new Date(dateObj.date).toLocaleDateString('it-IT')} (${dateObj.time})` : booking.date,
                        bookings: []
                    };
                }
                acc[groupKey].bookings.push(booking);
                return acc;
            }, {});

            let html = '';
            
            const sortedGroups = Object.keys(groupedBookings).sort((a, b) => {
                // Ordina per data (la data è nel formato YYYY-MM-DD nel groupKey, quindi sort alfabetico funziona)
                return groupedBookings[a].dateDisplay.localeCompare(groupedBookings[b].dateDisplay);
            });


            if (sortedGroups.length === 0) {
                html = `<p class="text-gray-500 p-4 bg-gray-50 rounded-lg">Nessuna prenotazione attiva trovata per i filtri selezionati.</p>`;
            } else {
                sortedGroups.forEach(key => {
                    const group = groupedBookings[key];
                    const courseInfo = COURSES.find(c => c.name === group.courseName);
                    const groupKey = `${courseInfo.id}_${group.bookings[0].date}`;
                    const bookedCount = currentAvailability[groupKey] || 0;
                    const available = MAX_SLOTS - bookedCount;

                    html += `
                        <div class="bg-indigo-50 p-4 rounded-xl shadow-md border-l-4 border-indigo-600 mb-6">
                            <h4 class="text-xl font-bold text-indigo-800">${group.courseName}</h4>
                            <p class="text-sm text-gray-700 font-semibold mt-1 mb-3">${group.dateDisplay} | Posti: ${bookedCount} di ${MAX_SLOTS} occupati (${available} disponibili)</p>
                            <div class="space-y-2">
                    `;
                    
                    // Ordina le prenotazioni all'interno del gruppo per nome studente
                    group.bookings.sort((a, b) => a.studentName.localeCompare(b.studentName));

                    group.bookings.forEach((booking, index) => {
                        html += `
                            <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-indigo-200 hover:bg-indigo-100 transition duration-150">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-gray-800">${index + 1}. ${booking.studentName} (${booking.studentSchool})</p>
                                    <p class="text-xs text-gray-500 truncate">Codice: <span class="font-mono text-indigo-700">${booking.bookingCode}</span> | Email: ${booking.studentEmail}</p>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('bookings-list').innerHTML = html;
        }


        function renderCancellationsList() {
            if (!isDocente) return;

            let html = '';
            
            if (currentCancellations.length === 0) {
                html = `<p class="text-gray-500 p-4 bg-gray-50 rounded-lg">Nessun annullamento registrato.</p>`;
            } else {
                currentCancellations.forEach(cancellation => {
                    const course = COURSES.find(c => c.id === cancellation.courseId);
                    const courseName = course ? course.name : 'Corso Sconosciuto';
                    const formattedDate = new Date(cancellation.date).toLocaleDateString('it-IT');
                    const cancellationTime = cancellation.cancellationTimestamp ? new Date(cancellation.cancellationTimestamp.toDate()).toLocaleTimeString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/D';

                    html += `
                        <div class="bg-red-50 p-4 rounded-xl border border-red-200 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-lg font-bold text-red-800">${cancellation.studentName}</p>
                                <span class="text-xs font-semibold text-red-600 bg-red-200 px-2 py-0.5 rounded-full">ANNULLATO</span>
                            </div>
                            <p class="text-sm text-gray-700"><strong>Corso:</strong> ${courseName} | <strong>Data:</strong> ${formattedDate}</p>
                            <p class="text-sm text-gray-700"><strong>Codice:</strong> <span class="font-mono">${cancellation.bookingCode}</span></p>
                            <p class="text-xs text-gray-500 mt-1">Annullato il: ${cancellationTime}</p>
                            <p class="text-xs text-red-500 mt-2 italic">Motivazione: ${cancellation.cancellationReason || 'Nessuna motivazione fornita.'}</p>
                        </div>
                    `;
                });
            }
            document.getElementById('cancellations-list').innerHTML = html;
        }


        // --- Inizializzazione Firebase ---
        async function initFirebaseAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticazione con token personalizzato o anonima
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener per lo stato di autenticazione
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Questo non dovrebbe accadere dopo il sign-in iniziale
                        userId = 'guest_' + crypto.randomUUID(); 
                    }

                    currentUserIdDisplay.textContent = userId;
                    isAuthReady = true;

                    // I listener dei dati devono partire solo dopo l'autenticazione
                    setupDataListeners();
                    
                    // Mostra la vista studente di default
                    renderStudentView('home');
                    hideLoading();
                });

            } catch (error) {
                console.error("Errore fatale nell'inizializzazione Firebase:", error);
                showMessage("Errore fatale nell'inizializzazione dell'applicazione.", "error");
                currentUserIdDisplay.textContent = 'ERRORE';
                hideLoading();
            }
        }

        // Avvio dell'applicazione
        window.onload = () => {
             showLoading("Avvio applicazione e connessione al database...");
             initFirebaseAndAuth();
        };

    </script>
</body>
</html>
