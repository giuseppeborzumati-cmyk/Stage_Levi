<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITSCG | Prenotazione Ministage Orientamento</title>
    <!-- Tailwind CSS CDN per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- jsPDF CDN per la generazione dei PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .tab-active { border-bottom: 4px solid #4f46e5; color: #4f46e5; font-weight: 700; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 1.5rem; height: 1.5rem; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-button-primary { background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .modal-button-primary:hover:enabled { background-color: #4338ca; }
        .modal-button-secondary { background-color: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .modal-button-secondary:hover { background-color: #e5e7eb; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-bottom: 4px solid transparent;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }
        .tab-button:hover:not(.tab-active) {
            border-bottom: 4px solid #c7d2fe; /* light indigo */
        }
        .date-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .date-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Messaggio di Notifica (SnackBar) -->
    <div id="message-box" class="fixed top-5 right-5 hidden p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 opacity-0" role="alert"></div>

    <!-- Contenitore Principale -->
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header e Stato -->
        <header class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-4 md:mb-0">ITSCG | Prenotazioni Ministage</h1>
            <div class="flex items-center space-x-4">
                <!-- Bottone Chatbot -->
                <a href="chatbot.html" target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 01-4.24-.958l-.6 1.258A1 1 0 014 20.94V19a9 9 0 1117-7z"></path></svg>
                    <span>Chatbot ITSCG</span>
                </a>
                <button id="open-docente-login-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md">
                    Accesso Docente
                </button>
            </div>
        </header>

        <!-- Spinner di Caricamento Iniziale -->
        <div id="loading-spinner" class="flex flex-col items-center justify-center p-12 bg-white rounded-xl shadow-lg mt-12">
            <div class="spinner border-indigo-500 border-t-indigo-700 w-8 h-8"></div>
            <p id="loading-status" class="mt-4 text-lg text-gray-600">Connessione a Firebase...</p>
        </div>

        <!-- ========================================================================= -->
        <!-- VISTA STUDENTE (Default) -->
        <!-- ========================================================================= -->
        <div id="student-main-view" class="space-y-8 hidden">
            
            <!-- SEZIONE INFORMATIVA DETTAGLIATA -->
            <section class="bg-indigo-50 p-6 rounded-xl shadow-md border-l-4 border-indigo-500 space-y-4">
                <p class="text-lg font-extrabold text-red-600">‚ö†Ô∏è ATTENZIONE: Documento di Conferma Importante!</p>
                <p class="text-gray-700">Conservare il PDF di conferma e presentarlo all'ingresso il giorno dello Stage. </p>
                <p class="text-gray-700">Presentarsi almeno 10 minuti prima dell' orario indicato. </p>
                
                <p class="text-sm text-gray-500 pt-3">Organizzazione a cura delle Funzioni Orientamento: Prof. ssa Mariagrazia Calabrese e Prof. ssa Laura Corvi. ITSCG PRIMO LEVI DI SEREGNO, VIA BRIANTINA 68.</p>

                <div id="cancellation-section" class="pt-4 border-t border-indigo-200 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                    <p class="text-yellow-800 font-medium">Hai gi√† prenotato ma devi annullare? Utilizza il tuo codice prenotazione.</p>
                    <button id="open-cancellation-modal-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 shadow-lg">
                        Annulla Prenotazione
                    </button>
                </div>
            </section>

            <!-- 1. SELEZIONE CORSO -->
            <section id="course-selection-view" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Scegli l'Indirizzo di Studio per il tuo Ministage:</h2>
                <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- I corsi saranno renderizzati qui -->
                </div>
            </section>

            <!-- 2. SELEZIONE DATA (Dopo aver scelto il corso) -->
            <section id="date-selection-view" class="hidden bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center space-x-4 mb-6 border-b pb-4">
                    <button id="back-to-courses-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Torna agli Indirizzi
                    </button>
                    <h2 id="selected-course-title" class="text-xl font-bold text-gray-800"></h2>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Seleziona una data e un orario disponibile:</h3>
                <div id="dates-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Le date saranno renderizzate qui -->
                </div>
            </section>
        </div>
        
        <!-- ========================================================================= -->
        <!-- VISTA DOCENTE -->
        <!-- ========================================================================= -->
        <div id="docente-view" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-indigo-700">Dashboard Docente | Gestione Prenotazioni</h2>
                    <button id="logout-docente-btn" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md">
                        Logout
                    </button>
                </div>

                <!-- Tabs di Navigazione -->
                <div class="flex border-b mb-6 overflow-x-auto whitespace-nowrap">
                    <button id="tab-bookings" class="tab-button tab-active">Prenotazioni Attive</button>
                    <button id="tab-cancellations" class="tab-button">Log Annullamenti</button>
                </div>
                
                <!-- Contenuto Tab 1: Prenotazioni Attive -->
                <div id="content-bookings" class="tab-content space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                            <label class="flex items-center space-x-2 text-gray-600">
                                Filtra per Data:
                                <select id="date-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full"></select>
                            </label>
                            <button id="export-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 w-full sm:w-auto">
                                Esporta in CSV
                            </button>
                        </div>
                        <button id="open-delete-modal-btn" class="bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-xl transition duration-200 w-full sm:w-auto">
                            Cancella tutti i dati
                        </button>
                    </div>

                    <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Codice</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Studente</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Corso</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Data</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Orario</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Scuola Media</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Contatti</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Iscritto il</th>
                                </tr>
                            </thead>
                            <tbody id="bookings-table-body" class="bg-white divide-y divide-gray-100">
                                <!-- I dati delle prenotazioni attive saranno qui -->
                            </tbody>
                        </table>
                        <p id="no-bookings-message" class="hidden p-4 text-center text-gray-500">Nessuna prenotazione attiva trovata per il filtro selezionato.</p>
                    </div>
                </div>

                <!-- Contenuto Tab 2: Log Annullamenti -->
                <div id="content-cancellations" class="tab-content hidden space-y-6">
                    <p class="text-sm text-gray-500 mb-4">Registro di tutte le prenotazioni che sono state annullate dagli utenti. Questi posti sono stati ripristinati.</p>
                    <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Codice Annullato</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Nome Studente</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Corso</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Data/Ora Originale</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Annullato il</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Motivazione</th>
                                </tr>
                            </thead>
                            <tbody id="cancellations-table-body" class="bg-white divide-y divide-gray-100">
                                <!-- I log di cancellazione saranno qui -->
                            </tbody>
                        </table>
                        <p id="no-cancellations-message" class="hidden p-4 text-center text-gray-500">Nessun annullamento registrato finora.</p>
                    </div>
                </div>

            </div>
        </div>
        <!-- Modali (lasciate identiche per funzionalit√†) -->
        <!-- Modale Prenotazione Studente -->
        <div id="booking-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-indigo-700">Conferma Iscrizione al Ministage</h3>
                <p class="text-gray-600">Stai per prenotare un posto per l'indirizzo <strong id="modal-course-name"></strong> in data <strong id="modal-date"></strong>.</p>
                
                <form id="booking-form" class="space-y-4">
                    <input type="hidden" id="booking-course-id" name="courseId">
                    <input type="hidden" id="booking-date" name="date">

                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome e Cognome dello Studente <span class="text-red-500">*</span></label>
                        <input type="text" id="student-name" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-school" class="block text-sm font-medium text-gray-700">Scuola Media di Provenienza <span class="text-red-500">*</span></label>
                        <input type="text" id="student-school" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-email" class="block text-sm font-medium text-gray-700">Email di Contatto (per la conferma PDF) <span class="text-red-500">*</span></label>
                        <input type="email" id="student-email" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-phone" class="block text-sm font-medium text-gray-700">Cellulare di Contatto <span class="text-red-500">*</span></label>
                        <input type="tel" id="student-phone" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <p class="text-xs text-red-500">ATTENZIONE: Verr√† generato un PDF di conferma OBBLIGATORIO da presentare all'ingresso.</p>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-modal-btn" class="modal-button-secondary">Chiudi</button>
                        <button type="submit" id="confirm-booking-btn" class="modal-button-primary flex items-center">
                            Conferma e Genera PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale Annullamento Studente -->
        <div id="cancellation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-red-600">Annulla la tua Prenotazione</h3>
                <p class="text-gray-600">Inserisci il codice di prenotazione che hai ricevuto via PDF per annullare la tua iscrizione.</p>
                
                <form id="cancellation-form" class="space-y-4">
                    <div>
                        <label for="cancellation-code" class="block text-sm font-medium text-gray-700">Codice Prenotazione (es: ABC123XYZ) <span class="text-red-500">*</span></label>
                        <input type="text" id="cancellation-code" required minlength="10" maxlength="10" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500 uppercase">
                    </div>
                    <div>
                        <label for="cancellation-reason" class="block text-sm font-medium text-gray-700">Motivazione (Opzionale)</label>
                        <textarea id="cancellation-reason" rows="3" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-cancellation-modal-btn" class="modal-button-secondary">Annulla</button>
                        <button type="submit" id="confirm-cancellation-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-md flex items-center">
                            Annulla la mia Prenotazione
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale Login Docente -->
        <div id="docente-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4">
                <h3 class="text-xl font-bold text-gray-800">Accesso Riservato Docente</h3>
                <p class="text-sm text-gray-500">Inserisci le credenziali per accedere alla dashboard di gestione.</p>
                
                <form id="docente-login-form" class="space-y-4">
                    <div>
                        <label for="docente-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="docente-username" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="docente-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="docente-password" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="document.getElementById('docente-login-modal').classList.add('hidden')" class="modal-button-secondary">Chiudi</button>
                        <button type="submit" class="modal-button-primary">
                            Accedi
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modale Eliminazione Dati Docente -->
        <div id="delete-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-red-700">CANCELLAZIONE DATI COMPLETA</h3>
                <p class="text-sm text-gray-600">Questa azione √® IRREVERSIBILE ed eliminer√† tutte le prenotazioni e i log di annullamento dal database Firebase per questo progetto.</p>
                <p class="text-sm font-bold text-red-700">Procedi solo se necessario per azzerare l'anno accademico.</p>
                
                <form id="docente-delete-form" class="space-y-4">
                    <div>
                        <label for="docente-delete-password" class="block text-sm font-medium text-gray-700">Password Docente per Conferma <span class="text-red-500">*</span></label>
                        <input type="password" id="docente-delete-password" required class="mt-1 block w-full border-red-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-delete-modal-btn" class="modal-button-secondary">Annulla</button>
                        <button type="submit" id="confirm-delete-btn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-md flex items-center">
                            CONFERMA ELIMINAZIONE DATI
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- ========================================================================= -->
    <!-- LOGICA JAVASCRIPT E FIREBASE (Modulo Unico) -->
    <!-- ========================================================================= -->
    <script type="module">
        // =========================================================================
        // üìö IMPORTAZIONI FIREBASE
        // =========================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, addDoc, onSnapshot, serverTimestamp, 
            deleteDoc, getDocs, doc, setLogLevel, writeBatch, runTransaction, where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Impostiamo il livello di log per il debug (opzionale)
        setLogLevel('error');
        
        // =========================================================================
        // ‚öôÔ∏è CONFIGURAZIONE FIREBASE E VARIABILI DI STATO
        // =========================================================================
        
        // CONFIGURAZIONE GLOBALE/FALLBACK (per ambiente Canvas)
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const canvasAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Configurazione di fallback se i globali non sono presenti (come nel codice fornito dall'utente)
        const fallbackConfig = {
            apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
            authDomain: "progetto-63fb3.firebaseapp.com",
            projectId: "progetto-63fb3", 
            storageBucket: "progetto-63fb3.firebasestorage.app",
            messagingSenderId: "883088850197",
            appId: "1:883088850197:web:29b8573ea43555041b3d1c",
            measurementId: "G-2PNR8PQHDR"
        };

        const firebaseConfig = Object.keys(canvasFirebaseConfig).length > 0 ? canvasFirebaseConfig : fallbackConfig;
        const PROJECT_ID_AS_APP_ID = canvasAppId === 'default-app-id' ? firebaseConfig.projectId : canvasAppId;
        
        // Variabili Firebase e Stato Globale
        let db = null;
        let auth = null;
        let userId = null;
        let isDocente = false; 
        
        const MAX_SLOTS = 4; // Posti fissi per ogni slot data/corso UNICO (incluso l'orario)
        let currentBookings = []; 
        let currentCancellations = [];
        let currentAvailability = {}; 
        let currentCourseId = null; 
        
        // Credenziali Docente Fisse (Utilizzate solo per la simulazione di login)
        const DOCENTE_USERNAME = 'docente';
        const DOCENTE_PASSWORD = 'its2025';

        const BOOKINGS_COLLECTION_PATH = `/artifacts/${PROJECT_ID_AS_APP_ID}/public/data/bookings`;
        const CANCELLATIONS_COLLECTION_PATH = `/artifacts/${PROJECT_ID_AS_APP_ID}/public/data/cancellations`;
        
        // Struttura fissa dei corsi
        const COURSES = [
            { id: 'SA', name: 'Liceo Scientifico Opzione Scienze Applicate', color: 'bg-red-100 text-red-800', icon: '<svg class="w-8 h-8 text-red-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2zM9 8h6M9 12h6M9 16h6"></path></svg>', dates: [ '2025-11-03|Luned√¨|11:50-13:50', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|11:50-13:50', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|11:50-13:50', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|11:50-13:50', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|11:50-13:50', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|11:50-13:50', '2025-12-15|Luned√¨|11:50-13:50', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'SM', name: 'Sistema Moda', color: 'bg-purple-100 text-purple-800', icon: '<svg class="w-8 h-8 text-purple-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13v8a1 1 0 001 1h8a1 1 0 001-1v-8m-7 0H7m0 0l-1-2m1 2l1-2m7 2h-4m-4 0l-1-2m1 2l1-2m-1 2H7"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'RM', name: 'Relazioni Internazionali per il Marketing', color: 'bg-blue-100 text-blue-800', icon: '<svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v5m0 0a2 2 0 100 4 2 2 0 000-4zM12 8V6a2 2 0 100-4 2 2 0 000 4z"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'LG', name: 'Logistica Corso Quadriennale', color: 'bg-green-100 text-green-800', icon: '<svg class="w-8 h-8 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-4 4m0 0l-4-4m4 4V7"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] },
            { id: 'CT', name: 'Costruzione Ambiente e Territorio', color: 'bg-orange-100 text-orange-800', icon: '<svg class="w-8 h-8 text-orange-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', dates: [ '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50' ] }
        ];

        // Elementi DOM
        const coursesContainer = document.getElementById('courses-container');
        const messageBox = document.getElementById('message-box');
        const bookingModal = document.getElementById('booking-modal');
        const cancellationModal = document.getElementById('cancellation-modal');
        const bookingForm = document.getElementById('booking-form');
        const cancellationForm = document.getElementById('cancellation-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingStatus = document.getElementById('loading-status');
        const docenteLoginModal = document.getElementById('docente-login-modal');
        const docenteLoginForm = document.getElementById('docente-login-form');
        const studentMainView = document.getElementById('student-main-view');
        const docenteView = document.getElementById('docente-view');
        const dateFilter = document.getElementById('date-filter');
        const deleteDataModal = document.getElementById('delete-data-modal');
        const docenteDeleteForm = document.getElementById('docente-delete-form');
        const courseSelectionView = document.getElementById('course-selection-view');
        const dateSelectionView = document.getElementById('date-selection-view');
        const selectedCourseTitle = document.getElementById('selected-course-title');
        const datesContainer = document.getElementById('dates-container');
        const backToCoursesBtn = document.getElementById('back-to-courses-btn');
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentBookings = document.getElementById('content-bookings');
        const contentCancellations = document.getElementById('content-cancellations');

        // =========================================================================
        // üõ† UTILITY
        // =========================================================================

        /** Genera un codice alfanumerico univoco di 10 caratteri. */
        function generateBookingCode() {
            return Math.random().toString(36).substring(2, 12).toUpperCase();
        }

        /** Funzione per mostrare messaggi (Snackbar-like) */
        function showMessage(message, type = 'success') {
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            messageBox.className = `fixed top-5 right-5 p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 ${colors[type]}`;
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
            messageBox.classList.remove('opacity-0');
        }

        /** Formatta la data Firestore in un formato leggibile */
        function formatFirestoreTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Navigazione tra le viste (Docente/Studente)
         * @param {boolean} isDocenteView 
         */
        function showView(isDocenteView) {
            loadingSpinner.classList.add('hidden');
            if (isDocenteView) {
                studentMainView.classList.add('hidden');
                docenteView.classList.remove('hidden');
                document.getElementById('open-docente-login-btn').classList.add('hidden');
                document.getElementById('logout-docente-btn').classList.remove('hidden');
            } else {
                studentMainView.classList.remove('hidden');
                docenteView.classList.add('hidden');
                document.getElementById('open-docente-login-btn').classList.remove('hidden');
                document.getElementById('logout-docente-btn').classList.add('hidden');
                // Mostra sempre la selezione corsi inizialmente
                courseSelectionView.classList.remove('hidden');
                dateSelectionView.classList.add('hidden');
            }
        }

        /** Estrae i dati di un corso specifico */
        function getCourseData(courseId) {
            return COURSES.find(c => c.id === courseId);
        }

        /** Restituisce l'array di date/orari per un dato corso */
        function getDatesForCourse(courseId) {
            const course = getCourseData(courseId);
            return course ? course.dates : [];
        }

        /** Esegue il re-rendering dei dati docente */
        function refreshDocenteView() {
            renderBookingsTable(currentBookings);
            renderCancellationsTable(currentCancellations);
            updateDateFilterOptions(currentBookings);
        }

        // =========================================================================
        // üîê GESTIONE AUTENTICAZIONE E INIZIALIZZAZIONE
        // =========================================================================

        /** Inizializza Firebase e l'Autenticazione */
        async function initFirebase() {
            loadingStatus.textContent = "Inizializzazione App...";
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Imposta la persistenza a livello di sessione (logout al cambio tab/chiusura)
                await setPersistence(auth, browserSessionPersistence);

                loadingStatus.textContent = "Autenticazione in corso...";
                
                // Autenticazione con token personalizzato o anonima
                if (canvasAuthToken) {
                    await signInWithCustomToken(auth, canvasAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener per lo stato di autenticazione
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Controlla se l'utente √® un docente (tramite variabile di sessione/stato)
                        if (sessionStorage.getItem('isDocente') === 'true') {
                            isDocente = true;
                            showView(true);
                            startDocenteListeners();
                        } else {
                            isDocente = false;
                            showView(false);
                            startStudentListener();
                        }
                    } else {
                        userId = null;
                        isDocente = false;
                        sessionStorage.removeItem('isDocente');
                        showView(false);
                        // Riavvia l'ascolto per la vista studente se si √® disconnessi
                        startStudentListener();
                    }
                });

                loadingStatus.textContent = "Caricamento dati...";

            } catch (error) {
                console.error("Errore fatale di inizializzazione Firebase:", error);
                loadingStatus.textContent = "Errore di caricamento. Riprova pi√π tardi.";
                showMessage("Impossibile connettersi al database.", 'error');
            }
        }

        // =========================================================================
        // üîÑ LISTENER FIREBASE (VISTA STUDENTE)
        // =========================================================================

        /** Listener per le prenotazioni (vista studente) e calcolo disponibilit√†. */
        function startStudentListener() {
            const q = query(collection(db, BOOKINGS_COLLECTION_PATH));
            
            onSnapshot(q, (snapshot) => {
                currentBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Aggiornamento chiave di disponibilit√†: usa l'ID del corso + la stringa intera data|giorno|orario
                currentAvailability = currentBookings.reduce((acc, booking) => {
                    const uniqueKey = `${booking.courseId}_${booking.date}`; 
                    acc[uniqueKey] = (acc[uniqueKey] || 0) + 1;
                    return acc;
                }, {});

                renderCourses(currentAvailability);
                
                // Se lo studente era nella vista date, ricarica le date per mostrare l'aggiornamento
                if (currentCourseId && !dateSelectionView.classList.contains('hidden')) {
                    renderDates(currentCourseId);
                }
            }, (error) => {
                console.error("Errore in onSnapshot (Student):", error);
                showMessage("Errore di connessione ai dati di prenotazione.", 'error');
            });
        }

        // =========================================================================
        // üßë‚Äçüíª RENDER VISTA STUDENTE
        // =========================================================================

        /** Renderizza le schede dei corsi */
        function renderCourses(availability) {
            coursesContainer.innerHTML = '';
            
            COURSES.forEach(course => {
                // Calcola i posti totali disponibili tra tutte le date/ore del corso
                const totalSlots = course.dates.length * MAX_SLOTS;
                let totalBooked = 0;
                
                course.dates.forEach(dateStr => {
                    const uniqueKey = `${course.id}_${dateStr}`;
                    totalBooked += availability[uniqueKey] || 0;
                });

                const totalAvailable = totalSlots - totalBooked;

                const cardHtml = `
                    <div class="${course.color} p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col justify-between h-full cursor-pointer course-card" data-course-id="${course.id}">
                        <div>
                            ${course.icon}
                            <h3 class="text-xl font-bold mb-2">${course.name}</h3>
                            <p class="text-sm text-gray-700">Durata: 2 ore</p>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-300">
                            <p class="text-sm font-semibold">Posti Disponibili: <span class="text-xl font-extrabold text-indigo-700">${totalAvailable}</span> / ${totalSlots} totali</p>
                        </div>
                    </div>
                `;
                coursesContainer.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Aggiunge listener per il click sul corso
            document.querySelectorAll('.course-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const courseId = e.currentTarget.dataset.courseId;
                    currentCourseId = courseId;
                    renderDates(courseId);
                    courseSelectionView.classList.add('hidden');
                    dateSelectionView.classList.remove('hidden');
                });
            });
        }
        
        /** Renderizza le schede data/orario per il corso selezionato */
        function renderDates(courseId) {
            datesContainer.innerHTML = '';
            const course = getCourseData(courseId);
            if (!course) return;

            selectedCourseTitle.textContent = course.name;

            course.dates.forEach(dateStr => {
                const [date, day, time] = dateStr.split('|');
                const uniqueKey = `${courseId}_${dateStr}`;
                const bookedCount = currentAvailability[uniqueKey] || 0;
                const availableCount = MAX_SLOTS - bookedCount;
                const isFull = availableCount <= 0;

                const formattedDate = new Date(date).toLocaleDateString('it-IT', { day: '2-digit', month: 'long' });

                const cardHtml = `
                    <div class="date-card ${isFull ? 'bg-gray-200 opacity-60 cursor-not-allowed' : 'bg-white shadow-xl hover:shadow-indigo-300'} p-4 rounded-xl border-l-4 ${isFull ? 'border-gray-500' : 'border-indigo-600'}"
                         data-course-id="${courseId}"
                         data-date-str="${dateStr}"
                         ${isFull ? 'disabled' : ''}>
                        <p class="text-xs font-medium text-gray-500 uppercase">${day}, ${formattedDate}</p>
                        <p class="text-2xl font-extrabold text-gray-800 my-1">${time}</p>
                        <p class="text-sm ${isFull ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'}">
                            ${isFull ? 'Posti Esauriti' : `${availableCount} Posti Disponibili`}
                        </p>
                        ${isFull ? '' : '<button class="mt-2 w-full text-sm py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">Prenota Ora</button>'}
                    </div>
                `;
                datesContainer.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Aggiunge listener ai bottoni Prenota/schede (se non esaurite)
            document.querySelectorAll('.date-card').forEach(card => {
                if (!card.hasAttribute('disabled')) {
                    card.addEventListener('click', (e) => {
                        const courseId = card.dataset.courseId;
                        const dateStr = card.dataset.dateStr;
                        openBookingModal(courseId, dateStr);
                    });
                }
            });
        }

        // =========================================================================
        // üì• MODALI E FORM DI PRENOTAZIONE (STUDENTE)
        // =========================================================================

        /** Apre la modale di prenotazione */
        function openBookingModal(courseId, dateStr) {
            const course = getCourseData(courseId);
            const [date, day, time] = dateStr.split('|');
            const formattedDate = new Date(date).toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long' });
            
            document.getElementById('modal-course-name').textContent = course.name;
            document.getElementById('modal-date').textContent = `${formattedDate} (${time})`;
            document.getElementById('booking-course-id').value = courseId;
            document.getElementById('booking-date').value = dateStr; // Salva la stringa completa (data|giorno|orario)
            
            bookingModal.classList.remove('hidden');
        }

        /** Gestisce l'invio del form di prenotazione (Transazione Atomica) */
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const courseId = form.elements['booking-course-id'].value;
            const dateStr = form.elements['booking-date'].value; // Stringa completa (chiave univoca)
            const studentName = form.elements['student-name'].value.trim();
            const studentSchool = form.elements['student-school'].value.trim();
            const studentEmail = form.elements['student-email'].value.trim();
            const studentPhone = form.elements['student-phone'].value.trim();
            const submitBtn = document.getElementById('confirm-booking-btn');

            if (!courseId || !dateStr || !studentName || !studentSchool || !studentEmail || !studentPhone) {
                showMessage("Per favore, compila tutti i campi obbligatori.", 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner border-t-white border-t-2"></div>';

            const uniqueKey = `${courseId}_${dateStr}`;

            try {
                // Esecuzione della transazione atomica
                await runTransaction(db, async (transaction) => {
                    const q = query(collection(db, BOOKINGS_COLLECTION_PATH), where('uniqueKey', '==', uniqueKey));
                    const querySnapshot = await transaction.get(q);

                    const currentCount = querySnapshot.size;

                    if (currentCount >= MAX_SLOTS) {
                        throw new Error("Posti esauriti per questo slot. Riprova con un'altra data.");
                    }
                    
                    const newBookingCode = generateBookingCode();
                    const newBookingRef = doc(collection(db, BOOKINGS_COLLECTION_PATH));
                    
                    const newBooking = {
                        code: newBookingCode,
                        studentName,
                        studentSchool,
                        studentEmail,
                        studentPhone,
                        courseId,
                        date: dateStr, // Salva la stringa completa come dato
                        uniqueKey: uniqueKey, // Chiave per le query future
                        timestamp: serverTimestamp(),
                        userId: userId, // ID utente anonimo/autenticato per tracciamento
                    };

                    transaction.set(newBookingRef, newBooking);

                    // Dopo la transazione, genera il PDF di conferma
                    generateConfirmationPDF(newBooking);
                    
                    showMessage("Prenotazione confermata e PDF generato!", 'success');
                    form.reset();
                    bookingModal.classList.add('hidden');
                });

            } catch (error) {
                console.error("Errore durante la prenotazione:", error);
                const errorMessage = error.message.includes("Posti esauriti") 
                    ? error.message 
                    : "Errore durante la conferma della prenotazione. Riprova.";
                showMessage(errorMessage, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Conferma e Genera PDF';
            }
        });

        document.getElementById('close-modal-btn').addEventListener('click', () => {
            bookingModal.classList.add('hidden');
            bookingForm.reset();
        });

        // =========================================================================
        // üóë ANNULLAMENTO PRENOTAZIONE (STUDENTE)
        // =========================================================================

        document.getElementById('open-cancellation-modal-btn').addEventListener('click', () => {
            cancellationModal.classList.remove('hidden');
        });

        document.getElementById('close-cancellation-modal-btn').addEventListener('click', () => {
            cancellationModal.classList.add('hidden');
            cancellationForm.reset();
        });

        cancellationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('cancellation-code').value.trim().toUpperCase();
            const reason = document.getElementById('cancellation-reason').value.trim();
            const submitBtn = document.getElementById('confirm-cancellation-btn');

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner border-t-white border-t-2"></div>';

            try {
                const q = query(collection(db, BOOKINGS_COLLECTION_PATH), where('code', '==', code));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showMessage("Codice di prenotazione non trovato.", 'error');
                    return;
                }

                const bookingDoc = snapshot.docs[0];
                const bookingData = bookingDoc.data();
                
                // 1. Elimina la prenotazione dalla collection "bookings"
                await deleteDoc(doc(db, BOOKINGS_COLLECTION_PATH, bookingDoc.id));

                // 2. Aggiungi il log di annullamento a "cancellations"
                await addDoc(collection(db, CANCELLATIONS_COLLECTION_PATH), {
                    ...bookingData, // Salva tutti i dati della prenotazione originale
                    cancelledAt: serverTimestamp(),
                    cancellationReason: reason || 'Non specificato',
                    originalBookingId: bookingDoc.id
                });
                
                showMessage(`Prenotazione ${code} annullata con successo. Il posto √® stato liberato.`, 'success');
                cancellationModal.classList.add('hidden');
                cancellationForm.reset();

            } catch (error) {
                console.error("Errore durante l'annullamento:", error);
                showMessage("Errore durante l'annullamento. Riprova.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Annulla la mia Prenotazione';
            }
        });

        // =========================================================================
        // üìÑ GENERAZIONE PDF (jsPDF)
        // =========================================================================

        /** Genera e scarica il PDF di conferma */
        function generateConfirmationPDF(booking) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const course = getCourseData(booking.courseId);
            const [date, day, time] = booking.date.split('|');
            const formattedDate = new Date(date).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });

            // Variabili di Stile
            const primaryColor = '#4f46e5'; // Indigo-600
            let y = 10;
            const lineHeight = 8;
            const margin = 20;

            // Titolo e Logo (Semplificato)
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(22);
            doc.setTextColor(primaryColor);
            doc.text("ITSCG PRIMO LEVI", margin, y);
            y += lineHeight;
            doc.setFontSize(14);
            doc.text("Conferma Prenotazione Ministage Orientamento", margin, y);
            y += lineHeight * 2;

            // Dettagli Prenotazione
            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(50); // Grigio scuro

            doc.text("CODICE DI PRENOTAZIONE OBBLIGATORIO:", margin, y);
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(18);
            doc.text(booking.code, margin + 80, y, { align: 'center' }); // Centrato per evidenza
            y += lineHeight * 2;

            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(50);

            // Tabella Dati
            doc.autoTable({
                startY: y,
                head: [['Dettaglio', 'Valore']],
                body: [
                    ['Studente:', booking.studentName],
                    ['Corso Selezionato:', course.name],
                    ['Data:', `${day}, ${formattedDate}`],
                    ['Orario Stage:', time],
                    ['Scuola Media:', booking.studentSchool],
                    ['Contatto Email:', booking.studentEmail],
                    ['Contatto Cellulare:', booking.studentPhone],
                ],
                theme: 'striped',
                headStyles: { fillColor: primaryColor },
                styles: { font: 'Helvetica', fontSize: 10, cellPadding: 3 },
                margin: { left: margin, right: margin }
            });

            y = doc.autoTable.previous.finalY + 10;

            // Note Importanti
            doc.setFontSize(12);
            doc.setFont('Helvetica', 'bold');
            doc.setTextColor('#dc2626'); // Rosso
            doc.text("NOTA BENE:", margin, y);
            y += lineHeight;

            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(50);
            doc.text("1. Questo documento √® la conferma ufficiale della tua prenotazione e **DEVE** essere presentato all'ingresso.", margin, y);
            y += lineHeight * 0.7;
            doc.text("2. Presentarsi con almeno 10 minuti di anticipo all'orario indicato.", margin, y);
            y += lineHeight * 0.7;
            doc.text("3. In caso di annullamento, utilizza il codice di prenotazione sul sito.", margin, y);
            y += lineHeight * 2;

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text("ITSCG 'Primo Levi' di Seregno, Via Briantina 68 | Tel: 0362 237250", 105, 290, { align: 'center' });

            doc.save(`Conferma_Ministage_${booking.code}.pdf`);
        }

        // =========================================================================
        // üîí GESTIONE DOCENTE
        // =========================================================================

        document.getElementById('open-docente-login-btn').addEventListener('click', () => {
            docenteLoginModal.classList.remove('hidden');
        });

        document.getElementById('logout-docente-btn').addEventListener('click', () => {
            sessionStorage.removeItem('isDocente');
            isDocente = false;
            showView(false);
            showMessage("Logout effettuato con successo.", 'info');
        });
        
        /** Gestione Login Docente (Simulato) */
        docenteLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('docente-username').value;
            const password = document.getElementById('docente-password').value;

            if (username === DOCENTE_USERNAME && password === DOCENTE_PASSWORD) {
                sessionStorage.setItem('isDocente', 'true'); // Stato mantenuto nella sessione
                isDocente = true;
                docenteLoginModal.classList.add('hidden');
                docenteLoginForm.reset();
                showView(true);
                showMessage("Accesso Docente riuscito!", 'success');
                // I listener per il docente vengono avviati nell'onAuthStateChanged dopo il set item
                startDocenteListeners();
            } else {
                showMessage("Credenziali Docente non valide.", 'error');
            }
        });

        /** Listener per i dati Docente (Prenotazioni e Annullamenti) */
        function startDocenteListeners() {
            if (!db || !isDocente) return;
            
            // 1. Prenotazioni Attive
            onSnapshot(collection(db, BOOKINGS_COLLECTION_PATH), (snapshot) => {
                currentBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                refreshDocenteView();
            }, (error) => {
                console.error("Errore in onSnapshot (Bookings):", error);
            });

            // 2. Log Annullamenti
            onSnapshot(collection(db, CANCELLATIONS_COLLECTION_PATH), (snapshot) => {
                currentCancellations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                refreshDocenteView();
            }, (error) => {
                console.error("Errore in onSnapshot (Cancellations):", error);
            });
        }

        // =========================================================================
        // üìä RENDER VISTA DOCENTE
        // =========================================================================

        /** Renderizza la tabella delle prenotazioni attive */
        function renderBookingsTable(bookings) {
            const tbody = document.getElementById('bookings-table-body');
            tbody.innerHTML = '';
            const noBookingsMessage = document.getElementById('no-bookings-message');
            
            const selectedDateFilter = dateFilter.value;

            let filteredBookings = bookings;
            if (selectedDateFilter && selectedDateFilter !== 'all') {
                 // Filtra per la data YYYY-MM-DD
                filteredBookings = bookings.filter(b => b.date.startsWith(selectedDateFilter));
            }

            if (filteredBookings.length === 0) {
                noBookingsMessage.classList.remove('hidden');
                return;
            }
            noBookingsMessage.classList.add('hidden');

            // Ordina per data e orario (solo la parte di stringa)
            filteredBookings.sort((a, b) => {
                return a.date.localeCompare(b.date);
            });


            filteredBookings.forEach(booking => {
                const course = getCourseData(booking.courseId);
                const [date, day, time] = booking.date.split('|'); // Estrazione per visualizzazione
                
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';
                
                row.insertCell().textContent = booking.code;
                row.insertCell().textContent = booking.studentName;
                row.insertCell().textContent = course ? course.name : 'N/D';
                row.insertCell().textContent = `${day}, ${new Date(date).toLocaleDateString('it-IT')}`; // Data + Giorno
                row.insertCell().textContent = time; // Orario in colonna separata
                row.insertCell().textContent = booking.studentSchool;
                row.insertCell().innerHTML = `<span class="text-xs">${booking.studentEmail}<br/>${booking.studentPhone}</span>`;
                row.insertCell().textContent = formatFirestoreTimestamp(booking.timestamp);
            });
        }

        /** Renderizza la tabella dei log di annullamento */
        function renderCancellationsTable(cancellations) {
            const tbody = document.getElementById('cancellations-table-body');
            tbody.innerHTML = '';
            const noCancellationsMessage = document.getElementById('no-cancellations-message');

            if (cancellations.length === 0) {
                noCancellationsMessage.classList.remove('hidden');
                return;
            }
            noCancellationsMessage.classList.add('hidden');

            // Ordina per data di annullamento
            cancellations.sort((a, b) => b.cancelledAt.toMillis() - a.cancelledAt.toMillis());

            cancellations.forEach(log => {
                const course = getCourseData(log.courseId);
                const row = tbody.insertRow();
                row.className = 'hover:bg-red-50/50';

                row.insertCell().textContent = log.code;
                row.insertCell().textContent = log.studentName;
                row.insertCell().textContent = course ? course.name : 'N/D';
                row.insertCell().textContent = log.date.replace(/\|/g, ', '); // Data|Giorno|Orario
                row.insertCell().textContent = formatFirestoreTimestamp(log.cancelledAt);
                row.insertCell().textContent = log.cancellationReason;
            });
        }

        /** Aggiorna il filtro data per la dashboard docente */
        function updateDateFilterOptions(bookings) {
            const dates = new Set();
            bookings.forEach(b => {
                // Filtriamo solo per la data YYYY-MM-DD (non per l'orario)
                dates.add(b.date.split('|')[0]);
            });

            const sortedDates = Array.from(dates).sort();
            
            dateFilter.innerHTML = '<option value="all">Tutte le Date/Ore</option>';

            sortedDates.forEach(date => {
                const formattedDate = new Date(date).toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: 'short' });
                const option = document.createElement('option');
                option.value = date;
                option.textContent = formattedDate;
                dateFilter.appendChild(option);
            });
        }
        
        // =========================================================================
        // üñ± EVENTI VISTA DOCENTE
        // =========================================================================

        dateFilter.addEventListener('change', () => {
            renderBookingsTable(currentBookings);
        });

        // Gestione Tabs
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                button.classList.add('tab-active');
                
                contentBookings.classList.add('hidden');
                contentCancellations.classList.add('hidden');

                if (button.id === 'tab-bookings') {
                    contentBookings.classList.remove('hidden');
                } else if (button.id === 'tab-cancellations') {
                    contentCancellations.classList.remove('hidden');
                }
            });
        });
        document.getElementById('tab-bookings').classList.add('tab-active'); // Default active tab


        // Esporta in CSV
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            const table = document.getElementById('bookings-table-body');
            let csv = 'Codice,Studente,Corso,Data,Giorno,Orario,Scuola Media,Email,Cellulare,Iscritto il\n';
            
            table.querySelectorAll('tr').forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length > 0) {
                    const code = cols[0].textContent;
                    const studentName = cols[1].textContent;
                    const courseName = cols[2].textContent;
                    const dateDay = cols[3].textContent.split(', ');
                    const date = dateDay[1] || '';
                    const day = dateDay[0] || '';
                    const time = cols[4].textContent;
                    const school = cols[5].textContent;
                    const contact = cols[6].textContent.split('\n');
                    const email = contact[0].trim();
                    const phone = contact[1] ? contact[1].trim() : '';
                    const timestamp = cols[7].textContent;

                    csv += `"${code}","${studentName}","${courseName}","${date}","${day}","${time}","${school}","${email}","${phone}","${timestamp}"\n`;
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'Prenotazioni_Ministage_ITSCG.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("Dati prenotazioni esportati in CSV.", 'info');
        });

        // Reset Dati (Docente)
        document.getElementById('open-delete-modal-btn').addEventListener('click', () => {
            deleteDataModal.classList.remove('hidden');
        });
        
        document.getElementById('close-delete-modal-btn').addEventListener('click', () => {
            deleteDataModal.classList.add('hidden');
            docenteDeleteForm.reset();
        });

        docenteDeleteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('docente-delete-password').value;
            if (password !== DOCENTE_PASSWORD) {
                showMessage("Password non corretta. Riprova.", 'error');
                return;
            }

            const submitBtn = document.getElementById('confirm-delete-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner border-t-white border-t-2"></div>';

            try {
                // Elimina tutte le prenotazioni
                const bookingSnapshot = await getDocs(collection(db, BOOKINGS_COLLECTION_PATH));
                const bookingBatch = writeBatch(db);
                bookingSnapshot.docs.forEach((doc) => {
                    bookingBatch.delete(doc.ref);
                });
                await bookingBatch.commit();
                
                // Elimina tutti i log di annullamento
                const cancelSnapshot = await getDocs(collection(db, CANCELLATIONS_COLLECTION_PATH));
                const cancelBatch = writeBatch(db);
                cancelSnapshot.docs.forEach((doc) => {
                    cancelBatch.delete(doc.ref);
                });
                await cancelBatch.commit();

                showMessage("Tutti i dati (prenotazioni e log) sono stati eliminati con successo.", 'success');
                deleteDataModal.classList.add('hidden');
                docenteDeleteForm.reset();

            } catch (error) {
                console.error("Errore durante l'eliminazione completa dei dati:", error);
                showMessage("Errore durante l'eliminazione dei dati. Controlla i log.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'CONFERMA ELIMINAZIONE DATI';
            }
        });

        // =========================================================================
        // üöÄ INIZIALIZZAZIONE
        // =========================================================================
        
        backToCoursesBtn.addEventListener('click', () => {
            dateSelectionView.classList.add('hidden');
            courseSelectionView.classList.remove('hidden');
            currentCourseId = null;
        });

        // Avvia l'app al caricamento
        window.onload = initFirebase;

    </script>
</body>
</html>
