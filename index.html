<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITSCG Primo Levi - Prenotazione Ministage</title>
    <!-- Caricamento Tailwind CSS per lo stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stili personalizzati per la visibilit√† */
        [data-view]:not(.active) { display: none; }
        
        /* Stile di base per il corpo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }

        /* Stile per l'area docenti */
        .admin-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }

        /* Colori principali */
        .primary-color { background-color: #1e40af; } /* Blu scuro */
        .secondary-color { background-color: #60a5fa; } /* Blu chiaro */
        .danger-color { background-color: #dc2626; } /* Rosso */
    </style>
    <!-- Inclusione delle librerie Firebase e jsPDF -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, arrayUnion, getDocs, limit, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // Variabili globali per Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        try {
            const configString = typeof __firebase_config !== 'undefined' && __firebase_config !== 'null' ? __firebase_config : 
                JSON.stringify({
                    apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
                    authDomain: "progetto-63fb3.firebaseapp.com",
                    projectId: "progetto-63fb3",
                    storageBucket: "progetto-63fb3.firebasestorage.app",
                    messagingSenderId: "883088850197",
                    appId: "1:883088850197:web:29b8573ea43555041b3d1c",
                    measurementId: "G-2PNR8PQHDR"
                });
            firebaseConfig = JSON.parse(configString);
        } catch (e) {
            console.error("Errore nel parsing di __firebase_config:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let allBookings = []; // Array per memorizzare tutte le prenotazioni
        const MAX_CAPACITY = 4;
        const BOOKINGS_COLLECTION = `artifacts/${appId}/public/data/prenotazioni`;
        
        // Nuove credenziali per l'Area Docenti
        const ADMIN_USERNAME = 'docente'; 
        const ADMIN_PASSCODE = 'PRIMOLEVI2025'; 

        const INDIRIZZI = [
            { id: 'lsoa', nome: 'Liceo Scientifico Opzione Scienze Applicate' },
            { id: 'lcq', nome: 'Logistica Corso Quadriennale' },
            { id: 'cat', nome: 'Costruzione Ambiente e Territorio' },
            { id: 'rim', nome: 'Relazioni Internazionali per il Marketing' },
            { id: 'sm', nome: 'Sistema Moda' }
        ];

        // Definizione degli slot disponibili (usando 2025 per coerenza logica)
        const SLOTS = [
            // Luned√¨ 12:50-14:40
            { giorno: 'Luned√¨', ora: '12:50-14:40', dates: ['2025-11-03', '2025-11-10', '2025-11-17', '2025-11-24', '2025-12-01', '2025-12-08', '2025-12-15'] },
            // Mercoled√¨ 8:50-10:50
            { giorno: 'Mercoled√¨', ora: '08:50-10:50', dates: ['2025-11-05', '2025-11-12', '2025-11-19', '2025-11-26', '2025-12-03', '2025-12-10', '2025-12-17'] }
        ];

        // Mappa per formattare la data
        const DATE_FORMATTER = new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: '2-digit' });
        
        // Crea una lista piatta e ordinata di tutti gli slot data/ora
        let ALL_SLOTS = [];
        SLOTS.forEach(slot => {
            slot.dates.forEach(date => {
                ALL_SLOTS.push({
                    giorno: slot.giorno,
                    ora: slot.ora,
                    date: date,
                    dateFormatted: DATE_FORMATTER.format(new Date(date)),
                    // Utilizza un timestamp per l'ordinamento
                    timestamp: new Date(`${date} ${slot.ora.split('-')[0]}`).getTime() 
                });
            });
        });
        // Ordina cronologicamente
        ALL_SLOTS.sort((a, b) => a.timestamp - b.timestamp);


        // --- Funzioni Utilit√† e Stato ---

        function updateStatus(type, message, color) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `px-3 py-1 text-xs font-semibold rounded-full ${color}`;
            statusEl.textContent = message;
        }

        function generateUniqueCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function showView(viewId) {
            document.querySelectorAll('[data-view]').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0, 0); 
        }

        function showMessage(type, message) {
            const messageBox = document.getElementById('message-box');
            let colorClass = '';
            switch (type) {
                case 'success':
                    colorClass = 'bg-green-100 border-green-400 text-green-700';
                    break;
                case 'error':
                    colorClass = 'bg-red-100 border-red-400 text-red-700';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-blue-100 border-blue-400 text-blue-700';
                    break;
            }
            messageBox.className = `p-4 border rounded-lg mb-4 ${colorClass}`;
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // --- Logica PDF (jsPDF) ---
        
        let jsPDFLoaded = false;
        const loadJsPDF = () => {
             const script = document.createElement('script');
             script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
             script.onload = () => {
                 jsPDFLoaded = true;
                 console.log("jsPDF caricato con successo.");
             };
             document.head.appendChild(script);
        };
        loadJsPDF();

        function createAndDownloadPDF(type, bookingData) {
            if (!jsPDFLoaded) {
                showMessage('error', 'Libreria PDF non ancora caricata. Riprova tra qualche istante.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const title = type === 'CONFERMA' ? 'CONFERMA PRENOTAZIONE MINISTAGE' : 'CONFERMA CANCELLAZIONE MINISTAGE';
            const color = type === 'CONFERMA' ? '#1e40af' : '#b91c1c'; // Blu o Rosso

            try {
                doc.setFont('Helvetica', 'Bold');
                doc.setFontSize(18);
                doc.setTextColor(color);
                doc.text(title, 105, 20, null, null, 'center');
                
                doc.line(20, 25, 190, 25); // Linea divisoria

                doc.setFont('Helvetica', 'Normal');
                doc.setFontSize(12);
                doc.setTextColor('#000000');
                
                let y = 35;

                const fields = [
                    { label: 'STATO:', value: type === 'CONFERMA' ? 'PRENOTAZIONE CONFERMATA' : 'PRENOTAZIONE CANCELLATA', color: color },
                    { label: 'CODICE PRENOTAZIONE:', value: bookingData.codice_prenotazione, color: color },
                    { label: 'STUDENTE:', value: bookingData.nome_studente || 'N/A' },
                    { label: 'EMAIL:', value: bookingData.email || 'N/A' },
                    { label: 'CELLULARE:', value: bookingData.cellulare || 'N/A' },
                    { label: 'SCUOLA PROVENIENZA:', value: bookingData.scuola_provenienza || 'N/A' },
                    { label: 'INDIRIZZO SCELTO:', value: INDIRIZZI.find(i => i.id === bookingData.indirizzo_id)?.nome || bookingData.indirizzo_nome },
                    { label: 'DATA STAGE:', value: bookingData.data_formattata },
                    { label: 'ORA:', value: bookingData.ora },
                    { label: 'GENERATO IL:', value: new Date().toLocaleString('it-IT') }
                ];

                fields.forEach(field => {
                    doc.setFont('Helvetica', 'Bold');
                    doc.setTextColor('#000000');
                    doc.text(field.label, 20, y);
                    doc.setFont('Helvetica', 'Normal');
                    doc.setTextColor(field.color || '#374151');
                    doc.text(field.value, 190, y, null, null, 'right');
                    y += 8;
                });
                
                y += 10;
                doc.setFont('Helvetica', 'Oblique');
                doc.setTextColor('#555555');
                doc.text("‚ö†Ô∏è √à fondamentale conservare questo documento e presentarlo all'ingresso il giorno dello Stage. ‚ö†Ô∏è", 105, y, null, null, 'center');

                doc.save(`${type.toLowerCase()}_${bookingData.codice_prenotazione}.pdf`);
                showMessage('success', `PDF di ${type.toLowerCase()} generato e scaricato! Controlla la cartella download.`);
            } catch(e) {
                console.error("Errore durante la generazione del PDF:", e);
                showMessage('error', 'Errore nella generazione del PDF. Controlla la console.');
            }
        }

        // --- Logica Firebase e Dati ---

        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                updateStatus('error', 'DB DISCONNESSO (CONFIG ERROE)', 'bg-red-500 text-white');
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                updateStatus('info', 'DB in connessione...', 'bg-yellow-500 text-white');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('current-user-id-display').textContent = userId;
                updateStatus('success', 'DB CONNESSO e Funzionante', 'bg-green-500 text-white');
                
                listenForBookings();

            } catch (error) {
                console.error("Errore nell'inizializzazione o autenticazione di Firebase:", error);
                updateStatus('error', 'DB ERRORE', 'bg-red-500 text-white');
                showMessage('error', 'Errore di connessione al database. Alcune funzionalit√† potrebbero non essere disponibili.');
            }
        }

        function listenForBookings() {
            const q = query(collection(db, BOOKINGS_COLLECTION));
            onSnapshot(q, (snapshot) => {
                allBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const totalCountEl = document.getElementById('total-bookings-count');
                if(totalCountEl) totalCountEl.textContent = allBookings.length;
                
                renderBookingSlots(); 
                if (document.getElementById('admin-view').classList.contains('active')) {
                    renderAdminTable(allBookings);
                }
            }, (error) => {
                console.error("Errore durante l'ascolto delle prenotazioni:", error);
                showMessage('error', 'Errore di sincronizzazione dati in tempo reale.');
            });
        }

        function calculateAvailableSlots(indirizzoId, date, time) {
            const bookedCount = allBookings.filter(b => 
                b.indirizzo_id === indirizzoId && 
                b.data === date && 
                b.ora === time && 
                b.status === 'Confermato'
            ).length;
            return MAX_CAPACITY - bookedCount;
        }

        // --- Logica Rendering ---

        function renderIndirizziList() {
            const container = document.getElementById('indirizzi-list-container');
            container.innerHTML = '';

            INDIRIZZI.forEach(indirizzo => {
                const element = `
                    <div class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 border border-blue-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">${indirizzo.nome}</h3>
                        <p class="text-gray-600 mb-4">Scegli il tuo indirizzo per visualizzare le date e prenotare il tuo Ministage immersivo.</p>
                        <button onclick="showBookingPage('${indirizzo.id}')" 
                                class="w-full primary-color text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                            PRENOTA ORA
                        </button>
                    </div>
                `;
                container.innerHTML += element;
            });
        }
        
        window.showBookingPage = (indirizzoId) => {
            const indirizzo = INDIRIZZI.find(i => i.id === indirizzoId);
            if (!indirizzo) {
                showMessage('error', 'Indirizzo non trovato.');
                showView('home-view');
                return;
            }
            document.getElementById('booking-indirizzo-title').textContent = `Prenotazione Ministage: ${indirizzo.nome}`;
            document.getElementById('booking-indirizzo-id').value = indirizzoId; 
            showView('booking-view');
            renderBookingSlots();
        };

        function renderBookingSlots() {
            const indirizzoId = document.getElementById('booking-indirizzo-id').value;
            if (!indirizzoId) return; 

            const slotsContainer = document.getElementById('slots-container');
            slotsContainer.innerHTML = '';
            
            let htmlContent = '';

            // Utilizziamo la lista di slot ordinata cronologicamente (ALL_SLOTS)
            ALL_SLOTS.forEach(slot => {
                    const available = calculateAvailableSlots(indirizzoId, slot.date, slot.ora);
                    const isFull = available <= 0;
                    
                    htmlContent += `
                        <div class="grid grid-cols-1 md:grid-cols-5 items-center gap-3 p-4 border-b last:border-b-0 ${isFull ? 'bg-red-50' : 'bg-white hover:bg-blue-50'} transition duration-150 rounded-lg">
                            <div class="font-bold text-gray-700">${slot.giorno}</div>
                            <div class="text-lg font-mono text-blue-700">${slot.dateFormatted}</div>
                            <div class="text-sm font-semibold text-gray-600">${slot.ora}</div>
                            <div class="text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${isFull ? 'bg-red-200 text-red-800' : (available <= 2 ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800')}">
                                    ${available} posti liberi (Max: ${MAX_CAPACITY})
                                </span>
                            </div>
                            <button 
                                onclick="openBookingModal('${indirizzoId}', '${slot.date}', '${slot.ora}', '${slot.dateFormatted}')" 
                                ${isFull ? 'disabled' : ''}
                                class="w-full py-2 rounded-lg font-bold text-white transition duration-150 shadow-md 
                                        ${isFull ? 'bg-gray-400 cursor-not-allowed' : 'primary-color hover:bg-blue-700'}">
                                ${isFull ? 'COMPLETO' : 'PRENOTA'}
                            </button>
                        </div>
                    `;
            });

            slotsContainer.innerHTML = htmlContent;
        }


        // --- Logica Modale e Prenotazione ---
        window.openBookingModal = (indirizzoId, date, time, dateFormatted) => {
            document.getElementById('modal-date').textContent = dateFormatted;
            document.getElementById('modal-time').textContent = time;
            document.getElementById('modal-indirizzo-id').value = indirizzoId;
            document.getElementById('modal-date-hidden').value = date;
            document.getElementById('modal-time-hidden').value = time;
            document.getElementById('booking-modal').classList.remove('hidden');
        };

        window.closeBookingModal = () => {
            document.getElementById('booking-modal').classList.add('hidden');
            document.getElementById('booking-form').reset(); 
        };
        
        window.handleBooking = async (event) => {
            event.preventDefault();
            const form = event.target;
            const indirizzoId = form['modal-indirizzo-id'].value;
            const date = form['modal-date-hidden'].value;
            const time = form['modal-time-hidden'].value;
            
            // Nuovi campi
            const nomeStudente = form['nome_studente'].value.trim();
            const email = form['email'].value.trim();
            const cellulare = form['cellulare'].value.trim();
            const scuolaProvenienza = form['scuola_provenienza'].value.trim();
            
            const indirizzoNome = INDIRIZZI.find(i => i.id === indirizzoId)?.nome;
            
            const btn = document.getElementById('confirm-booking-btn');
            btn.disabled = true;
            btn.textContent = 'Prenotazione in corso...';
            
            // Re-check disponibilit√†
            const available = calculateAvailableSlots(indirizzoId, date, time);
            if (available <= 0) {
                showMessage('error', 'Spiacenti, il posto √® appena stato prenotato. Riprova con un altro orario.');
                btn.disabled = false;
                btn.textContent = 'CONFERMA PRENOTAZIONE';
                closeBookingModal();
                return;
            }

            const codicePrenotazione = generateUniqueCode();
            
            const newBooking = {
                indirizzo_id: indirizzoId,
                indirizzo_nome: indirizzoNome,
                data: date,
                data_formattata: DATE_FORMATTER.format(new Date(date)),
                ora: time,
                // Nuovi dati raccolti
                nome_studente: nomeStudente,
                email: email,
                cellulare: cellulare, 
                scuola_provenienza: scuolaProvenienza,
                // Dati di sistema
                codice_prenotazione: codicePrenotazione,
                timestamp: new Date().toISOString(),
                status: 'Confermato',
                user_id: userId 
            };

            try {
                await addDoc(collection(db, BOOKINGS_COLLECTION), newBooking);
                
                showMessage('success', `Prenotazione confermata! Codice: ${codicePrenotazione}.`);
                closeBookingModal();
                
                // Genera PDF di conferma
                createAndDownloadPDF('CONFERMA', newBooking);

                // Mostra la pagina di conferma e il codice (senza pulsante annulla)
                document.getElementById('confirmation-code').textContent = codicePrenotazione;
                showView('confirmation-view');
                
            } catch (error) {
                console.error("Errore durante la prenotazione:", error);
                showMessage('error', 'Errore durante la registrazione della prenotazione. Riprova.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'CONFERMA PRENOTAZIONE';
            }
        };

        // --- Logica Cancellazione ---

        window.handleCancellation = async () => {
             const codice = document.getElementById('cancellation-code').value.trim().toUpperCase();
            if (!codice) {
                showMessage('info', 'Inserisci un codice di prenotazione valido.');
                return;
            }

            const btn = document.getElementById('confirm-cancellation-btn');
            btn.disabled = true;
            btn.textContent = 'Ricerca in corso...';
            
            try {
                const q = query(collection(db, BOOKINGS_COLLECTION), where("codice_prenotazione", "==", codice), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage('error', 'Codice di prenotazione non trovato.');
                    return;
                }

                const docToCancel = querySnapshot.docs[0];
                const data = docToCancel.data();

                if (data.status === 'Cancellato') {
                    showMessage('info', 'Questa prenotazione risulta gi√† cancellata.');
                    return;
                }
                
                // Aggiorna lo stato in Firestore
                await updateDoc(docToCancel.ref, {
                    status: 'Cancellato',
                    cancellation_timestamp: new Date().toISOString()
                });

                // Dati per il PDF di cancellazione
                const cancellationData = { ...data, status: 'Cancellato', data_formattata: DATE_FORMATTER.format(new Date(data.data)) };

                showMessage('success', `Prenotazione ${codice} cancellata con successo.`);
                
                // Genera PDF di cancellazione
                createAndDownloadPDF('CANCELLAZIONE', cancellationData);

                // Mostra la pagina di conferma cancellazione
                document.getElementById('cancellation-confirmation-code').textContent = codice;
                document.getElementById('cancellation-confirmation-indirizzo').textContent = data.indirizzo_nome;
                document.getElementById('cancellation-confirmation-data').textContent = `${cancellationData.data_formattata} alle ${data.ora}`;
                showView('cancellation-confirmation-view');
                document.getElementById('cancellation-code').value = ''; // Pulisci input

            } catch (error) {
                console.error("Errore durante la cancellazione:", error);
                showMessage('error', 'Errore durante la cancellazione della prenotazione. Riprova.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'CONFERMA CANCELLAZIONE';
            }
        };
        
        // --- Logica Area Docenti (Nuovo Login con Username/Password) ---

        window.enterAdminArea = () => {
            const username = document.getElementById('admin-username').value.trim();
            const passcode = document.getElementById('admin-passcode-login').value.trim();
            
            if (username === ADMIN_USERNAME && passcode === ADMIN_PASSCODE) {
                showView('admin-view');
                renderAdminTable(allBookings); 
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-passcode-login').value = '';
            } else {
                showMessage('error', 'Nome utente o Password errati. Accesso negato.');
            }
        };

        function renderAdminTable(bookings) {
            const tableBody = document.getElementById('admin-table-body');
            tableBody.innerHTML = '';

            const sortedBookings = [...bookings].sort((a, b) => {
                if (a.data < b.data) return -1;
                if (a.data > b.data) return 1;
                // Ordina anche per ora in caso di stessa data
                const oraA = a.ora.split('-')[0];
                const oraB = b.ora.split('-')[0];
                return oraA.localeCompare(oraB);
            });

            sortedBookings.forEach(b => {
                const statusColor = b.status === 'Cancellato' ? 'text-red-600' : 'text-green-600';
                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">${b.data_formattata}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">${b.ora}</td>
                        <td class="p-4 text-sm text-gray-500">${b.indirizzo_nome}</td>
                        <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">${b.nome_studente}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">${b.email}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">${b.cellulare}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-500">${b.scuola_provenienza}</td>
                        <td class="p-4 whitespace-nowrap text-sm font-mono font-bold text-blue-700">${b.codice_prenotazione}</td>
                        <td class="p-4 whitespace-nowrap text-sm font-semibold ${statusColor}">${b.status}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // --- Logica Cancellazione Totale Dati ---
        
        window.openDeleteAllModal = () => {
            document.getElementById('delete-all-passcode').value = '';
            document.getElementById('delete-all-modal').classList.remove('hidden');
        };

        window.closeDeleteAllModal = () => {
            document.getElementById('delete-all-modal').classList.add('hidden');
        };

        window.confirmDeleteAll = async () => {
            const passcode = document.getElementById('delete-all-passcode').value.trim();
            const btn = document.getElementById('confirm-delete-all-btn');
            
            if (passcode !== ADMIN_PASSCODE) {
                showMessage('error', 'Password Docenti errata. Cancellazione annullata.');
                closeDeleteAllModal();
                return;
            }

            btn.disabled = true;
            btn.textContent = 'CANCELLAZIONE IN CORSO...';

            try {
                const q = query(collection(db, BOOKINGS_COLLECTION));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showMessage('info', 'Nessuna prenotazione da cancellare.');
                    return;
                }

                let deletedCount = 0;
                for (const doc of snapshot.docs) {
                    await deleteDoc(doc.ref);
                    deletedCount++;
                }
                
                showMessage('success', `Cancellazione totale riuscita! Eliminati ${deletedCount} record.`);
                closeDeleteAllModal();
                showView('admin-view'); 
            } catch (error) {
                console.error("Errore durante la cancellazione totale:", error);
                showMessage('error', 'Errore critico durante la cancellazione totale dei dati. Riprova.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'CONFERMA CANCELLAZIONE TOTALE';
            }
        };

        // --- Logica Export CSV ---
         window.exportToCSV = () => {
            if (allBookings.length === 0) {
                showMessage('info', 'Nessun dato da esportare.');
                return;
            }

            const header = [
                "ID Prenotazione", "Indirizzo", "Data", "Ora", "Nome Studente", 
                "Email", "Cellulare", "Scuola Provenienza", "Codice Prenotazione", "Stato", "Timestamp Registrazione"
            ];

            const csvRows = allBookings.map(b => [
                b.id, b.indirizzo_nome, b.data_formattata, b.ora, b.nome_studente, 
                b.email, b.cellulare, b.scuola_provenienza, b.codice_prenotazione, b.status, new Date(b.timestamp).toLocaleString('it-IT')
            ].map(v => `"${v}"`).join(',')); 

            const csvContent = [
                header.join(','),
                ...csvRows
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `prenotazioni_ministage_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('success', 'Dati scaricati con successo in formato CSV.');
        };

        // --- Avvio Applicazione ---

        window.onload = () => {
            initializeFirebase();
            renderIndirizziList();
            showView('home-view');
        };
        
        window.showView = showView;
    </script>
</head>
<body class="antialiased">

    <!-- Intestazione Fissa -->
    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-extrabold text-blue-700 cursor-pointer flex items-center" onclick="showView('home-view')">
                <span class="text-3xl mr-2">üìò</span> ITSCG Primo Levi
            </h1>
            
            <!-- Indicatore Stato Connessione DB -->
            <div class="flex items-center space-x-3">
                <span id="connection-status" class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-500 text-white">
                    DB in connessione...
                </span>
                <nav class="hidden md:flex space-x-6">
                    <a href="#" onclick="showView('info-view')" class="text-gray-600 hover:text-blue-700 transition">Informazioni</a>
                    <a href="#" onclick="showView('cancellation-input-view')" class="text-red-600 hover:text-red-700 transition font-bold">Cancella</a>
                    <a href="#" onclick="showView('login-docenti-view')" class="text-blue-700 hover:text-blue-900 transition font-bold">Docenti</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Contenitore Principale con Padding per l'Header -->
    <main class="pt-24 pb-12 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Message Box (per alert/confirm personalizzati) -->
        <div id="message-box" class="hidden fixed bottom-4 right-4 z-50 p-4 border rounded-lg shadow-xl" role="alert"></div>

        <!-- Vista 1: Home (Selezione Indirizzi) -->
        <section id="home-view" data-view="home-view" class="active">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-extrabold text-gray-900 mb-4">Prenota il tuo Ministage di Orientamento</h2>
                <p class="text-xl text-gray-600">Scegli l'indirizzo e vivi un'esperienza diretta nelle nostre aule.</p>
            </div>

            <!-- Avviso Importante -->
            <div class="p-4 mb-8 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md shadow-md text-center">
                <p class="font-bold">‚ö†Ô∏è ATTENZIONE: Documento di Conferma Importante!</p>
                <p>√à fondamentale conservare il **PDF di conferma** generato al momento della prenotazione e presentarlo all'ingresso il giorno dello Stage.</p>
            </div>

            <!-- Bottoni di Navigazione Rapida (Home) -->
            <div class="flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0 sm:space-x-8 mb-12">
                <!-- Bottone Cancella a Sinistra (Rosso) -->
                <button onclick="showView('cancellation-input-view')" 
                        class="danger-color text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition duration-150 shadow-lg flex-1 sm:max-w-xs">
                    Cancella Prenotazione
                </button>
                <!-- Chatbot al Centro (Grigio) -->
                <button onclick="showView('chatbot-view')" 
                        class="bg-gray-700 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-800 transition duration-150 shadow-lg flex-1 sm:max-w-sm">
                    Assistente Chatbot
                </button>
                <!-- Area Docenti a Destra (Blu) -->
                <button onclick="showView('login-docenti-view')" 
                        class="primary-color text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 shadow-lg flex-1 sm:max-w-xs">
                    Area Docenti
                </button>
            </div>
            
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Scegli il tuo Indirizzo</h3>
            <div id="indirizzi-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- I contenuti vengono generati da renderIndirizziList() -->
            </div>
        </section>

        <!-- Vista 3: Pagina di Prenotazione Dettagliata (Dinamica) -->
        <section id="booking-view" data-view="booking-view">
            <h2 id="booking-indirizzo-title" class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-3">Prenotazione Ministage: [Indirizzo]</h2>
            <input type="hidden" id="booking-indirizzo-id" value="">

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <p class="text-gray-600 mb-6">Seleziona una data e un orario disponibili. Le date sono mostrate in **ordine cronologico**.</p>
                <div class="mb-4 bg-blue-100 p-4 rounded-lg">
                    <div class="grid grid-cols-5 font-bold text-blue-800 border-b pb-2 mb-2">
                        <div>Giorno</div>
                        <div>Data</div>
                        <div>Ora</div>
                        <div class="text-center">Disponibilit√†</div>
                        <div></div>
                    </div>
                    <div id="slots-container" class="space-y-2">
                        <!-- Gli slot verranno iniettati qui da renderBookingSlots() -->
                    </div>
                </div>
            </div>
            
            <div class="mt-8">
                <button onclick="showView('home-view')" class="secondary-color text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-500 transition duration-150 shadow-md">
                    ‚Üê Torna agli Indirizzi
                </button>
            </div>
        </section>

        <!-- Modale di Prenotazione (Aggiornato con nuovi campi) -->
        <div id="booking-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Conferma Prenotazione</h3>
                
                <p class="mb-4 text-gray-700">Stai per prenotare per la data <span id="modal-date" class="font-bold text-blue-700"></span> alle ore <span id="modal-time" class="font-bold text-blue-700"></span>.</p>

                <form id="booking-form" onsubmit="handleBooking(event)">
                    <input type="hidden" id="modal-indirizzo-id" name="modal-indirizzo-id">
                    <input type="hidden" id="modal-date-hidden" name="modal-date-hidden">
                    <input type="hidden" id="modal-time-hidden" name="modal-time-hidden">

                    <div class="space-y-4 mb-6">
                        <div>
                            <label for="nome_studente" class="block text-sm font-medium text-gray-700 mb-1">Nome e Cognome Studente</label>
                            <input type="text" id="nome_studente" name="nome_studente" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email di Contatto</label>
                            <input type="email" id="email" name="email" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="cellulare" class="block text-sm font-medium text-gray-700 mb-1">Cellulare</label>
                            <input type="tel" id="cellulare" name="cellulare" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="scuola_provenienza" class="block text-sm font-medium text-gray-700 mb-1">Scuola di Provenienza (Terza Media)</label>
                            <input type="text" id="scuola_provenienza" name="scuola_provenienza" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeBookingModal()" 
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">
                            Annulla
                        </button>
                        <button type="submit" id="confirm-booking-btn"
                                class="primary-color text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                            CONFERMA PRENOTAZIONE
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Vista 4: Conferma Prenotazione (Aggiornata per centrare il codice e rimuovere il pulsante Cancella) -->
        <section id="confirmation-view" data-view="confirmation-view">
            <div class="bg-green-50 border-t-4 border-green-500 rounded-b text-green-900 px-4 py-8 shadow-md" role="alert">
                <div class="flex flex-col items-center">
                    <svg class="h-12 w-12 text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-3xl font-bold mb-2">Prenotazione Effettuata con Successo!</p>
                    <p class="text-lg text-center mb-6">Il tuo Ministage √® stato prenotato. Conserva con cura il codice e il PDF scaricato.</p>
                    
                    <div class="p-4 bg-white border border-gray-300 rounded-lg shadow-inner text-center">
                        <p class="text-sm font-medium text-gray-600">Il tuo **Codice di Prenotazione** √®:</p>
                        <p id="confirmation-code" class="text-4xl font-mono text-red-600 font-extrabold tracking-widest mt-1"></p>
                    </div>

                    <div class="mt-8 flex space-x-4">
                        <button onclick="showView('home-view')" class="primary-color text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                            Torna alla Home
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Vista 7: Login Area Docenti (Aggiornata con Username e Password) -->
        <section id="login-docenti-view" data-view="login-docenti-view">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-3">Accesso Area Docenti</h2>
            
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm mx-auto">
                <p class="text-gray-700 mb-6">Inserisci le credenziali per accedere al pannello di controllo.</p>
                <div class="mb-4">
                    <label for="admin-username" class="block text-sm font-medium text-gray-700 mb-1">Nome Utente</label>
                    <input type="text" id="admin-username" required placeholder="docente"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="admin-passcode-login" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="admin-passcode-login" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg tracking-wider focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button onclick="enterAdminArea()"
                        class="w-full primary-color text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                    ACCEDI
                </button>
                <p class="text-xs text-gray-400 mt-2 text-center">Credenziali di Test: Utente: docente | Password: PRIMOLEVI2025</p>
            </div>
        </section>

        <!-- Vista 8: Area Docenti (Aggiunti nuovi campi nella tabella) -->
        <section id="admin-view" data-view="admin-view">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-3">Pannello di Controllo Docenti</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <p class="text-lg font-semibold text-gray-700">Riepilogo Prenotazioni e Cancellazioni</p>
                    <div class="flex space-x-3">
                        <button onclick="openDeleteAllModal()" 
                                class="danger-color text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md flex items-center">
                            CANCELLA TUTTO
                        </button>
                        <button onclick="exportToCSV()" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V4a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Scarica CSV
                        </button>
                    </div>
                </div>

                <div class="admin-table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50 sticky top-0">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Data</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Ora</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Indirizzo</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Studente</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Email</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Cellulare</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Scuola</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Codice</th>
                                <th class="p-4 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Stato</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Righe Prenotazioni/Cancellazioni inserite da renderAdminTable() -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-500">
                    <p>Totale prenotazioni: <span class="font-bold text-gray-700" id="total-bookings-count">0</span></p>
                    <p>User ID (debug): <span class="font-mono text-xs text-blue-500" id="current-user-id-display">Caricamento...</span></p>
                </div>
            </div>
            
            <div class="mt-8">
                <button onclick="showView('home-view')" class="secondary-color text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-500 transition duration-150 shadow-md">
                    ‚Üê Esci dal Pannello
                </button>
            </div>
        </section>
        
        <!-- Altre Viste (Info e Chatbot Placeholder) -->
        <section id="info-view" data-view="info-view">...</section>
        <section id="chatbot-view" data-view="chatbot-view">...</section>
        <section id="cancellation-input-view" data-view="cancellation-input-view">...</section>
        <section id="cancellation-confirmation-view" data-view="cancellation-confirmation-view">...</section>
        
        <!-- Modale di Cancellazione Totale (Docenti) -->
        <div id="delete-all-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
                <h3 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">CONFERMA CANCELLAZIONE TOTALE</h3>
                
                <p class="mb-4 text-gray-700">‚ö†Ô∏è **ATTENZIONE!** Questa azione eliminer√† **tutte** le prenotazioni da database. Questa operazione √® **irreversibile**.</p>
                
                <div class="mb-6">
                    <label for="delete-all-passcode" class="block text-sm font-medium text-gray-700 mb-1">Reinserisci Password Docenti per Confermare</label>
                    <input type="password" id="delete-all-passcode" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg text-lg tracking-wider focus:ring-red-500 focus:border-red-500">
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeDeleteAllModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">
                        Annulla
                    </button>
                    <button type="button" id="confirm-delete-all-btn" onclick="confirmDeleteAll()"
                            class="danger-color text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md">
                        CONFERMA CANCELLAZIONE TOTALE
                    </button>
                </div>
            </div>
        </div>

    </main>

</body>
</html>
