<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Stage ITSCG</title>
    <!-- Caricamento Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importazione librerie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Stile personalizzato per un look moderno */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card-course { transition: all 0.3s ease-in-out; cursor: pointer; }
        .card-course:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top-color: #3b82f6; border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Stile per i modali */
        .modal-content { max-height: 80vh; overflow-y: auto; }
        .table-container { max-height: 70vh; overflow-y: auto; }
        
        /* Stile per i pulsanti */
        .docente-access-btn {
            background-image: linear-gradient(to right, #4f46e5 0%, #3b82f6 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(65, 132, 246, 0.5);
        }
        .docente-access-btn:hover {
            background-position: right center;
            box-shadow: 0 6px 20px 0 rgba(65, 132, 246, 0.7);
        }
        .cancellation-btn-fixed {
            background-color: #fca5a5; 
            color: #991b1b; 
            border: 2px solid #ef4444; 
            transition: all 0.3s ease;
        }

        .cancellation-btn-fixed:hover {
            background-color: #ef4444; 
            color: white;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        /* Stili per le tab della dashboard docente */
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5; /* Indigo-600 */
            color: #1e3a8a; /* Blue-900 */
            font-weight: 700;
            background-color: #e0f2f1; /* Light background for active tab */
        }
        
        /* Stile per la tabella Docenti per migliorare la leggibilit√† e ridurre l'ampiezza */
        #bookings-table th, #cancellations-table th {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #bookings-table td, #cancellations-table td {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    </style>
    <!-- Configurazione per il font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<!-- Header compatto con logo -->
<header class="bg-white shadow-md sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
        <div class="flex items-center">
            <img src="Levi.png" 
                 onerror="this.onerror=null; this.src='Levi.png';" 
                 alt="Logo Primo Levi" 
                 class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-indigo-500 mr-2">
            <h1 class="text-lg sm:text-xl font-semibold text-gray-900">
                Stage Orientamento <span class="text-indigo-600 font-bold">ITSCG Primo Levi</span>
            </h1>
        </div>
        <div id="auth-status" class="text-xs text-gray-400 truncate">
            <div id="current-user-id">ID: In attesa...</div>
        </div>
    </div>
</header>

    <main class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <!-- Message Box per feedback utente -->
        <div id="message-box" class="hidden fixed top-20 right-5 p-4 rounded-xl shadow-xl text-white z-50 transition-opacity duration-300"></div>
        
        <!-- Indicatore di caricamento del DB -->
        <div id="loading" class="flex justify-center items-center py-4 text-gray-600">
             <div id="loading-spinner" class="spinner mr-3"></div>
            <span id="loading-status" class="text-lg font-medium">Connessione al database in corso...</span>
        </div>

        <!-- Vista Docente (Inizialmente nascosta) -->
        <section id="docente-view" class="hidden">
            <h2 class="text-4xl font-extrabold text-indigo-800 text-center mb-6 border-b-4 border-indigo-600 pb-2">Area Docenti - Monitoraggio Stage</h2>
            
            <!-- Controlli Docente -->
            <div class="mb-6 flex justify-between items-center bg-gray-100 p-4 rounded-xl shadow-md">
                <button id="logout-docente-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                    Logout Docente
                </button>
                <div class="flex space-x-3">
                    <button id="export-csv-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 shadow-md flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Esporta in CSV (Excel)
                    </button>
                    <!-- Pulsante Elimina Dati Totale -->
                    <button id="open-delete-modal-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-800 rounded-lg hover:bg-red-900 transition duration-150 shadow-md flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        Cancella TUTTI i Dati
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-300 mb-6">
                <button id="tab-bookings" data-tab="bookings" class="tab-button px-6 py-3 text-gray-600 hover:text-indigo-600 hover:border-indigo-300 border-b-2 border-transparent tab-active">
                    Prenotazioni Attive
                </button>
                <button id="tab-cancellations" data-tab="cancellations" class="tab-button px-6 py-3 text-gray-600 hover:text-red-600 hover:border-red-300 border-b-2 border-transparent">
                    Storico Annullamenti
                </button>
            </div>

            <!-- Contenuto Tab: Prenotazioni Attive -->
            <div id="content-bookings" class="tab-content">
                <h3 class="text-2xl font-bold text-gray-700 mb-4">Elenco Prenotazioni Attive per posti e data)</h3>
                
                <!-- FILTRO PER DATA -->
                <div class="mb-4 flex items-center space-x-4 bg-white p-4 rounded-xl shadow-inner border border-gray-200">
                    <label for="date-filter" class="text-sm font-medium text-gray-700">Filtra per Data Stage:</label>
                    <select id="date-filter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-auto">
                        <!-- Opzioni popolate da JS -->
                    </select>
                </div>
                <!-- FINE FILTRO -->

                <div class="table-container bg-white rounded-xl shadow-lg p-6">
                    <table id="bookings-table" class="min-w-full divide-y divide-gray-200 table-fixed">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Studente</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Corso</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Stage</th>
                                <th class="w-3/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scuola Media</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email/Tel</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Iscrizione</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Righe prenotazioni caricate qui -->
                        </tbody>
                    </table>
                    <p id="no-bookings-message" class="text-center py-10 text-gray-500 hidden">Nessuna prenotazione attiva trovata per la data selezionata.</p>
                </div>
            </div>

            <!-- Contenuto Tab: Storico Annullamenti -->
            <div id="content-cancellations" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-700 mb-4">Storico Prenotazioni Annullate</h3>
                <div class="table-container bg-white rounded-xl shadow-lg p-6 border-2 border-red-200">
                    <table id="cancellations-table" class="min-w-full divide-y divide-gray-200 table-fixed">
                        <thead class="bg-red-50 sticky top-0">
                            <tr>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Studente</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Corso</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Stage Originale</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Annullato il</th>
                                <th class="w-5/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivazione</th>
                            </tr>
                        </thead>
                        <tbody id="cancellations-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Righe annullamenti caricate qui -->
                        </tbody>
                    </table>
                    <p id="no-cancellations-message" class="text-center py-10 text-gray-500 hidden">Nessuna cancellazione registrata.</p>
                </div>
            </div>
        </section>

        <!-- Vista Studente (Inizialmente mostrata) -->
        <section id="student-main-view">
            
            <!-- CONTROLLI UTENTE FISSI (Annulla e Docente) -->
            <div class="flex flex-col sm:flex-row justify-center sm:justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                <!-- Pulsante Annulla Prenotazione -->
                <button id="open-cancellation-modal-btn" class="cancellation-btn-fixed inline-flex items-center px-6 py-2 text-sm font-bold rounded-xl shadow-md transition duration-300 w-full sm:w-auto justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Annulla la mia Prenotazione
                </button>
                <!-- Pulsante Accesso Docenti -->
                <button id="open-docente-login-btn" class="docente-access-btn px-6 py-2 text-sm font-bold text-white rounded-xl transition duration-300 w-full sm:w-auto justify-center flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1m18-7V9a3 3 0 00-3-3h-2M11 5V4a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2"></path></svg>
                    Area Riservata Docenti
                </button>
            </div>


            <!-- WARNING Message (TESTO MODIFICATO) -->
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8 rounded-xl shadow-md" role="alert">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <p class="font-bold text-lg">‚ö†Ô∏è ATTENZIONE: Documento di Conferma Importante!</p>
                </div>
                <p class="mt-2 text-sm">
                    √à fondamentale conservare il PDF di conferma generato al momento della prenotazione e presentarlo all'ingresso il giorno dello Stage. 
                </p>
            </div>
            
            <!-- Sezione Informativa sul Ministage (Semplificata) -->
            <section class="mb-12 p-8 bg-white rounded-2xl shadow-2xl border-l-8 border-indigo-600">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-4">Il Ministage di Orientamento ITSCG Primo Levi</h2>
                
                <p class="text-gray-700 leading-relaxed text-base mb-6">Per supportare al meglio l'importante scelta della scuola superiore, il nostro Istituto organizza dei **Ministage di Orientamento**, che permetteranno agli studenti di terza media di vivere un'esperienza diretta all'interno delle nostre aule. L'esperienza complessiva dura circa due ore.</p>

                <div class="text-xs text-gray-500">Organizzazione a cura delle Funzioni Orientamento: Prof. ssa Laura Corvi e Prof. ssa Mariagrazia Calabrese.</div>
                <div class="text-xs text-gray-500">ITSCG PRIMO LEVI DI SEREGNO VIA BRIANTINA 68</div>
            </section>

            <!-- Contenitori per le due viste Studente (Home e Dettaglio Date) -->
            <h2 class="text-4xl font-extrabold text-gray-800 text-center mb-10">Scegli il tuo Indirizzo</h2>
            
            <!-- Vista 1: Selezione Corso -->
            <div id="course-selection-view" class="space-y-12">
                <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Le schede dei corsi saranno generate qui (SOLO NOMI) -->
                </div>
            </div>
            
            <!-- Vista 2: Selezione Data per Corso Specifico (Nascosta inizialmente) -->
            <div id="date-selection-view" class="hidden space-y-6 p-6 bg-white rounded-xl shadow-lg">
                <button id="back-to-courses-btn" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 transition duration-150 border border-indigo-200 flex items-center">
                     <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Torna agli Indirizzi
                </button>
                <h3 class="text-3xl font-bold text-gray-800 border-b pb-2">Date disponibili per: <span id="selected-course-title" class="text-indigo-600"></span></h3>
                <div id="dates-container" class="space-y-4">
                    <!-- Le date disponibili per il corso selezionato saranno generate qui -->
                </div>
            </div>

        </section>


        <!-- Modale di Prenotazione -->
        <div id="booking-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-lg rounded-xl shadow-2xl">
                <h3 class="text-2xl font-bold mb-4 text-indigo-600">Conferma Prenotazione Stage</h3>
                <p class="text-gray-600 mb-2">Stage: <span id="modal-course-name" class="font-bold"></span></p>
                <p class="text-gray-600 mb-4">Data: <span id="modal-date" class="font-bold"></span></p>
                
                <form id="booking-form" class="space-y-4">
                    <input type="hidden" id="booking-course-id">
                    <input type="hidden" id="booking-date">

                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome e Cognome dello Studente</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-school" class="block text-sm font-medium text-gray-700">Scuola Media di Provenienza</label>
                        <input type="text" id="student-school" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome completo della tua scuola media">
                    </div>
                    <div>
                        <label for="student-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="student-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-phone" class="block text-sm font-medium text-gray-700">Cellulare</label>
                        <input type="tel" id="student-phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="close-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                        <button type="submit" id="confirm-booking-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">Conferma e Genera PDF</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale di Cancellazione -->
        <div id="cancellation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-lg rounded-xl shadow-2xl">
                <h3 class="text-2xl font-bold mb-6 text-red-600">Cancellazione Prenotazione</h3>
                
                <p class="text-gray-600 mb-4 text-sm">Per annullare, inserisci il codice di prenotazione univoco che trovi nel PDF di conferma. L'annullamento √® immediato.</p>
                
                <form id="cancellation-form" class="space-y-4">
                    <div>
                        <label for="cancellation-code" class="block text-sm font-medium text-gray-700">Codice Prenotazione</label>
                        <input type="text" id="cancellation-code" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Esempio: X3H4K9J2">
                    </div>
                    <div>
                        <label for="cancellation-reason" class="block text-sm font-medium text-gray-700">Motivazione della Cancellazione</label>
                        <textarea id="cancellation-reason" rows="2" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Es. Ho gi√† partecipato ad un altro stage."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="close-cancellation-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                        <button type="submit" id="confirm-cancellation-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150 shadow-md">Conferma Cancellazione</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modale Login Docente -->
        <div id="docente-login-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-sm rounded-xl shadow-2xl border-t-8 border-indigo-700">
                 <div class="text-center mb-6">
                    <svg class="w-12 h-12 mx-auto text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-1a3 3 0 00-3-3H8a3 3 0 00-3 3v1h12zm-9-10a4 4 0 11-8 0 4 4 0 018 0zm-7 0a7 7 0 1014 0 7 7 0 00-14 0zm15 10a4 4 0 100-8 4 4 0 000 8zM12 11a4 4 0 100-8 4 4 0 000 8z"></path></svg>
                    <h3 class="text-2xl font-bold mt-3 text-indigo-800">Accesso Riservato Docenti</h3>
                    <p class="text-gray-500 text-sm">Inserisci le credenziali ITSCG.</p>
                </div>
                
                <form id="docente-login-form" class="space-y-4">
                    <div>
                        <label for="docente-username" class="block text-sm font-medium text-gray-700">Nome Utente</label>
                        <input type="text" id="docente-username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="docente-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="docente-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex justify-end pt-4">
                        <button type="submit" id="confirm-docente-login-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">Accedi</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale di Eliminazione Dati Totale -->
        <div id="delete-data-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-sm rounded-xl shadow-2xl border-t-8 border-red-700">
                 <div class="text-center mb-6">
                    <svg class="w-12 h-12 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <h3 class="text-2xl font-bold mt-3 text-red-800">Conferma Eliminazione Globale</h3>
                    <p class="text-gray-500 text-sm font-bold mt-2">
                        ATTENZIONE: Questa azione **ELIMINER√Ä IRREVERSIBILMENTE** tutte le prenotazioni attive e lo storico annullamenti dal database.
                    </p>
                </div>
                
                <form id="docente-delete-form" class="space-y-4">
                    <div>
                        <label for="docente-delete-password" class="block text-sm font-medium text-gray-700">Reinserisci Password Docente</label>
                        <input type="password" id="docente-delete-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="close-delete-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                        <button type="submit" id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150 shadow-md">Conferma Eliminazione Dati</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pi√® di pagina -->
        <div class="mt-16 pt-8 border-t border-gray-300 flex justify-center">
            <div class="w-full max-w-4xl text-center">
                <p class="text-xs text-gray-400">¬© 2025 ITSCG Primo Levi. Tutti i diritti riservati.</p>
            </div>
        </div>
    </main>

    <!-- Importazioni JavaScript e Logica di Applicazione Firebase -->
    <script type="module">
        // Importazioni Firebase necessarie per Auth, Firestore, e Query
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, where, addDoc, 
            onSnapshot, serverTimestamp, deleteDoc, getDocs, doc, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali del Canvas per Firebase (Obbligatorie) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let firebaseConfig = {};

        if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            console.warn("Configurazione Firebase non fornita dall'ambiente. Utilizzo della configurazione specifica dell'utente.");
            
            // ====================================================================================
            // CONFIGURAZIONE FIREBASE SPECIFICA (Configurazione fittizia/placeholder)
            // ====================================================================================
            firebaseConfig = {
                apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
                authDomain: "progetto-63fb3.firebaseapp.com",
                projectId: "progetto-63fb3", 
                storageBucket: "progetto-63fb3.firebasestorage.app",
                messagingSenderId: "883088850197",
                appId: "1:883088850197:web:29b8573ea43555041b3d1c",
            };
        }
        // --- Fine Configurazione Firebase ---

        // Variabili Firebase e Stato
        let db = null;
        let auth = null;
        let userId = null;
        let isDocente = false; 
        
        // --- Stato Globale ---
        const MAX_SLOTS = 4; // Posti fissi per ogni slot data/corso
        let currentBookings = []; 
        let currentCancellations = [];
        let currentAvailability = {}; 
        let currentCourseId = null; // Nuovo stato per la navigazione
        
        // Credenziali Docente Fisse
        const DOCENTE_USERNAME = 'docente';
        const DOCENTE_PASSWORD = 'its2025'; // Password usata anche per eliminazione dati

        // Struttura fissa dei corsi
        const COURSES = [
            { id: 'Liceo Scientifico Opzione Scienze Applicate', name: 'Liceo Scientifico Opzione Scienze Applicate ', color: 'bg-blue-100 text-blue-800', icon: '<svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2zM9 8h6M9 12h6M9 16h6"></path></svg>' }, 
            { id: 'sistema-moda', name: 'Sistema Moda', color: 'bg-pink-100 text-pink-800', icon: '<svg class="w-8 h-8 text-pink-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13v8a1 1 0 001 1h8a1 1 0 001-1v-8m-7 0H7m0 0l-1-2m1 2l1-2m7 2h-4m-4 0l-1-2m1 2l1-2m-1 2H7"></path></svg>' },
            { id: 'relazioni-marketing', name: 'Relazioni Internazionali per il Marketing', color: 'bg-yellow-100 text-yellow-800', icon: '<svg class="w-8 h-8 text-yellow-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v5m0 0a2 2 0 100 4 2 2 0 000-4zM12 8V6a2 2 0 100-4 2 2 0 000 4z"></path></svg>' },
            { id: 'logistica-quadriennale', name: 'Logistica Corso Quadriennale', color: 'bg-indigo-100 text-indigo-800', icon: '<svg class="w-8 h-8 text-indigo-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-4 4m0 0l-4-4m4 4V7"></path></svg>' },
            { id: 'costruzione-territorio', name: 'Costruzione Ambiente e Territorio', color: 'bg-purple-100 text-purple-800', icon: '<svg class="w-8 h-8 text-purple-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>' }
        ];

        // 14 Date di programmazione AGGIORNATE
        const PROGRAMMED_DATES = [
            '2025-11-10', '2025-11-12', '2025-11-17', '2025-11-19', '2025-11-24', '2025-11-26', 
            '2025-12-01', '2025-12-03', '2025-12-09', '2025-12-11', 
            '2026-01-12', '2026-01-19', '2026-01-26', '2026-02-02'
        ];
        
        const PDF_SIGNATURE = 'ITSCG PRIMO LEVI DI SEREGNO VIA BRIANTINA 68 - Funzioni Orientamento: Prof. ssa Laura Corvi e Prof. ssa Maria Grazia Calabrese';
        
        // Elementi DOM
        const coursesContainer = document.getElementById('courses-container');
        const messageBox = document.getElementById('message-box');
        const bookingModal = document.getElementById('booking-modal');
        const cancellationModal = document.getElementById('cancellation-modal');
        const bookingForm = document.getElementById('booking-form');
        const cancellationForm = document.getElementById('cancellation-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingStatus = document.getElementById('loading-status');
        const docenteLoginModal = document.getElementById('docente-login-modal');
        const docenteLoginForm = document.getElementById('docente-login-form');
        const studentMainView = document.getElementById('student-main-view');
        const docenteView = document.getElementById('docente-view');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const dateFilter = document.getElementById('date-filter');
        const deleteDataModal = document.getElementById('delete-data-modal');
        const docenteDeleteForm = document.getElementById('docente-delete-form');
        
        // Nuovi elementi per la navigazione Studente
        const courseSelectionView = document.getElementById('course-selection-view');
        const dateSelectionView = document.getElementById('date-selection-view');
        const selectedCourseTitle = document.getElementById('selected-course-title');
        const datesContainer = document.getElementById('dates-container');
        
        const BOOKINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/bookings`;
        const CANCELLATIONS_COLLECTION_PATH = `/artifacts/${appId}/public/data/cancellations`;


        // --- Funzioni di Utility ---

        function generateUniqueCode(length = 10) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `fixed top-20 right-5 p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 opacity-100 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            messageBox.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 5000); 
        }

        function resetFormsAndModals() {
            bookingModal.classList.add('hidden');
            cancellationModal.classList.add('hidden');
            docenteLoginModal.classList.add('hidden');
            deleteDataModal.classList.add('hidden');
            bookingForm.reset();
            cancellationForm.reset();
            docenteLoginForm.reset();
            docenteDeleteForm.reset();
        }
        
        // --- Gestione Modali e Navigazione ---
        document.getElementById('close-modal-btn').addEventListener('click', resetFormsAndModals);
        document.getElementById('open-cancellation-modal-btn').addEventListener('click', () => cancellationModal.classList.remove('hidden'));
        document.getElementById('close-cancellation-modal-btn').addEventListener('click', resetFormsAndModals);
        document.getElementById('open-docente-login-btn').addEventListener('click', () => docenteLoginModal.classList.remove('hidden'));
        document.getElementById('open-delete-modal-btn').addEventListener('click', () => deleteDataModal.classList.remove('hidden'));
        document.getElementById('close-delete-modal-btn').addEventListener('click', resetFormsAndModals);
        
        // Listener per tornare alla Home Studente
        document.getElementById('back-to-courses-btn').addEventListener('click', () => {
            currentCourseId = null;
            renderStudentView('home');
        });


        // Funzione per gestire la visualizzazione Studente
        function renderStudentView(view) {
            if (view === 'home') {
                courseSelectionView.classList.remove('hidden');
                dateSelectionView.classList.add('hidden');
                renderCourses(); // Mostra i box degli indirizzi
            } else if (view === 'dates' && currentCourseId) {
                courseSelectionView.classList.add('hidden');
                dateSelectionView.classList.remove('hidden');
                renderCourseDates(currentCourseId); // Mostra le date per l'indirizzo
            }
        }
        
        // Gestione Tab Docente
        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            document.getElementById(`tab-${tabId}`).classList.add('tab-active');
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            
            if (tabId === 'bookings') {
                renderDocenteDashboard(); 
            } else if (tabId === 'cancellations') {
                renderCancellationsDashboard();
            }
        }

        document.getElementById('tab-bookings').addEventListener('click', () => switchTab('bookings'));
        document.getElementById('tab-cancellations').addEventListener('click', () => switchTab('cancellations'));


        // --- Inizializzazione Firebase e Autenticazione ---
        function initializeFirebase() {
            if (!firebaseConfig.projectId) {
                loadingSpinner.classList.add('hidden');
                loadingStatus.textContent = "ATTENZIONE: Configurazione Firebase incompleta. Impossibile connettersi.";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Errore nell'autenticazione Firebase:", error);
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID(); 
                    }
                    currentUserIdDisplay.textContent = `ID Utente: ${userId.substring(0, 8)}...`;
                    setupRealtimeListener();
                });

            } catch(e) {
                loadingStatus.textContent = `Errore di inizializzazione: ${e.message}`;
                console.error("Errore Firebase:", e);
            }
        }

        // --- Funzione di Ascolto in Tempo Reale (REAL-TIME LISTENER) ---
        function setupRealtimeListener() {
            if (!db) return;

            loadingSpinner.classList.remove('hidden');
            loadingStatus.textContent = "Caricamento disponibilit√† in tempo reale...";
            
            const bookingsRef = collection(db, BOOKINGS_COLLECTION_PATH);
            const cancellationsRef = collection(db, CANCELLATIONS_COLLECTION_PATH);

            const q = query(bookingsRef); 
            const qCancellations = query(cancellationsRef);

            // Listener per le Prenotazioni Attive (Aggiorna Disponibilit√† e Dashboard)
            onSnapshot(q, (snapshot) => {
                currentBookings = [];
                currentAvailability = {};
                
                // 1. Inizializza la disponibilit√† completa
                COURSES.forEach(course => {
                    PROGRAMMED_DATES.forEach(date => {
                        const key = `${course.id}-${date}`;
                        currentAvailability[key] = MAX_SLOTS;
                    });
                });

                // 2. Processa i dati e calcola la disponibilit√† rimanente
                snapshot.forEach((doc) => {
                    const booking = doc.data();
                    const key = `${booking.courseId}-${booking.date}`;
                    
                    if (currentAvailability[key] > 0) {
                        currentAvailability[key]--;
                    }
                    currentBookings.push({ ...booking, docId: doc.id });
                });
                
                currentBookings.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

                // 3. Aggiorna l'interfaccia utente
                if (!isDocente) {
                    renderStudentView(currentCourseId ? 'dates' : 'home');
                } else {
                    populateDateFilter(); 
                    renderDocenteDashboard(); 
                }

                loadingSpinner.classList.add('hidden');
                loadingStatus.textContent = "Disponibilit√† Aggiornata in Tempo Reale";

            }, (error) => {
                console.error("Errore onSnapshot Bookings:", error);
                loadingSpinner.classList.add('hidden');
                loadingStatus.textContent = `Errore di connessione al database: ${error.message}`;
            });
            
            // Listener per le Cancellazioni
             onSnapshot(qCancellations, (snapshot) => {
                currentCancellations = [];
                snapshot.forEach((doc) => {
                    const cancellation = doc.data();
                    currentCancellations.push({ ...cancellation, docId: doc.id });
                });
                
                currentCancellations.sort((a, b) => {
                    const dateA = a.cancelledAt?.toDate ? a.cancelledAt.toDate().getTime() : 0;
                    const dateB = b.cancelledAt?.toDate ? b.cancelledAt.toDate().getTime() : 0;
                    return dateB - dateA; // Ordine Decrescente
                });

                if (isDocente) {
                    renderCancellationsDashboard();
                }
            }, (error) => {
                 console.error("Errore onSnapshot Cancellations:", error);
            });
            
            dateFilter.addEventListener('change', renderDocenteDashboard);
        }
        
        // --- Gestione Filtro Date Docente ---
        function populateDateFilter() {
            const dates = [...PROGRAMMED_DATES].sort(); 
            
            dateFilter.innerHTML = `<option value="all">Tutte le Date</option>`;
            
            dates.forEach(date => {
                const dateDisplay = new Date(date).toLocaleDateString('it-IT', { year: 'numeric', month: 'short', day: 'numeric' });
                const option = document.createElement('option');
                option.value = date;
                option.textContent = dateDisplay;
                dateFilter.appendChild(option);
            });
        }


        // --- Rendering Corsi (Vista Studente: Selezione Corso) ---

        function renderCourses() {
            coursesContainer.innerHTML = ''; 

            COURSES.forEach(course => {
                const courseHtml = `
                    <div class="card-course bg-white p-6 rounded-2xl shadow-lg border-t-8 border-indigo-600 hover:shadow-2xl flex flex-col items-center text-center select-course-btn" 
                        data-course-id="${course.id}" 
                        data-course-name="${course.name}">
                        ${course.icon}
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${course.name}</h3>
                        <p class="text-sm text-gray-600">Clicca per vedere le date disponibili e prenotare il tuo stage di orientamento in questo indirizzo.</p>
                        <span class="inline-block px-3 py-1 text-xs font-bold rounded-full mt-3 ${course.color}">Vedi le Date &rarr;</span>
                    </div>
                `;
                coursesContainer.innerHTML += courseHtml;
            });

            document.querySelectorAll('.select-course-btn').forEach(button => {
                button.removeEventListener('click', handleCourseSelection);
                button.addEventListener('click', handleCourseSelection);
            });
        }
        
        function handleCourseSelection(event) {
            const courseId = event.currentTarget.dataset.courseId;
            currentCourseId = courseId;
            renderStudentView('dates');
        }

        // Rendering Date per il Corso Selezionato
        function renderCourseDates(courseId) {
            datesContainer.innerHTML = '';
            const course = COURSES.find(c => c.id === courseId);
            if (!course) return;

            selectedCourseTitle.textContent = course.name;

            let datesHtml = '';
            
            PROGRAMMED_DATES.forEach(date => {
                const key = `${courseId}-${date}`;
                const availableSlots = currentAvailability[key] !== undefined ? currentAvailability[key] : MAX_SLOTS;
                const bookedCount = MAX_SLOTS - availableSlots;
                const isFull = availableSlots <= 0;

                let badgeClass = 'bg-green-600';
                let badgeText = `${availableSlots} posti disponibili`;

                if (isFull) {
                    badgeClass = 'bg-red-600';
                    badgeText = 'Posti Esauriti';
                } else if (availableSlots <= 1) {
                    badgeClass = 'bg-orange-500';
                    badgeText = 'Ultimo posto disponibile';
                }
                
                const slotsDisplay = `${bookedCount}/${MAX_SLOTS}`;

                datesHtml += `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border border-gray-200 rounded-xl bg-gray-50 hover:bg-white transition duration-150">
                        <span class="font-bold text-lg text-gray-800 mb-2 sm:mb-0">${new Date(date).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' })}</span>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                            <span class="text-sm font-bold text-white px-3 py-1 rounded-full ${badgeClass}">
                                ${badgeText} (${slotsDisplay})
                            </span>
                            <button
                                data-course-id="${course.id}"
                                data-course-name="${course.name}"
                                data-date="${date}"
                                ${isFull ? 'disabled' : ''}
                                class="book-btn px-4 py-2 text-sm font-medium rounded-lg transition duration-150 ${isFull ? 'bg-gray-400 cursor-not-allowed text-gray-700' : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md'}"
                            >
                                Prenota Ora
                            </button>
                        </div>
                    </div>
                `;
            });
            
            datesContainer.innerHTML = datesHtml;

            document.querySelectorAll('.book-btn').forEach(button => {
                button.removeEventListener('click', openBookingModal);
                button.addEventListener('click', openBookingModal);
            });
        }


        
        // --- Funzioni Dashboard Docente ---
        function setDocenteView(enabled) {
            isDocente = enabled;
            if (enabled) {
                studentMainView.classList.add('hidden');
                docenteView.classList.remove('hidden');
                populateDateFilter(); 
                switchTab('bookings'); 
            } else {
                studentMainView.classList.remove('hidden');
                docenteView.classList.add('hidden');
                renderStudentView(currentCourseId ? 'dates' : 'home'); // Torna alla vista Studente corretta
            }
        }
        
        // Rendering Prenotazioni Attive con Filtro
        function renderDocenteDashboard() {
            const selectedDate = dateFilter.value;
            const tableBody = document.getElementById('bookings-table-body');
            const noBookingsMessage = document.getElementById('no-bookings-message');
            tableBody.innerHTML = '';
            
            const filteredBookings = currentBookings.filter(booking => 
                selectedDate === 'all' || booking.date === selectedDate
            );

            if (filteredBookings.length === 0) {
                noBookingsMessage.classList.remove('hidden');
                return;
            }
            noBookingsMessage.classList.add('hidden');

            filteredBookings.forEach(booking => {
                const date = new Date(booking.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                const createdAt = booking.createdAt?.toDate ? booking.createdAt.toDate().toLocaleDateString('it-IT') : 'N/D';
                
                // Nota: ho aggiunto 'whitespace-normal' a Scuola Media e Email/Tel per evitare tabelle eccessivamente lunghe.
                const row = `
                    <tr class="hover:bg-indigo-50 transition duration-100">
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${booking.bookingCode}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-800">${booking.studentName}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">${booking.courseName}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-semibold text-indigo-600">${date}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 max-w-xs">${booking.studentSchool || 'N/D'}</td> 
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 break-words">${booking.studentEmail}<br/>${booking.studentPhone}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        // Rendering Cancellazioni
        function renderCancellationsDashboard() {
             const tableBody = document.getElementById('cancellations-table-body');
            const noCancellationsMessage = document.getElementById('no-cancellations-message');
            tableBody.innerHTML = '';

            if (currentCancellations.length === 0) {
                noCancellationsMessage.classList.remove('hidden');
                return;
            }
            noCancellationsMessage.classList.add('hidden');

            currentCancellations.forEach(cancellation => {
                const cancelledAt = cancellation.cancelledAt?.toDate ? cancellation.cancelledAt.toDate().toLocaleDateString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'N/D';
                const originalDate = cancellation.date ? new Date(cancellation.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }) : 'N/D';
                
                const row = `
                    <tr class="hover:bg-red-50 transition duration-100">
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-red-700">${cancellation.bookingCode}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-800">${cancellation.studentName || 'N/D'}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">${cancellation.courseName || 'N/D'}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-red-400">${originalDate}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-semibold text-red-500">${cancelledAt}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 break-words">${cancellation.cancellationReason || 'Motivazione non fornita'}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        // Logica Login Docente
        docenteLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('docente-username').value;
            const password = document.getElementById('docente-password').value;
            
            if (username === DOCENTE_USERNAME && password === DOCENTE_PASSWORD) {
                setDocenteView(true);
                resetFormsAndModals();
                showMessage("Accesso Docente riuscito!", 'success');
            } else {
                showMessage("Credenziali Docente errate.", 'error');
            }
        });
        
        document.getElementById('logout-docente-btn').addEventListener('click', () => {
            setDocenteView(false);
            showMessage("Logout Docente effettuato.", 'success');
        });

        // Logica Esportazione CSV
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            
            const allData = [
                ...currentBookings.map(b => ({ 
                    ...b, 
                    Status: 'Attiva', 
                    CancellationReason: 'N/A', 
                    CancellationDate: 'N/A',
                    RegistrationDate: b.createdAt?.toDate ? b.createdAt.toDate().toISOString() : 'N/D',
                })),
                ...currentCancellations.map(c => ({ 
                    ...c, 
                    Status: 'Annullata', 
                    CancellationReason: c.cancellationReason || 'Non fornita', 
                    CancellationDate: c.cancelledAt?.toDate ? c.cancelledAt.toDate().toISOString() : 'N/D',
                    RegistrationDate: c.createdAt?.toDate ? c.createdAt.toDate().toISOString() : 'N/D', 
                }))
            ];

            if (allData.length === 0) {
                showMessage("Nessun dato da esportare.", 'error');
                return;
            }

            const headers = [
                'Status', 'Codice Prenotazione', 'Nome Studente', 'Email', 'Telefono', 'Corso', 'Data Stage', 
                'Scuola Media', 'Data Iscrizione', 'Motivazione Annullamento', 'Data Annullamento', 'ID Firestore'
            ];
            
            const csvRows = [];
            csvRows.push(headers.join(';')); 

            allData.forEach(item => {
                const sanitize = (str) => (str || '').toString().replace(/;/g, ',').replace(/\n/g, ' '); 

                const row = [
                    sanitize(item.Status), 
                    sanitize(item.bookingCode), 
                    sanitize(item.studentName), 
                    sanitize(item.studentEmail), 
                    sanitize(item.studentPhone), 
                    sanitize(item.courseName),
                    sanitize(item.date),
                    sanitize(item.studentSchool), 
                    sanitize(item.RegistrationDate),
                    sanitize(item.CancellationReason),
                    sanitize(item.CancellationDate),
                    sanitize(item.docId),
                ];
                csvRows.push(row.join(';'));
            });

            // Aggiungi BOM per la corretta visualizzazione di caratteri speciali/accenti in Excel
            const bom = "\ufeff"; 
            const csvString = bom + csvRows.join('\n');
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `monitoraggio_stage_its_cg_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage("Esportazione CSV completata! Apri il file con Excel per la visualizzazione tabellare.", 'success');
        });
        
        // Funzione per eliminare tutti i documenti in una collezione
        async function deleteCollectionContents(collectionPath) {
            const collectionRef = collection(db, collectionPath);
            const snapshot = await getDocs(collectionRef); 
            
            const deletePromises = [];
            snapshot.docs.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref));
            });
            
            await Promise.all(deletePromises);
            return snapshot.size; 
        }

        // Logica Eliminazione Dati Totale
        docenteDeleteForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="spinner mr-2 border-red-500 border-t-red-700"></div> Eliminazione in corso...';

            const password = document.getElementById('docente-delete-password').value;

            if (password !== DOCENTE_PASSWORD) {
                showMessage("Password non corretta. Eliminazione annullata.", 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Conferma Eliminazione Dati';
                return;
            }

            if (!db) {
                showMessage("Errore: Database non pronto.", 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Conferma Eliminazione Dati';
                return;
            }

            try {
                const bookingsDeleted = await deleteCollectionContents(BOOKINGS_COLLECTION_PATH);
                const cancellationsDeleted = await deleteCollectionContents(CANCELLATIONS_COLLECTION_PATH);

                showMessage(`Eliminazione completata! Cancellate ${bookingsDeleted} prenotazioni attive e ${cancellationsDeleted} annullamenti.`, 'success');
                resetFormsAndModals();
                
            } catch (error) {
                console.error("Errore durante l'eliminazione globale:", error);
                showMessage(`Errore critico durante l'eliminazione: ${error.message}.`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Conferma Eliminazione Dati';
            }
        });

        
        // --- Logica Booking e Cancellazione (Firestore) ---
        
        function openBookingModal(event) {
            const { courseId, courseName, date } = event.target.dataset;
            document.getElementById('modal-course-name').textContent = courseName;
            document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('booking-course-id').value = courseId;
            document.getElementById('booking-date').value = date;
            bookingModal.classList.remove('hidden');
        }

        async function generateBookingPdf(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica');

            doc.setFontSize(18);
            doc.setTextColor(30, 58, 138); // Indigo-700
            doc.text("Conferma Prenotazione Ministage Orientamento", 10, 20);

            doc.setFontSize(11);
            doc.setTextColor(55, 65, 81); // Gray-700
            doc.text(`Stage: ${data.courseName}`, 10, 35);
            doc.text(`Data: ${new Date(data.date).toLocaleDateString('it-IT')}`, 10, 42);
            doc.text(`Codice Prenotazione: ${data.bookingCode}`, 10, 49);

            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0); 
            doc.text("Dati Studente Iscritto:", 10, 65);
            doc.setFontSize(11);
            doc.text(`Nome e Cognome dello Studente: ${data.studentName}`, 10, 75); 
            doc.text(`Scuola Media: ${data.studentSchool}`, 10, 82); 
            doc.text(`Email: ${data.studentEmail}`, 10, 89);
            doc.text(`Cellulare: ${data.studentPhone}`, 10, 96);
            
            doc.setDrawColor(200);
            doc.line(10, 102, 200, 102);

            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81);
            const confirmationText = `La prenotazione per lo studente ${data.studentName}, relativa allo stage in data ${new Date(data.date).toLocaleDateString('it-IT')} per l'indirizzo ${data.courseName} e identificata dal codice ${data.bookingCode}, √® stata confermata.`;
            doc.text(confirmationText, 10, 112, { maxWidth: 190 });
            
            // AVVISO OBBLIGATORIO NEL PDF (Testo Modificato)
            doc.setFontSize(10);
            doc.setTextColor(185, 28, 28); // Dark Red
            const warningText = "‚ö†Ô∏è Questo documento di conferma √® OBBLIGATORIO e DEVE essere presentato all'ingresso il giorno dello stage. La visualizzazione del documento da dispositivo (es. smartphone) √® ammessa.";
            doc.text(warningText, 10, 125, { maxWidth: 190 });

            doc.setFontSize(9);
            const noteText = "N.B. Conservare questo documento. Per annullare la prenotazione, devi **rientrare nello stesso link** dell'applicazione, **cliccare il pulsante 'Annulla la mia Prenotazione'** (in alto) e inserire il codice riportato qui sopra.";
            doc.setTextColor(239, 68, 68); // Red-500
            doc.text(noteText, 10, 135, { maxWidth: 190 });

            doc.setFontSize(8);
            doc.setTextColor(156, 163, 175); // Gray-400
            doc.text(PDF_SIGNATURE, 10, 280);
            
            return doc.output('datauristring');
        }

        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const confirmBtn = document.getElementById('confirm-booking-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="spinner mr-2"></div> Elaborazione...';
            
            const courseId = document.getElementById('booking-course-id').value;
            const date = document.getElementById('booking-date').value;
            const studentName = document.getElementById('student-name').value.trim();
            const studentSchool = document.getElementById('student-school').value.trim();
            const studentEmail = document.getElementById('student-email').value.trim();
            const studentPhone = document.getElementById('student-phone').value.trim();
            
            const bookingCode = generateUniqueCode(10);
            const courseName = document.getElementById('modal-course-name').textContent;
            const availabilityKey = `${courseId}-${date}`;


            if (currentAvailability[availabilityKey] <= 0) {
                 showMessage("Spiacenti, i posti sono stati esauriti o non aggiornati! Riprova.", 'error');
                 resetFormsAndModals();
                 return;
            }

            try {
                const bookingData = { 
                    courseId, date, studentName, studentSchool, studentEmail, studentPhone, bookingCode, courseName, 
                    createdAt: serverTimestamp(),
                    userId: userId, 
                    docId: null 
                };

                if (!db) throw new Error("Database non inizializzato.");
                const docRef = await addDoc(collection(db, BOOKINGS_COLLECTION_PATH), bookingData);
                
                bookingData.docId = docRef.id;

                const pdfBase64 = await generateBookingPdf(bookingData);

                showMessage(`Prenotazione registrata con successo! Codice: ${bookingCode}. Scarica il PDF.`, 'success');
                resetFormsAndModals();

                const downloadLink = document.createElement('a');
                downloadLink.href = pdfBase64;
                downloadLink.download = `Conferma_Stage_${bookingCode}.pdf`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);


            } catch (error) {
                console.error("Errore durante l'aggiunta della prenotazione:", error);
                showMessage(`Errore critico (DB): ${error.message}. Riprova.`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Conferma e Genera PDF';
            }
        });

        async function generateCancellationPdf(data) {
             const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica');

            doc.setFontSize(18);
            doc.setTextColor(185, 28, 28); // Red-700
            doc.text("Conferma Cancellazione Prenotazione", 10, 20);

            doc.setFontSize(11);
            doc.setTextColor(55, 65, 81);
            doc.text(`Codice Prenotazione Annullato: ${data.bookingCode}`, 10, 35);
            
            doc.setDrawColor(200);
            doc.line(10, 50, 200, 50);

            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81);
            
            const cancellationText = `L'annullamento della prenotazione per lo stage con codice **${data.bookingCode}** √® stato **confermato con successo** in data odierna. Il posto per lo stage √® stato ripristinato e reso disponibile.`;
            doc.text(cancellationText, 10, 60, { maxWidth: 190 });

            doc.setFontSize(10);
            const motivazioneText = `Motivazione fornita: ${data.cancellationReason || 'Nessuna motivazione fornita.'}`;
            doc.setTextColor(0, 0, 0); 
            doc.text(motivazioneText, 10, 80, { maxWidth: 190 });
            
            doc.setFontSize(9);
            const noteText = "Si prega di notare che la cancellazione √® definitiva. Per una nuova prenotazione sar√† necessario utilizzare il modulo online, se i posti sono ancora disponibili.";
            doc.setTextColor(30, 58, 138); // Indigo-700
            doc.text(noteText, 10, 100, { maxWidth: 190 });


            doc.setFontSize(8);
            doc.setTextColor(156, 163, 175);
            doc.text(PDF_SIGNATURE, 10, 280);

            return doc.output('datauristring');
        }


        cancellationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const confirmBtn = document.getElementById('confirm-cancellation-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="spinner mr-2 border-red-500 border-t-red-700"></div> Cancellazione...';

            const bookingCode = document.getElementById('cancellation-code').value.trim().toUpperCase();
            const cancellationReason = document.getElementById('cancellation-reason').value.trim();

            if (!db) {
                showMessage("Errore: Database non pronto.", 'error');
                return;
            }

            try {
                const bookingsRef = collection(db, BOOKINGS_COLLECTION_PATH);
                
                const q = query(bookingsRef, 
                    where('bookingCode', '==', bookingCode)
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showMessage("Prenotazione non trovata. Controlla il codice.", 'error');
                    resetFormsAndModals();
                    return;
                }

                const docToDelete = snapshot.docs[0];
                const bookingData = docToDelete.data(); 

                const cancellationLog = {
                    ...bookingData, 
                    cancellationReason: cancellationReason,
                    cancelledAt: serverTimestamp(),
                    cancellationUserId: userId,
                };
                await addDoc(collection(db, CANCELLATIONS_COLLECTION_PATH), cancellationLog);

                await deleteDoc(doc(db, BOOKINGS_COLLECTION_PATH, docToDelete.id));
                
                const pdfBase64 = await generateCancellationPdf(cancellationLog);
                
                showMessage("Cancellazione completata! Il posto √® stato ripristinato.", 'success');
                resetFormsAndModals();
                
                const downloadLink = document.createElement('a');
                downloadLink.href = pdfBase64;
                downloadLink.download = `Cancellazione_Stage_${bookingCode}.pdf`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);


            } catch (error) {
                console.error("Errore durante la cancellazione:", error);
                showMessage(`Errore di cancellazione (DB): ${error.message}.`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Conferma Cancellazione';
            }
        });

        // Avvia l'inizializzazione Firebase all'avvio
        window.onload = () => {
            initializeFirebase();
            // Assicura che l'utente veda la vista iniziale corretta dopo il caricamento dei dati
            renderStudentView('home'); 
        };

    </script>
</body>
</html>
