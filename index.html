<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Orientamento ITSCG Primo Levi</title>
    <!-- Caricamento Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configurazione per usare il font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .tab-active {
            border-bottom: 4px solid #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Messaggio di sistema/popup (nascosto di default) -->
    <div id="message-box" class="hidden fixed top-20 right-5 p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 opacity-0 text-white font-medium"></div>

    <!-- Header e Controlli Globali -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-indigo-700 tracking-tight">ITSCG Stage Booking 2025</h1>
            <div class="flex items-center space-x-4">
                <span id="current-user-id" class="text-sm text-gray-500 hidden sm:inline"></span>
                <button id="open-cancellation-modal-btn" class="px-3 py-1 text-sm font-medium rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition duration-150 shadow-md">
                    Annulla Prenotazione
                </button>
                <button id="open-docente-login-btn" class="px-3 py-1 text-sm font-medium rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition duration-150 shadow-md">
                    Docente Login
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-10 pb-20">

        <!-- Stato di Caricamento -->
        <div id="loading-view" class="flex flex-col items-center justify-center p-8 text-gray-500 transition duration-500">
            <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-status" class="mt-3 text-lg font-medium">Inizializzazione connessione...</p>
        </div>


        <!-- VISTA DOCENTE -->
        <div id="docente-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-extrabold text-gray-900">Dashboard Docente</h2>
                <div class="flex space-x-3">
                    <button id="export-csv-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                        Esporta CSV Completo
                    </button>
                    <button id="open-delete-modal-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                        Elimina Tutti i Dati
                    </button>
                    <button id="logout-docente-btn" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-white border border-indigo-600 rounded-lg hover:bg-indigo-50 transition duration-150 shadow-md">
                        Logout
                    </button>
                </div>
            </div>

            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-bookings" class="tab-button py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 tab-active">
                        Prenotazioni Attive
                    </button>
                    <button id="tab-cancellations" class="tab-button py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150">
                        Storico Annullamenti
                    </button>
                </nav>
            </div>

            <!-- Contenuto Prenotazioni Attive -->
            <div id="content-bookings" class="mt-8">
                <div class="flex justify-end mb-4">
                    <label for="date-filter" class="block text-sm font-medium text-gray-700 mr-3 self-center">Filtra per Data:</label>
                    <select id="date-filter" class="mt-1 block w-full md:w-1/3 py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <!-- Opzioni aggiunte da JS -->
                    </select>
                </div>
                <div class="overflow-x-auto shadow-lg rounded-xl">
                    <table class="min-w-full divide-y divide-gray-200 bg-white">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Studente</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Corso</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data (Giorno/Ora)</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scuola Media</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contatti</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Iscritto il</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body" class="divide-y divide-gray-200">
                            <!-- Righe Prenotazioni aggiunte da JS -->
                        </tbody>
                    </table>
                </div>
                <p id="no-bookings-message" class="mt-4 text-center text-lg text-gray-500 p-8 hidden border border-gray-300 rounded-xl bg-white shadow-inner">Nessuna prenotazione attiva trovata per il filtro selezionato.</p>
            </div>

            <!-- Contenuto Storico Annullamenti -->
            <div id="content-cancellations" class="mt-8 hidden">
                <div class="overflow-x-auto shadow-lg rounded-xl">
                    <table class="min-w-full divide-y divide-gray-200 bg-white">
                        <thead class="bg-red-50">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Studente</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Corso</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Originale</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Annullamento</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivazione</th>
                            </tr>
                        </thead>
                        <tbody id="cancellations-table-body" class="divide-y divide-gray-200">
                            <!-- Righe Annullamenti aggiunte da JS -->
                        </tbody>
                    </table>
                </div>
                <p id="no-cancellations-message" class="mt-4 text-center text-lg text-gray-500 p-8 hidden border border-gray-300 rounded-xl bg-white shadow-inner">Nessuna prenotazione annullata trovata nello storico.</p>
            </div>
        </div>
        <!-- FINE VISTA DOCENTE -->


        <!-- VISTA STUDENTE -->
        <div id="student-main-view" class="mt-8">

            <!-- Home Studente: Selezione Corso -->
            <div id="course-selection-view" class="transition duration-300">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-8">Scegli il Tuo Indirizzo di Stage</h2>
                <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards dei corsi renderizzate da JS -->
                </div>
            </div>

            <!-- Selezione Data per il Corso Scelto -->
            <div id="date-selection-view" class="hidden transition duration-300">
                <button id="back-to-courses-btn" class="flex items-center text-indigo-600 hover:text-indigo-800 transition duration-150 mb-6 font-medium">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Torna alla selezione degli indirizzi
                </button>

                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Date Stage per: <span id="selected-course-title" class="text-indigo-600"></span></h2>
                <div id="dates-container" class="space-y-4">
                    <!-- Date e disponibilità renderizzate da JS -->
                </div>
            </div>
        </div>
        <!-- FINE VISTA STUDENTE -->

    </main>

    <!-- MODALI -->

    <!-- 1. Modale di Prenotazione (Booking) -->
    <div id="booking-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-indigo-700">Conferma la Tua Prenotazione</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <p class="text-lg font-semibold text-gray-800 mb-4" id="modal-booking-info">
                    <!-- Info dinamiche di data e corso -->
                </p>

                <form id="booking-form" class="space-y-4">
                    <input type="hidden" id="modal-course-id">
                    <input type="hidden" id="modal-course-name">
                    <input type="hidden" id="modal-date">
                    
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome e Cognome Studente (*)</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="student-school" class="block text-sm font-medium text-gray-700">Scuola Media di Provenienza</label>
                        <input type="text" id="student-school" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="student-email" class="block text-sm font-medium text-gray-700">Email Genitore/Referente (*)</label>
                        <input type="email" id="student-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="student-phone" class="block text-sm font-medium text-gray-700">Numero di Telefono (Opzionale)</label>
                        <input type="tel" id="student-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    
                    <div class="pt-4 border-t flex justify-end">
                        <button type="submit" class="px-6 py-2 text-base font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg">
                            Conferma Iscrizione
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 2. Modale di Annullamento (Cancellation) -->
    <div id="cancellation-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-red-600">Annulla Prenotazione</h3>
                    <button id="close-cancellation-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <form id="cancellation-form" class="space-y-4">
                    <div>
                        <label for="cancellation-code" class="block text-sm font-medium text-gray-700">Codice di Prenotazione (es. F2A4C6B8)</label>
                        <input type="text" id="cancellation-code" required maxlength="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border uppercase">
                    </div>
                    <div>
                        <label for="cancellation-reason" class="block text-sm font-medium text-gray-700">Motivazione (Opzionale)</label>
                        <textarea id="cancellation-reason" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border"></textarea>
                    </div>
                    <p class="text-xs text-red-500">Attenzione: l'annullamento è definitivo e libera il posto.</p>
                    <div class="pt-4 border-t flex justify-end">
                        <button type="submit" class="px-6 py-2 text-base font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-lg">
                            Conferma Annullamento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 3. Modale Login Docente -->
    <div id="docente-login-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Accesso Area Docente</h3>
                    <button id="close-docente-modal-btn" onclick="resetFormsAndModals()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <form id="docente-login-form" class="space-y-4">
                    <div>
                        <label for="docente-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="docente-username" required value="docente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="docente-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="docente-password" required value="its2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div class="pt-4 border-t flex justify-end">
                        <button type="submit" class="px-6 py-2 text-base font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg">
                            Accedi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 4. Modale di ELIMINAZIONE DATI (Admin) -->
    <div id="delete-data-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-red-700">Conferma Eliminazione TOTALE Dati</h3>
                    <button id="close-delete-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <p class="text-red-600 font-semibold mb-4">ATTENZIONE: Questa operazione è irreversibile ed eliminerà TUTTE le prenotazioni e gli annullamenti dal database.</p>

                <form id="docente-delete-form" class="space-y-4">
                    <div>
                        <label for="delete-password" class="block text-sm font-medium text-gray-700">Inserisci la Password Docente per confermare</label>
                        <input type="password" id="delete-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border">
                    </div>
                    <div class="pt-4 border-t flex justify-end">
                        <button type="submit" id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150 shadow-md">Conferma Eliminazione Dati</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Piè di pagina -->
    <div class="mt-16 pt-8 border-t border-gray-300 flex justify-center">
        <div class="w-full max-w-4xl text-center">
            <p class="text-xs text-gray-400">© 2025 ITSCG Primo Levi. Tutti i diritti riservati.</p>
        </div>
    </div>

    <!-- Importazioni JavaScript e Logica di Applicazione Firebase -->
    <script type="module">
        // Importazioni Firebase necessarie per Auth, Firestore, e Query
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, where, addDoc, 
            onSnapshot, serverTimestamp, deleteDoc, getDocs, doc, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabili Globali del Canvas per Firebase (Obbligatorie) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let firebaseConfig = {};

        if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            console.warn("Configurazione Firebase non fornita dall'ambiente. Utilizzo della configurazione specifica dell'utente.");
            
            // ====================================================================================
            // CONFIGURAZIONE FIREBASE SPECIFICA (Configurazione fittizia/placeholder)
            // ====================================================================================
            firebaseConfig = {
                apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
                authDomain: "progetto-63fb3.firebaseapp.com",
                projectId: "progetto-63fb3", 
                storageBucket: "progetto-63fb3.firebasestorage.app",
                messagingSenderId: "883088850197",
                appId: "1:883088850197:web:29b8573ea43555041b3d1c",
            };
        }
        // --- Fine Configurazione Firebase ---

        // Variabili Firebase e Stato
        let db = null;
        let auth = null;
        let userId = null;
        let isDocente = false; 
        
        // --- Stato Globale ---
        const MAX_SLOTS = 4; // Posti fissi per ogni slot data/corso
        let currentBookings = []; 
        let currentCancellations = [];
        let currentAvailability = {}; 
        let currentCourseId = null; // Nuovo stato per la navigazione
        
        // Credenziali Docente Fisse
        const DOCENTE_USERNAME = 'docente';
        const DOCENTE_PASSWORD = 'its2025'; // Password usata anche per eliminazione dati

        // Struttura fissa dei corsi
        const COURSES = [
            { id: 'Liceo Scientifico Opzione Scienze Applicate', name: 'Liceo Scientifico Opzione Scienze Applicate ', color: 'bg-blue-100 text-blue-800', icon: '<svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2zM9 8h6M9 12h6M9 16h6"></path></svg>' }, 
            { id: 'sistema-moda', name: 'Sistema Moda', color: 'bg-pink-100 text-pink-800', icon: '<svg class="w-8 h-8 text-pink-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13v8a1 1 0 001 1h8a1 1 0 001-1v-8m-7 0H7m0 0l-1-2m1 2l1-2m7 2h-4m-4 0l-1-2m1 2l1-2m-1 2H7"></path></svg>' },
            { id: 'relazioni-marketing', name: 'Relazioni Internazionali per il Marketing', color: 'bg-yellow-100 text-yellow-800', icon: '<svg class="w-8 h-8 text-yellow-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v5m0 0a2 2 0 100 4 2 2 0 000-4zM12 8V6a2 2 0 100-4 2 2 0 000 4z"></path></svg>' },
            { id: 'logistica-quadriennale', name: 'Logistica Corso Quadriennale', color: 'bg-indigo-100 text-indigo-800', icon: '<svg class="w-8 h-8 text-indigo-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-4 4m0 0l-4-4m4 4V7"></path></svg>' },
            { id: 'costruzione-territorio', name: 'Costruzione Ambiente e Territorio', color: 'bg-purple-100 text-purple-800', icon: '<svg class="w-8 h-8 text-purple-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>' }
        ];

        const PROGRAMMED_DATES_WITH_TIMES = [
            // Novembre - Lunedì (12:50-14:40)
            { date: '2025-11-03', day: 'Lunedì', time: '12:50-14:40' },
            // Novembre - Mercoledì (8:50-10:50)
            { date: '2025-11-05', day: 'Mercoledì', time: '8:50-10:50' },
            // Novembre - Lunedì (12:50-14:40)
            { date: '2025-11-10', day: 'Lunedì', time: '12:50-14:40' },
            // Novembre - Mercoledì (8:50-10:50)
            { date: '2025-11-12', day: 'Mercoledì', time: '8:50-10:50' },
            // Novembre - Lunedì (12:50-14:40)
            { date: '2025-11-17', day: 'Lunedì', time: '12:50-14:40' },
            // Novembre - Mercoledì (8:50-10:50)
            { date: '2025-11-19', day: 'Mercoledì', time: '8:50-10:50' },
            // Novembre - Lunedì (12:50-14:40)
            { date: '2025-11-24', day: 'Lunedì', time: '12:50-14:40' },
            // Novembre - Mercoledì (8:50-10:50)
            { date: '2025-11-26', day: 'Mercoledì', time: '8:50-10:50' },
            
            // Dicembre - Lunedì (12:50-14:40)
            { date: '2025-12-01', day: 'Lunedì', time: '12:50-14:40' },
            // Dicembre - Mercoledì (8:50-10:50)
            { date: '2025-12-03', day: 'Mercoledì', time: '8:50-10:50' },
            // Dicembre - Lunedì (12:50-14:40)
            { date: '2025-12-08', day: 'Lunedì', time: '12:50-14:40' },
            // Dicembre - Mercoledì (8:50-10:50)
            { date: '2025-12-10', day: 'Mercoledì', time: '8:50-10:50' },
            // Dicembre - Lunedì (12:50-14:40)
            { date: '2025-12-15', day: 'Lunedì', time: '12:50-14:40' },
            // Dicembre - Mercoledì (8:50-10:50)
            { date: '2025-12-17', day: 'Mercoledì', time: '8:50-10:50' }
        ];
        const PROGRAMMED_DATES = PROGRAMMED_DATES_WITH_TIMES;
        
        const PDF_SIGNATURE = 'ITSCG PRIMO LEVI DI SEREGNO VIA BRIANTINA 68 - Funzioni Orientamento: Prof. ssa Laura Corvi e Prof. ssa Maria Grazia Calabrese';
        
        // Elementi DOM
        const coursesContainer = document.getElementById('courses-container');
        const messageBox = document.getElementById('message-box');
        const bookingModal = document.getElementById('booking-modal');
        const cancellationModal = document.getElementById('cancellation-modal');
        const bookingForm = document.getElementById('booking-form');
        const cancellationForm = document.getElementById('cancellation-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingStatus = document.getElementById('loading-status');
        const docenteLoginModal = document.getElementById('docente-login-modal');
        const docenteLoginForm = document.getElementById('docente-login-form');
        const studentMainView = document.getElementById('student-main-view');
        const docenteView = document.getElementById('docente-view');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const dateFilter = document.getElementById('date-filter');
        const deleteDataModal = document.getElementById('delete-data-modal');
        const docenteDeleteForm = document.getElementById('docente-delete-form');
        
        // Nuovi elementi per la navigazione Studente
        const courseSelectionView = document.getElementById('course-selection-view');
        const dateSelectionView = document.getElementById('date-selection-view');
        const selectedCourseTitle = document.getElementById('selected-course-title');
        const datesContainer = document.getElementById('dates-container');
        
        const BOOKINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/bookings`;
        const CANCELLATIONS_COLLECTION_PATH = `/artifacts/${appId}/public/data/cancellations`;


        // --- Funzioni di Utility ---

        function generateUniqueCode(length = 10) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `fixed top-20 right-5 p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 opacity-100 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            messageBox.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 5000); 
        }

        function resetFormsAndModals() {
            bookingModal.classList.add('hidden');
            cancellationModal.classList.add('hidden');
            docenteLoginModal.classList.add('hidden');
            deleteDataModal.classList.add('hidden');
            bookingForm.reset();
            cancellationForm.reset();
            docenteLoginForm.reset();
            docenteDeleteForm.reset();
        }
        
        // --- Gestione Modali e Navigazione ---
        document.getElementById('close-modal-btn').addEventListener('click', resetFormsAndModals);
        document.getElementById('open-cancellation-modal-btn').addEventListener('click', () => cancellationModal.classList.remove('hidden'));
        document.getElementById('close-cancellation-modal-btn').addEventListener('click', resetFormsAndModals);
        document.getElementById('open-docente-login-btn').addEventListener('click', () => docenteLoginModal.classList.remove('hidden'));
        document.getElementById('open-delete-modal-btn').addEventListener('click', () => deleteDataModal.classList.remove('hidden'));
        document.getElementById('close-delete-modal-btn').addEventListener('click', resetFormsAndModals);
        
        // Listener per tornare alla Home Studente
        document.getElementById('back-to-courses-btn').addEventListener('click', () => {
            currentCourseId = null;
            renderStudentView('home');
        });


        // Funzione per gestire la visualizzazione Studente
        function renderStudentView(view) {
            if (view === 'home') {
                courseSelectionView.classList.remove('hidden');
                dateSelectionView.classList.add('hidden');
                renderCourses(); // Mostra i box degli indirizzi
            } else if (view === 'dates' && currentCourseId) {
                courseSelectionView.classList.add('hidden');
                dateSelectionView.classList.remove('hidden');
                renderCourseDates(currentCourseId); // Mostra le date per l'indirizzo
            }
        }
        
        // Gestione Tab Docente
        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            document.getElementById(`tab-${tabId}`).classList.add('tab-active');
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            
            if (tabId === 'bookings') {
                renderDocenteDashboard(); 
            } else if (tabId === 'cancellations') {
                renderCancellationsDashboard();
            }
        }

        document.getElementById('tab-bookings').addEventListener('click', () => switchTab('bookings'));
        document.getElementById('tab-cancellations').addEventListener('click', () => switchTab('cancellations'));


        // --- Inizializzazione Firebase e Autenticazione ---
        function initializeFirebase() {
            if (!firebaseConfig.projectId) {
                loadingSpinner.classList.add('hidden');
                loadingStatus.textContent = "ATTENZIONE: Configurazione Firebase incompleta. Impossibile connettersi.";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Errore nell'autenticazione Firebase:", error);
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID(); 
                    }
                    currentUserIdDisplay.textContent = `ID Utente: ${userId.substring(0, 8)}...`;
                    setupRealtimeListener();
                });

            } catch(e) {
                loadingStatus.textContent = `Errore di inizializzazione: ${e.message}`;
                console.error("Errore Firebase:", e);
            }
        }

        // --- Funzione di Ascolto in Tempo Reale (REAL-TIME LISTENER) ---
        function setupRealtimeListener() {
            if (!db) return;

            loadingSpinner.classList.remove('hidden');
            loadingStatus.textContent = "Caricamento disponibilità in tempo reale...";
            
            const bookingsRef = collection(db, BOOKINGS_COLLECTION_PATH);
            const cancellationsRef = collection(db, CANCELLATIONS_COLLECTION_PATH);

            const q = query(bookingsRef); 
            const qCancellations = query(cancellationsRef);

            // Listener per le Prenotazioni Attive (Aggiorna Disponibilità e Dashboard)
            onSnapshot(q, (snapshot) => {
                currentBookings = [];
                currentAvailability = {};
                
                // 1. Inizializza la disponibilità completa
                COURSES.forEach(course => {
                    PROGRAMMED_DATES_WITH_TIMES.forEach(dateObj => {
                        const key = `${course.id}-${dateObj.date}`;
                        currentAvailability[key] = MAX_SLOTS;
                    });
                });

                // 2. Processa i dati e calcola la disponibilità rimanente
                snapshot.forEach((doc) => {
                    const booking = doc.data();
                    const key = `${booking.courseId}-${booking.date}`;
                    
                    if (currentAvailability[key] > 0) {
                        currentAvailability[key]--;
                    }
                    currentBookings.push({ ...booking, docId: doc.id });
                });
                
                currentBookings.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

                // 3. Aggiorna l'interfaccia utente
                if (!isDocente) {
                    renderStudentView(currentCourseId ? 'dates' : 'home');
                } else {
                    populateDateFilter(); 
                    renderDocenteDashboard(); 
                }

                loadingSpinner.classList.add('hidden');
                loadingStatus.textContent = "Disponibilità Aggiornata in Tempo Reale";

            }, (error) => {
                console.error("Errore onSnapshot Bookings:", error);
                loadingSpinner.classList.add('hidden');
                loadingStatus.textContent = `Errore di connessione al database: ${error.message}`;
            });
            
            // Listener per le Cancellazioni
             onSnapshot(qCancellations, (snapshot) => {
                currentCancellations = [];
                snapshot.forEach((doc) => {
                    const cancellation = doc.data();
                    currentCancellations.push({ ...cancellation, docId: doc.id });
                });
                
                currentCancellations.sort((a, b) => {
                    const dateA = a.cancelledAt?.toDate ? a.cancelledAt.toDate().getTime() : 0;
                    const dateB = b.cancelledAt?.toDate ? b.cancelledAt.toDate().getTime() : 0;
                    return dateB - dateA; // Ordine Decrescente
                });

                if (isDocente) {
                    renderCancellationsDashboard();
                }
            }, (error) => {
               console.error("Errore onSnapshot Cancellations:", error);
            });
            
            dateFilter.addEventListener('change', renderDocenteDashboard);
        }
        
        // --- Gestione Filtro Date Docente ---
        function populateDateFilter() {
            dateFilter.innerHTML = `<option value="all">Tutte le Date</option>`;
            PROGRAMMED_DATES_WITH_TIMES.forEach(dateObj => {
                const dateDisplay = `${dateObj.day}, ${new Date(dateObj.date).toLocaleDateString('it-IT', { year: 'numeric', month: 'short', day: 'numeric' })} ${dateObj.time}`;
                const option = document.createElement('option');
                option.value = dateObj.date;
                option.textContent = dateDisplay;
                dateFilter.appendChild(option);
            });
        }

        // --- Rendering Date per il Corso Selezionato ---
        function renderCourseDates(courseId) {
            datesContainer.innerHTML = '';
            const course = COURSES.find(c => c.id === courseId);
            if (!course) return;

            selectedCourseTitle.textContent = course.name;

            let datesHtml = '';
            PROGRAMMED_DATES_WITH_TIMES.forEach(dateObject => {
                const date = dateObject.date;
                const day = dateObject.day;
                const timeSlot = dateObject.time;
                const key = `${courseId}-${date}`;
                const availableSlots = currentAvailability[key] !== undefined 
                    ? currentAvailability[key] 
                    : MAX_SLOTS;
                const bookedCount = MAX_SLOTS - availableSlots;
                const isFull = availableSlots <= 0;

                let badgeClass = 'bg-green-600';
                let badgeText = `${availableSlots} posti disponibili`;
                if (isFull) {
                    badgeClass = 'bg-red-600';
                    badgeText = 'Posti Esauriti';
                } else if (availableSlots <= 1) {
                    badgeClass = 'bg-orange-500';
                    badgeText = 'Ultimo posto disponibile';
                }
                const slotsDisplay = `${bookedCount}/${MAX_SLOTS}`;

                datesHtml += `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border border-gray-200 rounded-xl bg-gray-50 hover:bg-white transition duration-150">
                        <div class="font-bold text-lg text-gray-800 mb-2 sm:mb-0">
                            ${day}, ${new Date(date).toLocaleDateString('it-IT', { year: 'numeric', month: 'short', day: 'numeric' })}
                            <span class="block text-indigo-600 font-semibold text-base">${timeSlot}</span>
                        </div>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                            <span class="text-sm font-bold text-white px-3 py-1 rounded-full ${badgeClass}">
                                ${badgeText} (${slotsDisplay})
                            </span>
                            <button
                                data-course-id="${course.id}"
                                data-course-name="${course.name}"
                                data-date="${date}"
                                data-time="${timeSlot}" ${isFull ? 'disabled' : ''}
                                class="book-btn px-4 py-2 text-sm font-medium rounded-lg transition duration-150 ${isFull ? 'bg-gray-400 cursor-not-allowed text-gray-700' : 'bg-indigo-600 text-white hover:bg-indigo-700'}"
                            >
                                Prenota Ora
                            </button>
                        </div>
                    </div>
                `;
            });
            datesContainer.innerHTML = datesHtml;
            document.querySelectorAll('.book-btn').forEach(button => {
                button.addEventListener('click', openBookingModal);
            });
        }

        // --- Rendering Prenotazioni Attive Docente ---
        function renderDocenteDashboard() {
            const selectedDate = dateFilter.value;
            const tableBody = document.getElementById('bookings-table-body');
            const noBookingsMessage = document.getElementById('no-bookings-message');
            tableBody.innerHTML = '';

            const filteredBookings = currentBookings.filter(booking => 
                selectedDate === 'all' || booking.date === selectedDate
            );

            if (filteredBookings.length === 0) {
                noBookingsMessage.classList.remove('hidden');
                return;
            }
            noBookingsMessage.classList.add('hidden');

            filteredBookings.forEach(booking => {
                // Trova day e time per la data corrente
                const dateObj = PROGRAMMED_DATES_WITH_TIMES.find(d => d.date === booking.date);
                const day = dateObj ? dateObj.day : '';
                const time = dateObj ? dateObj.time : '';
                const dateDisplay = dateObj
                    ? `${day}, ${new Date(booking.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' })} (${time})`
                    : new Date(booking.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                const createdAt = booking.createdAt?.toDate ? booking.createdAt.toDate().toLocaleDateString('it-IT') : 'N/D';
                const row = `
                    <tr class="hover:bg-indigo-50 transition duration-100">
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${booking.bookingCode}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-800">${booking.studentName}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">${booking.courseName}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-semibold text-indigo-600">${dateDisplay}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 max-w-xs">${booking.studentSchool || 'N/D'}</td> 
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 break-words">${booking.studentEmail}<br/>${booking.studentPhone}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // --- Dashboard Cancellazioni ---
        function renderCancellationsDashboard() {
            const tableBody = document.getElementById('cancellations-table-body');
            const noCancellationsMessage = document.getElementById('no-cancellations-message');
            tableBody.innerHTML = '';

            if (currentCancellations.length === 0) {
                noCancellationsMessage.classList.remove('hidden');
                return;
            }
            noCancellationsMessage.classList.add('hidden');

            currentCancellations.forEach(cancellation => {
                const dateObj = PROGRAMMED_DATES_WITH_TIMES.find(d => d.date === cancellation.date);
                const day = dateObj ? dateObj.day : '';
                const time = dateObj ? dateObj.time : '';
                const originalDate = dateObj
                    ? `${day}, ${new Date(cancellation.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' })} (${time})`
                    : cancellation.date ? new Date(cancellation.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }) : 'N/D';
                const cancelledAt = cancellation.cancelledAt?.toDate ? cancellation.cancelledAt.toDate().toLocaleDateString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'N/D';
                const row = `
                    <tr class="hover:bg-red-50 transition duration-100">
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-red-700">${cancellation.bookingCode}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-800">${cancellation.studentName || 'N/D'}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">${cancellation.courseName || 'N/D'}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-red-400">${originalDate}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-semibold text-red-500">${cancelledAt}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 break-words">${cancellation.cancellationReason || 'Motivazione non fornita'}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        // Logica Login Docente
        docenteLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('docente-username').value;
            const password = document.getElementById('docente-password').value;
            
            if (username === DOCENTE_USERNAME && password === DOCENTE_PASSWORD) {
                setDocenteView(true);
                resetFormsAndModals();
                showMessage("Accesso Docente riuscito!", 'success');
            } else {
                showMessage("Credenziali Docente errate.", 'error');
            }
        });
        
        document.getElementById('logout-docente-btn').addEventListener('click', () => {
            setDocenteView(false);
            showMessage("Logout Docente effettuato.", 'success');
        });

        // Logica Esportazione CSV
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            
            const allData = [
                ...currentBookings.map(b => ({ 
                    ...b, 
                    Status: 'Attiva', 
                    CancellationReason: 'N/A', 
                    CancellationDate: 'N/A',
                    RegistrationDate: b.createdAt?.toDate ? b.createdAt.toDate().toISOString() : 'N/D',
                })),
                ...currentCancellations.map(c => ({ 
                    ...c, 
                    Status: 'Annullata', 
                    CancellationReason: c.cancellationReason || 'Non fornita', 
                    CancellationDate: c.cancelledAt?.toDate ? c.cancelledAt.toDate().toISOString() : 'N/D',
                    RegistrationDate: c.createdAt?.toDate ? c.createdAt.toDate().toISOString() : 'N/D', 
                }))
            ];

            if (allData.length === 0) {
                showMessage("Nessun dato da esportare.", 'error');
                return;
            }

            const headers = [
                'Status', 'Codice Prenotazione', 'Nome Studente', 'Email', 'Telefono', 'Corso', 'Data Stage', 
                'Scuola Media', 'Data Iscrizione', 'Motivazione Annullamento', 'Data Annullamento', 'ID Firestore'
            ];
            
            const csvRows = [];
            csvRows.push(headers.join(';')); 

            allData.forEach(item => {
                const sanitize = (str) => (str || '').toString().replace(/;/g, ',').replace(/\n/g, ' '); 

                const row = [
                    sanitize(item.Status), 
                    sanitize(item.bookingCode), 
                    sanitize(item.studentName), 
                    sanitize(item.studentEmail), 
                    sanitize(item.studentPhone), 
                    sanitize(item.courseName),
                    sanitize(item.date),
                    sanitize(item.studentSchool), 
                    sanitize(item.RegistrationDate),
                    sanitize(item.CancellationReason),
                    sanitize(item.CancellationDate),
                    sanitize(item.docId),
                ];
                csvRows.push(row.join(';'));
            });

            // Aggiungi BOM per la corretta visualizzazione di caratteri speciali/accenti in Excel
            const bom = "\ufeff"; 
            const csvString = bom + csvRows.join('\n');
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `monitoraggio_stage_its_cg_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage("Esportazione CSV completata! Apri il file con Excel per la visualizzazione tabellare.", 'success');
        });
        
        // Funzione per eliminare tutti i documenti in una collezione
        async function deleteCollectionContents(collectionPath) {
            const collectionRef = collection(db, collectionPath);
            console.log(`Inizio eliminazione di tutti i documenti in: ${collectionPath}`);
            
            try {
                const snapshot = await getDocs(collectionRef);
                const deletePromises = [];
                let deleteCount = 0;
                
                snapshot.forEach((docEntry) => {
                    deletePromises.push(deleteDoc(doc(db, collectionPath, docEntry.id)));
                    deleteCount++;
                });

                await Promise.all(deletePromises);
                console.log(`Eliminati ${deleteCount} documenti dalla collezione ${collectionPath}.`);
                return deleteCount;
            } catch (error) {
                console.error(`Errore durante l'eliminazione dei documenti in ${collectionPath}:`, error);
                throw new Error(`Impossibile eliminare i dati: ${error.message}`);
            }
        }

        // Logica di Eliminazione Dati Totale (Docente)
        docenteDeleteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('delete-password').value;
            
            if (password !== DOCENTE_PASSWORD) {
                showMessage("Password errata. L'operazione è stata annullata.", 'error');
                return;
            }

            try {
                showMessage("Avvio eliminazione dati in corso...", 'warning');
                
                // 1. Elimina le prenotazioni attive
                const countBookings = await deleteCollectionContents(BOOKINGS_COLLECTION_PATH);
                
                // 2. Elimina le prenotazioni annullate (storico)
                const countCancellations = await deleteCollectionContents(CANCELLATIONS_COLLECTION_PATH);

                resetFormsAndModals();
                showMessage(`Eliminazione completata! Cancellati ${countBookings} prenotazioni e ${countCancellations} annullamenti.`, 'success');

            } catch (error) {
                showMessage(`Errore critico durante l'eliminazione: ${error.message}`, 'error');
            }
        });
        
        // Funzione per il cambio di visualizzazione Studente/Docente
        function setDocenteView(isDocenteMode) {
            isDocente = isDocenteMode;
            if (isDocente) {
                studentMainView.classList.add('hidden');
                docenteView.classList.remove('hidden');
                // Nascondi lo stato di caricamento quando si passa alla vista docente
                document.getElementById('loading-view').classList.add('hidden'); 
                switchTab('bookings'); // Inizializza la dashboard delle prenotazioni
            } else {
                studentMainView.classList.remove('hidden');
                docenteView.classList.add('hidden');
                // Nascondi lo stato di caricamento quando si passa alla vista studente
                document.getElementById('loading-view').classList.add('hidden');
                renderStudentView(currentCourseId ? 'dates' : 'home'); // Torna alla selezione corsi
            }
        }
        
        // Inizializzazione Logica Prenotazione (Studente)
        bookingForm.addEventListener('submit', handleBookingSubmit);
        cancellationForm.addEventListener('submit', handleCancellationSubmit);
        
        function openBookingModal(e) {
            const btn = e.currentTarget;
            document.getElementById('student-name').value = '';
            document.getElementById('student-email').value = '';
            document.getElementById('student-phone').value = '';
            document.getElementById('student-school').value = '';
            
            document.getElementById('modal-course-name').value = btn.dataset.courseName;
            document.getElementById('modal-course-id').value = btn.dataset.courseId;
            document.getElementById('modal-date').value = btn.dataset.date;
            
            const dateDisplay = new Date(btn.dataset.date).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('modal-booking-info').textContent = `${btn.dataset.courseName} il ${dateDisplay} (${btn.dataset.time})`;

            bookingModal.classList.remove('hidden');
        }
        
        // Funzione di gestione della prenotazione (Aggiungi a Firestore)
        async function handleBookingSubmit(e) {
            e.preventDefault();
            
            const studentName = document.getElementById('student-name').value;
            const studentEmail = document.getElementById('student-email').value;
            const studentPhone = document.getElementById('student-phone').value;
            const studentSchool = document.getElementById('student-school').value;
            const courseId = document.getElementById('modal-course-id').value;
            const courseName = document.getElementById('modal-course-name').value;
            const date = document.getElementById('modal-date').value;
            
            if (!studentName || !studentEmail || !courseId || !date) {
                showMessage("Compila tutti i campi obbligatori (*).", 'error');
                return;
            }

            // Controllo disponibilità finale (ridondante ma importante)
            const key = `${courseId}-${date}`;
            if (currentAvailability[key] <= 0) {
                showMessage("Posti esauriti in questo slot. Riprova con un'altra data.", 'error');
                resetFormsAndModals();
                return;
            }
            
            const bookingCode = generateUniqueCode(8);

            try {
                await addDoc(collection(db, BOOKINGS_COLLECTION_PATH), {
                    userId,
                    bookingCode,
                    studentName,
                    studentEmail,
                    studentPhone,
                    studentSchool,
                    courseId,
                    courseName,
                    date,
                    createdAt: serverTimestamp()
                });
                
                resetFormsAndModals();
                showMessage(`Prenotazione confermata! Codice: ${bookingCode}. Ricordalo per una eventuale cancellazione.`, 'success');

            } catch (error) {
                console.error("Errore durante l'aggiunta della prenotazione:", error);
                showMessage("Errore durante la prenotazione. Riprova più tardi.", 'error');
            }
        }

        // Funzione di gestione della cancellazione (Sposta/Elimina da Firestore)
        async function handleCancellationSubmit(e) {
            e.preventDefault();
            
            const codeToCancel = document.getElementById('cancellation-code').value.toUpperCase().trim();
            const cancellationReason = document.getElementById('cancellation-reason').value;

            if (!codeToCancel) {
                showMessage("Inserisci il codice di prenotazione.", 'error');
                return;
            }

            try {
                // 1. Trova la prenotazione da eliminare
                const bookingToCancel = currentBookings.find(b => b.bookingCode === codeToCancel);

                if (!bookingToCancel) {
                    showMessage("Codice di prenotazione non trovato o già annullato.", 'error');
                    return;
                }
                
                // 2. Registra la cancellazione nella collezione "cancellations"
                await addDoc(collection(db, CANCELLATIONS_COLLECTION_PATH), {
                    ...bookingToCancel,
                    cancellationReason: cancellationReason,
                    originalDocId: bookingToCancel.docId,
                    cancelledAt: serverTimestamp()
                });
                
                // 3. Elimina la prenotazione attiva
                await deleteDoc(doc(db, BOOKINGS_COLLECTION_PATH, bookingToCancel.docId));
                
                resetFormsAndModals();
                showMessage(`Prenotazione con codice ${codeToCancel} annullata con successo.`, 'success');
                
            } catch (error) {
                console.error("Errore durante la cancellazione:", error);
                showMessage("Errore durante l'annullamento. Controlla il codice e riprova.", 'error');
            }
        }
        
        // Funzione di rendering dei box corsi per la Home Studente
        function renderCourses() {
            coursesContainer.innerHTML = '';
            COURSES.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = `p-6 rounded-2xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.02] cursor-pointer ${course.color}`;
                courseCard.setAttribute('data-course-id', course.id);
                courseCard.innerHTML = `
                    ${course.icon}
                    <h3 class="text-xl font-extrabold mb-1">${course.name}</h3>
                    <p class="text-sm">Clicca per visualizzare le date disponibili per lo stage.</p>
                `;
                courseCard.addEventListener('click', () => {
                    currentCourseId = course.id;
                    renderStudentView('dates');
                });
                coursesContainer.appendChild(courseCard);
            });
        }
        
        // Chiamata di avvio
        initializeFirebase();
        setLogLevel('debug'); // Imposta il livello di log per Firebase
    </script>

</body>
</html>
