<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITSCG | Prenotazione Ministage Orientamento</title>
    <!-- Tailwind CSS CDN per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- jsPDF CDN per la generazione dei PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .tab-active { border-bottom: 4px solid #4f46e5; color: #4f46e5; font-weight: 700; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 1.5rem; height: 1.5rem; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-button-primary { background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .modal-button-primary:hover:enabled { background-color: #4338ca; }
        .modal-button-secondary { background-color: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .modal-button-secondary:hover { background-color: #e5e7eb; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Messaggio di Notifica (SnackBar) -->
    <div id="message-box" class="fixed top-5 right-5 hidden p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 opacity-0" role="alert"></div>

    <!-- Contenitore Principale -->
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header e Stato -->
        <header class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-4 md:mb-0">ITSCG | Prenotazioni Ministage</h1>
            <div class="flex items-center space-x-4">
                <!-- Bottone Chatbot -->
                <a href="chatbot.html" target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 01-4.24-.958l-.6 1.258A1 1 0 014 20.94V19a9 9 0 1117-7z"></path></svg>
                    <span>Chatbot ITSCG</span>
                </a>
                <button id="open-docente-login-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md">
                    Accesso Docente
                </button>
            </div>
        </header>

        <!-- Spinner di Caricamento Iniziale -->
        <div id="loading-spinner" class="flex flex-col items-center justify-center p-12 bg-white rounded-xl shadow-lg mt-12">
            <div class="spinner border-indigo-500 border-t-indigo-700 w-8 h-8"></div>
            <p id="loading-status" class="mt-4 text-lg text-gray-600">Connessione a Firebase...</p>
        </div>

        <!-- ========================================================================= -->
        <!-- VISTA STUDENTE (Default) -->
        <!-- ========================================================================= -->
        <div id="student-main-view" class="space-y-8 hidden">
            
            <!-- SEZIONE INFORMATIVA DETTAGLIATA -->
            <section class="bg-indigo-50 p-6 rounded-xl shadow-md border-l-4 border-indigo-500 space-y-4">
                <p class="text-lg font-extrabold text-red-600">‚ö†Ô∏è ATTENZIONE: Documento di Conferma Importante!</p>
                <p class="text-gray-700">Conservare il PDF di conferma e presentarlo all'ingresso il giorno dello Stage. </p>
                <p class="text-gray-700">Presentarsi almeno 10 minuti prima dell' orario indicato </p>
                
                <p class="text-sm text-gray-500 pt-3">Organizzazione a cura delle Funzioni Orientamento: Prof. ssa Laura Corvi e Prof. ssa Mariagrazia Calabrese. ITSCG PRIMO LEVI DI SEREGNO, VIA BRIANTINA 68.</p>

                <div id="cancellation-section" class="pt-4 border-t border-indigo-200 flex justify-between items-center">
                    <p class="text-yellow-800 font-medium">Hai gi√† prenotato ma devi annullare? Utilizza il tuo codice prenotazione.</p>
                    <button id="open-cancellation-modal-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 shadow-lg">
                        Annulla Prenotazione
                    </button>
                </div>
            </section>

            <!-- 1. SELEZIONE CORSO -->
            <section id="course-selection-view" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Scegli l'Indirizzo di Studio per il tuo Ministage:</h2>
                <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- I corsi saranno renderizzati qui -->
                </div>
            </section>

            <!-- 2. SELEZIONE DATA (Dopo aver scelto il corso) -->
            <section id="date-selection-view" class="hidden bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center space-x-4 mb-6">
                    <button id="back-to-courses-btn" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Torna agli Indirizzi
                    </button>
                    <h2 id="selected-course-title" class="text-xl font-bold text-gray-800"></h2>
                </div>
                <div id="dates-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Le date saranno renderizzate qui -->
                </div>
            </section>
        </div>
        
        <!-- VISTA DOCENTE e MODALI (omesse per brevit√†, sono nel codice JS/HTML) -->
        <div id="docente-view" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-indigo-700">Dashboard Docente | Gestione Prenotazioni</h2>
                    <button id="logout-docente-btn" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200 shadow-md">
                        Logout
                    </button>
                </div>

                <!-- Tabs di Navigazione -->
                <div class="flex border-b mb-6">
                    <button id="tab-bookings" class="tab-button px-4 py-2 text-gray-600 hover:text-indigo-700 transition duration-150">Prenotazioni Attive</button>
                    <button id="tab-cancellations" class="tab-button px-4 py-2 text-gray-600 hover:text-indigo-700 transition duration-150">Log Annullamenti</button>
                </div>
                
                <!-- Contenuto Tab 1: Prenotazioni Attive -->
                <div id="content-bookings" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex space-x-4">
                            <label class="flex items-center space-x-2 text-gray-600">
                                Filtra per Data:
                                <select id="date-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                            </label>
                            <button id="export-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-xl transition duration-200">
                                Esporta in CSV
                            </button>
                        </div>
                        <button id="open-delete-modal-btn" class="bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-xl transition duration-200">
                            Cancella tutti i dati
                        </button>
                    </div>

                    <div class="overflow-x-auto shadow-md rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Codice</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Studente</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Corso</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Data</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Scuola Media</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Contatti</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Iscritto il</th>
                                </tr>
                            </thead>
                            <tbody id="bookings-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- I dati delle prenotazioni attive saranno qui -->
                            </tbody>
                        </table>
                        <p id="no-bookings-message" class="hidden p-4 text-center text-gray-500">Nessuna prenotazione attiva trovata per il filtro selezionato.</p>
                    </div>
                </div>

                <!-- Contenuto Tab 2: Log Annullamenti -->
                <div id="content-cancellations" class="tab-content hidden">
                    <p class="text-sm text-gray-500 mb-4">Registro di tutte le prenotazioni che sono state annullate dagli utenti. Questi posti sono stati ripristinati.</p>
                    <div class="overflow-x-auto shadow-md rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Codice Annullato</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Nome Studente</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Corso</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Data Originale</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Annullato il</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">Motivazione</th>
                                </tr>
                            </thead>
                            <tbody id="cancellations-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- I log di cancellazione saranno qui -->
                            </tbody>
                        </table>
                        <p id="no-cancellations-message" class="hidden p-4 text-center text-gray-500">Nessun annullamento registrato finora.</p>
                    </div>
                </div>

            </div>
        </div>
        <!-- Inserimento Modali qui per completezza (omesse in questa preview per brevit√†, sono nel codice finale) -->
        <!-- Modale Prenotazione Studente -->
        <div id="booking-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-indigo-700">Conferma Iscrizione al Ministage</h3>
                <p class="text-gray-600">Stai per prenotare un posto per l'indirizzo <strong id="modal-course-name"></strong> in data <strong id="modal-date"></strong>.</p>
                
                <form id="booking-form" class="space-y-4">
                    <input type="hidden" id="booking-course-id" name="courseId">
                    <input type="hidden" id="booking-date" name="date">

                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome e Cognome dello Studente <span class="text-red-500">*</span></label>
                        <input type="text" id="student-name" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-school" class="block text-sm font-medium text-gray-700">Scuola Media di Provenienza <span class="text-red-500">*</span></label>
                        <input type="text" id="student-school" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-email" class="block text-sm font-medium text-gray-700">Email di Contatto (per la conferma PDF) <span class="text-red-500">*</span></label>
                        <input type="email" id="student-email" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-phone" class="block text-sm font-medium text-gray-700">Cellulare di Contatto <span class="text-red-500">*</span></label>
                        <input type="tel" id="student-phone" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <p class="text-xs text-red-500">ATTENZIONE: Verr√† generato un PDF di conferma OBBLIGATORIO da presentare all'ingresso.</p>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-modal-btn" class="modal-button-secondary">Chiudi</button>
                        <button type="submit" id="confirm-booking-btn" class="modal-button-primary flex items-center">
                            Conferma e Genera PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale Annullamento Studente -->
        <div id="cancellation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-red-600">Annulla la tua Prenotazione</h3>
                <p class="text-gray-600">Inserisci il codice di prenotazione che hai ricevuto via PDF per annullare la tua iscrizione.</p>
                
                <form id="cancellation-form" class="space-y-4">
                    <div>
                        <label for="cancellation-code" class="block text-sm font-medium text-gray-700">Codice Prenotazione (es: ABC123XYZ) <span class="text-red-500">*</span></label>
                        <input type="text" id="cancellation-code" required minlength="10" maxlength="10" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500 uppercase">
                    </div>
                    <div>
                        <label for="cancellation-reason" class="block text-sm font-medium text-gray-700">Motivazione (Opzionale)</label>
                        <textarea id="cancellation-reason" rows="3" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-cancellation-modal-btn" class="modal-button-secondary">Annulla</button>
                        <button type="submit" id="confirm-cancellation-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-md flex items-center">
                            Annulla la mia Prenotazione
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale Login Docente -->
        <div id="docente-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4">
                <h3 class="text-xl font-bold text-gray-800">Accesso Riservato Docente</h3>
                <p class="text-sm text-gray-500">Inserisci le credenziali per accedere alla dashboard di gestione.</p>
                
                <form id="docente-login-form" class="space-y-4">
                    <div>
                        <label for="docente-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="docente-username" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="docente-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="docente-password" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="document.getElementById('docente-login-modal').classList.add('hidden')" class="modal-button-secondary">Chiudi</button>
                        <button type="submit" class="modal-button-primary">
                            Accedi
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modale Eliminazione Dati Docente -->
        <div id="delete-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
                <h3 class="text-2xl font-bold text-red-700">CANCELLAZIONE DATI COMPLETA</h3>
                <p class="text-sm text-gray-600">Questa azione √® IRREVERSIBILE ed eliminer√† tutte le prenotazioni e i log di annullamento dal database Firebase per questo progetto.</p>
                <p class="text-sm font-bold text-red-700">Procedi solo se necessario per azzerare l'anno accademico.</p>
                
                <form id="docente-delete-form" class="space-y-4">
                    <div>
                        <label for="docente-delete-password" class="block text-sm font-medium text-gray-700">Password Docente per Conferma <span class="text-red-500">*</span></label>
                        <input type="password" id="docente-delete-password" required class="mt-1 block w-full border-red-300 rounded-lg shadow-sm p-3 border focus:ring-red-500 focus:border-red-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="close-delete-modal-btn" class="modal-button-secondary">Annulla</button>
                        <button type="submit" id="confirm-delete-btn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-md flex items-center">
                            CONFERMA ELIMINAZIONE DATI
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- ========================================================================= -->
    <!-- LOGICA JAVASCRIPT E FIREBASE (Modulo Unico) -->
    <!-- ========================================================================= -->
    <script type="module">
        // =========================================================================
        // üìö IMPORTAZIONI FIREBASE
        // =========================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, where, addDoc, 
            onSnapshot, serverTimestamp, deleteDoc, getDocs, doc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        
        // =========================================================================
        // ‚öôÔ∏è CONFIGURAZIONE FIREBASE E VARIABILI DI STATO
        // =========================================================================
        
        // CONFIGURAZIONE FIREBASE FORNITA DALL'UTENTE (Hardcoded)
        const firebaseConfig = {
            apiKey: "AIzaSyAP-Bmf02SZp4o6K2z2B1GgIlUJ3Wuc8Zk",
            authDomain: "progetto-63fb3.firebaseapp.com",
            projectId: "progetto-63fb3", 
            storageBucket: "progetto-63fb3.firebasestorage.app",
            messagingSenderId: "883088850197",
            appId: "1:883088850197:web:29b8573ea43555041b3d1c",
            measurementId: "G-2PNR8PQHDR"
        };

        // Utilizziamo l'ID del progetto come ID dell'App per costruire il percorso Firestore
        // Questo √® necessario per rispettare la struttura di sicurezza
        const PROJECT_ID_AS_APP_ID = firebaseConfig.projectId;
        
        // Variabili Firebase e Stato Globale
        let db = null;
        let auth = null;
        let userId = null;
        let isDocente = false; 
        
        const MAX_SLOTS = 4; // Posti fissi per ogni slot data/corso
        let currentBookings = []; 
        let currentCancellations = [];
        let currentAvailability = {}; 
        let currentCourseId = null; 
        
        // Credenziali Docente Fisse
        const DOCENTE_USERNAME = 'docente';
        const DOCENTE_PASSWORD = 'its2025';

        const BOOKINGS_COLLECTION_PATH = `/artifacts/${PROJECT_ID_AS_APP_ID}/public/data/bookings`;
        const CANCELLATIONS_COLLECTION_PATH = `/artifacts/${PROJECT_ID_AS_APP_ID}/public/data/cancellations`;
        
        // Struttura fissa dei corsi (omessa per brevit√†, stessa del precedente)
        const COURSES = [
            { id: 'SA', name: 'Liceo Scientifico Opzione Scienze Applicate ', color: 'bg-blue-100 text-blue-800', icon: '<svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2zM9 8h6M9 12h6M9 16h6"></path></svg>' }, 
            { id: 'SM', name: 'Sistema Moda', color: 'bg-pink-100 text-pink-800', icon: '<svg class="w-8 h-8 text-pink-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13v8a1 1 0 001 1h8a1 1 0 001-1v-8m-7 0H7m0 0l-1-2m1 2l1-2m7 2h-4m-4 0l-1-2m1 2l1-2m-1 2H7"></path></svg>' },
            { id: 'RM', name: 'Relazioni Internazionali per il Marketing', color: 'bg-yellow-100 text-yellow-800', icon: '<svg class="w-8 h-8 text-yellow-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v5m0 0a2 2 0 100 4 2 2 0 000-4zM12 8V6a2 2 0 100-4 2 2 0 000 4z"></path></svg>' },
            { id: 'LG', name: 'Logistica Corso Quadriennale', color: 'bg-indigo-100 text-indigo-800', icon: '<svg class="w-8 h-8 text-indigo-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-4 4m0 0l-4-4m4 4V7"></path></svg>' },
            { id: 'CT', name: 'Costruzione Ambiente e Territorio', color: 'bg-purple-100 text-purple-800', icon: '<svg class="w-8 h-8 text-purple-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>' }
        ];

        // Array di Date (Normalizzato per il codice: Data|Giorno|Orario) (omesse per brevit√†, stesse del precedente)
        const DATE_ORARI_SCIENZE_APPLICATE = [
            '2025-11-03|Luned√¨|11:50-13:50', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|11:50-13:50', 
            '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|11:50-13:50', '2025-11-19|Mercoled√¨|08:50-10:50', 
            '2025-11-24|Luned√¨|11:50-13:50', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|11:50-13:50', 
            '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|11:50-13:50', 
            '2025-12-15|Luned√¨|11:50-13:50', '2025-12-17|Mercoled√¨|08:50-10:50'
        ];
        const DATE_ORARI_REL_MARKETING = [
            '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', 
            '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', 
            '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', 
            '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', 
            '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50'
        ];
        const DATE_ORARI_LOGISTICA = [
            '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', 
            '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', 
            '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', 
            '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-15|Luned√¨|12:50-14:40', 
            '2025-12-17|Mercoled√¨|08:50-10:50'
        ];
        const DATE_ORARI_CAT = [
            '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', 
            '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', 
            '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', 
            '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', 
            '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50'
        ];
        const DATE_ORARI_SISTEMA_MODA = [
            '2025-11-03|Luned√¨|12:50-14:40', '2025-11-05|Mercoled√¨|08:50-10:50', '2025-11-10|Luned√¨|12:50-14:40', 
            '2025-11-12|Mercoled√¨|08:50-10:50', '2025-11-17|Luned√¨|12:50-14:40', '2025-11-19|Mercoled√¨|08:50-10:50', 
            '2025-11-24|Luned√¨|12:50-14:40', '2025-11-26|Mercoled√¨|08:50-10:50', '2025-12-01|Luned√¨|12:50-14:40', 
            '2025-12-03|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|08:50-10:50', '2025-12-10|Mercoled√¨|13:00-14:40', 
            '2025-12-15|Luned√¨|12:50-14:40', '2025-12-17|Mercoled√¨|08:50-10:50'
        ];
            
        // Elementi DOM (omessi per brevit√†, stessi del precedente)
        const coursesContainer = document.getElementById('courses-container');
        const messageBox = document.getElementById('message-box');
        const bookingModal = document.getElementById('booking-modal');
        const cancellationModal = document.getElementById('cancellation-modal');
        const bookingForm = document.getElementById('booking-form');
        const cancellationForm = document.getElementById('cancellation-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingStatus = document.getElementById('loading-status');
        const docenteLoginModal = document.getElementById('docente-login-modal');
        const docenteLoginForm = document.getElementById('docente-login-form');
        const studentMainView = document.getElementById('student-main-view');
        const docenteView = document.getElementById('docente-view');
        const dateFilter = document.getElementById('date-filter');
        const deleteDataModal = document.getElementById('delete-data-modal');
        const docenteDeleteForm = document.getElementById('docente-delete-form');
        const courseSelectionView = document.getElementById('course-selection-view');
        const dateSelectionView = document.getElementById('date-selection-view');
        const selectedCourseTitle = document.getElementById('selected-course-title');
        const datesContainer = document.getElementById('dates-container');


        // =========================================================================
        // üõ†Ô∏è FUNZIONI DI UTILITY E GESTIONE DELLO STATO (omesse per brevit√†, stesse del precedente)
        // =========================================================================

        function generateUniqueCode(length = 10) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `fixed top-20 right-5 p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300 opacity-100 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white`;
            messageBox.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 5000); 
        }

        function resetFormsAndModals() {
            document.getElementById('confirm-booking-btn').disabled = false;
            document.getElementById('confirm-booking-btn').innerHTML = 'Conferma e Genera PDF';
            document.getElementById('confirm-cancellation-btn').disabled = false;
            document.getElementById('confirm-cancellation-btn').innerHTML = 'Annulla la mia Prenotazione';

            bookingModal.classList.add('hidden');
            cancellationModal.classList.add('hidden');
            docenteLoginModal.classList.add('hidden');
            deleteDataModal.classList.add('hidden');
            
            if (bookingForm) bookingForm.reset();
            if (cancellationForm) cancellationForm.reset();
            if (docenteLoginForm) docenteLoginForm.reset();
            if (docenteDeleteForm) docenteDeleteForm.reset();
        }
        
        document.getElementById('close-modal-btn')?.addEventListener('click', resetFormsAndModals);
        document.getElementById('open-cancellation-modal-btn')?.addEventListener('click', () => cancellationModal.classList.remove('hidden'));
        document.getElementById('close-cancellation-modal-btn')?.addEventListener('click', resetFormsAndModals);
        document.getElementById('open-docente-login-btn')?.addEventListener('click', () => docenteLoginModal.classList.remove('hidden'));
        document.getElementById('open-delete-modal-btn')?.addEventListener('click', () => deleteDataModal.classList.remove('hidden'));
        document.getElementById('close-delete-modal-btn')?.addEventListener('click', resetFormsAndModals);
        
        document.getElementById('back-to-courses-btn')?.addEventListener('click', () => {
            currentCourseId = null;
            renderStudentView('home');
        });

        function getCourseDatesArray(courseId) {
            switch (courseId) {
                case 'SA': return DATE_ORARI_SCIENZE_APPLICATE;
                case 'SM': return DATE_ORARI_SISTEMA_MODA;
                case 'RM': return DATE_ORARI_REL_MARKETING;
                case 'LG': return DATE_ORARI_LOGISTICA;
                case 'CT': return DATE_ORARI_CAT;
                default: return [];
            }
        }


        // =========================================================================
        // üåê FUNZIONI FIREBASE (INIT & LISTENERS) - LOGICA AGGIORNATA
        // =========================================================================

        /**
         * @description Inizializza Firebase e avvia l'ascolto dei dati in tempo reale.
         */
        function initializeFirebase() {
            try {
                // Inizializza l'app Firebase con la configurazione fornita
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // getAnalytics(app); // Non essenziale per la logica di prenotazione
                setLogLevel('error'); 

                loadingStatus.textContent = "Autenticazione in corso...";

                // Esegue l'autenticazione anonima per l'utente (Studente)
                signInAnonymously(auth).then(() => {
                    // 1. Ascolta i cambiamenti di autenticazione
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            
                            // Nasconde lo spinner e mostra la vista studente
                            loadingSpinner.classList.add('hidden');
                            studentMainView.classList.remove('hidden');

                            // 2. Avvia i listener di Firestore DOPO l'autenticazione
                            setupFirestoreListeners();
                        } else {
                            // Questo caso non dovrebbe accadere dopo signInAnonymously
                            loadingStatus.textContent = "Errore di connessione al server: utente non definito.";
                        }
                    });
                }).catch(error => {
                    console.error("Errore firma anonima:", error);
                    loadingStatus.textContent = "Errore di connessione al server: autenticazione fallita.";
                });

            } catch (error) {
                console.error("Errore di inizializzazione Firebase:", error);
                loadingStatus.textContent = `Errore critico: ${error.message}`;
            }
        }

        /**
         * @description Ascolta in tempo reale le prenotazioni e gli annullamenti.
         */
        function setupFirestoreListeners() {
            // Listener 1: Prenotazioni Attive
            onSnapshot(collection(db, BOOKINGS_COLLECTION_PATH), (snapshot) => {
                const bookings = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                currentBookings = bookings;
                
                // Ricalcola la disponibilit√† ad ogni cambiamento
                calculateAvailability(bookings);
                
                if (isDocente) {
                    renderDocenteDashboard();
                } else {
                    renderStudentView(currentCourseId ? 'dates' : 'home');
                }
            }, (error) => {
                console.error("Errore onSnapshot Bookings:", error);
                showMessage("Errore nel caricamento delle prenotazioni attive.", 'error');
            });

            // Listener 2: Cancellazioni (Usato solo per la dashboard)
            onSnapshot(collection(db, CANCELLATIONS_COLLECTION_PATH), (snapshot) => {
                currentCancellations = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                
                if (isDocente) {
                    renderCancellationsDashboard();
                }
            }, (error) => {
                console.error("Errore onSnapshot Cancellations:", error);
            });
        }
        
        // --- Le funzioni di rendering Studente e Docente, Logica di Prenotazione/Cancellazione e Utility PDF (escluso PDF_SIGNATURE che √® stato unificato) sono le stesse del file precedente e mantengono la piena funzionalit√† ---

        const PDF_SIGNATURE = 'Organizzazione e Contatti: Prof. ssa Laura Corvi e Prof. ssa Mariagrazia Calabrese. ITSCG PRIMO LEVI DI SEREGNO, VIA BRIANTINA 68.';

        function calculateAvailability(bookings) {
            currentAvailability = {};
            
            COURSES.forEach(course => {
                const dateArray = getCourseDatesArray(course.id);
                dateArray.forEach(item => {
                    const [dateString] = item.split('|');
                    const key = `${course.id}-${dateString}`;
                    currentAvailability[key] = MAX_SLOTS;
                });
            });

            bookings.forEach(booking => {
                const key = `${booking.courseId}-${booking.date}`;
                if (currentAvailability[key] !== undefined && currentAvailability[key] > 0) {
                    currentAvailability[key] -= 1;
                }
            });
        }

        function renderStudentView(view) {
            if (view === 'home') {
                courseSelectionView.classList.remove('hidden');
                dateSelectionView.classList.add('hidden');
                renderCourses();
            } else if (view === 'dates' && currentCourseId) {
                courseSelectionView.classList.add('hidden');
                dateSelectionView.classList.remove('hidden');
                renderCourseDates(currentCourseId);
            }
        }

        function renderCourses() {
            coursesContainer.innerHTML = '';
            COURSES.forEach(course => {
                const element = document.createElement('div');
                element.className = `p-4 rounded-xl shadow-lg cursor-pointer transform hover:scale-[1.02] transition duration-300 ${course.color} border border-transparent hover:border-indigo-400`;
                element.innerHTML = `
                    ${course.icon}
                    <h3 class="text-xl font-bold mb-1">${course.name}</h3>
                    <p class="text-sm">Clicca per scegliere la data e prenotare.</p>
                `;
                element.addEventListener('click', () => {
                    currentCourseId = course.id;
                    renderStudentView('dates');
                });
                coursesContainer.appendChild(element);
            });
        }

        function renderCourseDates(courseId) {
            const course = COURSES.find(c => c.id === courseId);
            if (!course) return;

            selectedCourseTitle.textContent = `Date disponibili per: ${course.name}`;
            datesContainer.innerHTML = '';
            
            const dateArray = getCourseDatesArray(courseId);

            dateArray.forEach(item => {
                const [dateString, day, time] = item.split('|').map(s => s.trim());
                const availabilityKey = `${courseId}-${dateString}`;
                const availableSlots = currentAvailability[availabilityKey] || 0;
                const isFull = availableSlots <= 0;
                const dateDisplay = new Date(dateString).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                
                const element = document.createElement('button');
                element.className = `p-4 rounded-xl shadow-md transition duration-200 w-full text-left flex justify-between items-center transform hover:translate-y-[-1px] ${
                    isFull ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white border border-gray-100 hover:bg-indigo-50 text-gray-800'
                }`;
                element.disabled = isFull;
                element.innerHTML = `
                    <div>
                        <span class="font-bold text-lg">${day} ${dateDisplay}</span>
                        <span class="block text-sm text-indigo-600 font-medium">${time}</span>
                    </div>
                    <div class="text-right ${isFull ? 'text-red-500' : 'text-green-600'}">
                        <span class="font-extrabold text-xl">${availableSlots}</span>
                        <span class="block text-xs uppercase">${isFull ? 'COMPLETO' : 'posti liberi'}</span>
                    </div>
                `;
                element.dataset.courseId = courseId;
                element.dataset.courseName = course.name;
                element.dataset.date = dateString; 
                
                if (!isFull) {
                    element.addEventListener('click', (e) => openBookingModal(e));
                }
                datesContainer.appendChild(element);
            });
        }

        function openBookingModal(event) {
            const button = event.target.closest('button');
            if (!button) return;

            const { courseId, courseName, date } = button.dataset;

            document.getElementById('modal-course-name').textContent = courseName;
            document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); 
            document.getElementById('booking-course-id').value = courseId;
            document.getElementById('booking-date').value = date;

            const storedEmail = localStorage.getItem('lastStudentEmail');
            if (storedEmail) document.getElementById('student-email').value = storedEmail;

            bookingModal.classList.remove('hidden');
        }

        function setDocenteView(enabled) {
            isDocente = enabled;
            if (enabled) {
                studentMainView.classList.add('hidden');
                docenteView.classList.remove('hidden');
                document.getElementById('open-docente-login-btn').classList.add('hidden');
                document.getElementById('logout-docente-btn').classList.remove('hidden');
                populateDateFilter();
                switchTab('bookings');
            } else {
                studentMainView.classList.remove('hidden');
                docenteView.classList.add('hidden');
                document.getElementById('open-docente-login-btn').classList.remove('hidden');
                document.getElementById('logout-docente-btn').classList.add('hidden');
                renderStudentView(currentCourseId ? 'dates' : 'home'); 
            }
        }
        
        document.getElementById('logout-docente-btn')?.addEventListener('click', () => {
            setDocenteView(false);
            showMessage("Logout Docente effettuato.", 'success');
        });

        function populateDateFilter() {
            dateFilter.innerHTML = '<option value="all">Tutte le Date</option>';
            const uniqueDates = new Set();
            COURSES.forEach(course => {
                getCourseDatesArray(course.id).forEach(item => {
                    const [dateString, day] = item.split('|');
                    uniqueDates.add(`${dateString}|${day}`);
                });
            });

            Array.from(uniqueDates).sort().forEach(dateItem => {
                const [dateString, day] = dateItem.split('|');
                const dateDisplay = new Date(dateString).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                const option = document.createElement('option');
                option.value = dateString;
                option.textContent = `${dateDisplay} (${day.trim()})`;
                dateFilter.appendChild(option);
            });

            dateFilter.removeEventListener('change', renderDocenteDashboard);
            dateFilter.addEventListener('change', renderDocenteDashboard);
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            document.getElementById(`tab-${tabId}`).classList.add('tab-active');
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            
            if (tabId === 'bookings') {
                renderDocenteDashboard(); 
            } else if (tabId === 'cancellations') {
                renderCancellationsDashboard();
            }
        }

        document.getElementById('tab-bookings')?.addEventListener('click', () => switchTab('bookings'));
        document.getElementById('tab-cancellations')?.addEventListener('click', () => switchTab('cancellations'));

        function renderDocenteDashboard() {
            const selectedDate = dateFilter.value;
            const tableBody = document.getElementById('bookings-table-body');
            const noBookingsMessage = document.getElementById('no-bookings-message');
            tableBody.innerHTML = '';

            const filteredBookings = currentBookings
                .filter(booking => selectedDate === 'all' || booking.date === selectedDate)
                .sort((a, b) => {
                    if (a.courseName < b.courseName) return -1;
                    if (a.courseName > b.courseName) return 1;
                    return a.studentName.localeCompare(b.studentName);
                });

            if (filteredBookings.length === 0) {
                noBookingsMessage.classList.remove('hidden');
                return;
            }
            noBookingsMessage.classList.add('hidden');

            filteredBookings.forEach(booking => {
                const date = new Date(booking.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                const createdAt = booking.createdAt?.toDate ? booking.createdAt.toDate().toLocaleDateString('it-IT') : 'N/D';

                const row = `
                    <tr class="hover:bg-indigo-50 transition duration-100">
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${booking.bookingCode}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-800">${booking.studentName}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">${booking.courseName}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-semibold text-indigo-600">${date}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 max-w-xs">${booking.studentSchool || 'N/D'}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 break-words">${booking.studentEmail}<br/>${booking.studentPhone}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function renderCancellationsDashboard() {
            const tableBody = document.getElementById('cancellations-table-body');
            const noCancellationsMessage = document.getElementById('no-cancellations-message');
            tableBody.innerHTML = '';

            const sortedCancellations = currentCancellations
                .sort((a, b) => {
                    const dateA = a.cancelledAt?.toDate ? a.cancelledAt.toDate() : new Date(0);
                    const dateB = b.cancelledAt?.toDate ? b.cancelledAt.toDate() : new Date(0);
                    return dateB - dateA; 
                });

            if (sortedCancellations.length === 0) {
                noCancellationsMessage.classList.remove('hidden');
                return;
            }
            noCancellationsMessage.classList.add('hidden');

            sortedCancellations.forEach(cancellation => {
                const cancelledAt = cancellation.cancelledAt?.toDate ? cancellation.cancelledAt.toDate().toLocaleDateString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'N/D';
                const originalDate = cancellation.date ? new Date(cancellation.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }) : 'N/D';

                const row = `
                    <tr class="hover:bg-red-50 transition duration-100">
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-red-700">${cancellation.bookingCode}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-800">${cancellation.studentName || 'N/D'}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">${cancellation.courseName || 'N/D'}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-red-400">${originalDate}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm font-semibold text-red-500">${cancelledAt}</td>
                        <td class="px-2 py-2 whitespace-normal text-sm text-gray-500 break-words">${cancellation.cancellationReason || 'Nessuna'}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        docenteLoginForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('docente-username').value;
            const password = document.getElementById('docente-password').value;

            if (username === DOCENTE_USERNAME && password === DOCENTE_PASSWORD) {
                setDocenteView(true);
                resetFormsAndModals();
                showMessage("Accesso Docente riuscito!", 'success');
            } else {
                showMessage("Credenziali Docente errate.", 'error');
            }
        });

        document.getElementById('export-csv-btn')?.addEventListener('click', () => {
            const headers = ["Codice Prenotazione", "Nome Studente", "Scuola Media", "Email", "Cellulare", "Corso", "Data Stage", "ID Utente", "Data Iscrizione"];
            
            const selectedDate = dateFilter.value;
            const dataToExport = currentBookings.filter(booking => 
                selectedDate === 'all' || booking.date === selectedDate
            );

            if (dataToExport.length === 0) {
                showMessage("Nessun dato da esportare per il filtro selezionato.", 'error');
                return;
            }

            let csvContent = headers.join(";") + "\n";
            dataToExport.forEach(booking => {
                const createdAt = booking.createdAt?.toDate ? booking.createdAt.toDate().toISOString() : 'N/D';
                const row = [
                    booking.bookingCode,
                    booking.studentName.replace(/;/g, ","), 
                    booking.studentSchool.replace(/;/g, ","),
                    booking.studentEmail,
                    booking.studentPhone,
                    booking.courseName.replace(/;/g, ","),
                    booking.date,
                    booking.userId,
                    createdAt
                ].map(item => `"${item}"`).join(";"); 
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Prenotazioni_Stage_${selectedDate}_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage("Esportazione CSV completata.", 'success');
        });

        docenteDeleteForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const deletePassword = document.getElementById('docente-delete-password').value;
            const confirmBtn = document.getElementById('confirm-delete-btn');
            
            if (deletePassword !== DOCENTE_PASSWORD) {
                showMessage("Password non corretta. Cancellazione annullata.", 'error');
                return;
            }
            
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="spinner mr-2 border-red-500 border-t-red-700"></div> Eliminazione...';

            try {
                if (!db) throw new Error("Database non inizializzato.");

                const bookingsRef = collection(db, BOOKINGS_COLLECTION_PATH);
                const bookingsSnapshot = await getDocs(bookingsRef);
                const deleteBookingPromises = bookingsSnapshot.docs.map(d => deleteDoc(doc(db, BOOKINGS_COLLECTION_PATH, d.id)));
                await Promise.all(deleteBookingPromises);

                const cancellationsRef = collection(db, CANCELLATIONS_COLLECTION_PATH);
                const cancellationsSnapshot = await getDocs(cancellationsRef);
                const deleteCancellationPromises = cancellationsSnapshot.docs.map(d => deleteDoc(doc(db, CANCELLATIONS_COLLECTION_PATH, d.id)));
                await Promise.all(deleteCancellationPromises);

                showMessage(`Eliminazione completa riuscita! Eliminati ${bookingsSnapshot.size} prenotazioni e ${cancellationsSnapshot.size} log.`, 'success');
                resetFormsAndModals();
                setDocenteView(true); 

            } catch (error) {
                console.error("Errore durante l'eliminazione dei dati:", error);
                showMessage(`Errore: Impossibile eliminare i dati. ${error.message}`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'CONFERMA ELIMINAZIONE DATI';
            }
        });

        async function generateBookingPdf(data) {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                showMessage("Errore: Libreria jsPDF non caricata.", 'error');
                return null;
            }

            const doc = new jsPDF();
            doc.setFont('helvetica');

            doc.setFontSize(18);
            doc.setTextColor(30, 58, 138); 
            doc.text("Conferma Prenotazione Ministage Orientamento", 10, 20);

            doc.setFontSize(11);
            doc.setTextColor(55, 65, 81); 
            doc.text(`Stage: ${data.courseName}`, 10, 35);
            doc.text(`Data: ${new Date(data.date).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 10, 42);
            doc.text(`Codice Prenotazione: ${data.bookingCode}`, 10, 49);

            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Dati Studente Iscritto:", 10, 65);
            doc.setFontSize(11);
            doc.text(`Nome e Cognome dello Studente: ${data.studentName}`, 10, 75);
            doc.text(`Scuola Media: ${data.studentSchool}`, 10, 82);
            doc.text(`Email: ${data.studentEmail}`, 10, 89);
            doc.text(`Cellulare: ${data.studentPhone}`, 10, 96);

            doc.setDrawColor(200);
            doc.line(10, 102, 200, 102);

            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81);
            const confirmationText = `La prenotazione per lo studente ${data.studentName}, relativa allo stage in data ${new Date(data.date).toLocaleDateString('it-IT')} per l'indirizzo ${data.courseName} e identificata dal codice ${data.bookingCode}, √® stata confermata.`;
            doc.text(confirmationText, 10, 112, { maxWidth: 190 });

            doc.setFontSize(10);
            doc.setTextColor(185, 28, 28); 
            const warningText = "‚ö†Ô∏è N.B.: Questo documento di conferma √® OBBLIGATORIO e DEVE essere presentato all'ingresso il giorno dello stage.";
            doc.text(warningText, 10, 125, { maxWidth: 190 });
            
            doc.setFontSize(8);
            doc.setTextColor(156, 163, 175); 
            doc.text(PDF_SIGNATURE, 10, 280);

            return doc.output('datauristring');
        }

        bookingForm?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const confirmBtn = document.getElementById('confirm-booking-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="spinner mr-2"></div> Elaborazione...';

            const courseId = document.getElementById('booking-course-id').value;
            const date = document.getElementById('booking-date').value;
            const studentName = document.getElementById('student-name').value.trim();
            const studentSchool = document.getElementById('student-school').value.trim();
            const studentEmail = document.getElementById('student-email').value.trim();
            const studentPhone = document.getElementById('student-phone').value.trim();

            const bookingCode = generateUniqueCode(10);
            const courseName = document.getElementById('modal-course-name').textContent;
            const availabilityKey = `${courseId}-${date}`;

            if (currentAvailability[availabilityKey] === undefined || currentAvailability[availabilityKey] <= 0) {
                showMessage("Spiacenti, i posti sono stati esauriti o non aggiornati! Aggiorna la pagina e riprova.", 'error');
                resetFormsAndModals();
                return;
            }

            try {
                localStorage.setItem('lastStudentEmail', studentEmail);

                const bookingData = {
                    courseId, date, studentName, studentSchool, studentEmail, studentPhone, bookingCode, courseName,
                    createdAt: serverTimestamp(),
                    userId: userId,
                };

                if (!db) throw new Error("Database non inizializzato.");
                
                await addDoc(collection(db, BOOKINGS_COLLECTION_PATH), bookingData);

                const pdfBase64 = await generateBookingPdf(bookingData);

                showMessage(`Prenotazione registrata con successo! Codice: ${bookingCode}. Scarica il PDF.`, 'success');
                resetFormsAndModals();
                
                if (pdfBase64) {
                    const downloadLink = document.createElement('a');
                    downloadLink.href = pdfBase64;
                    downloadLink.download = `Conferma_Stage_${bookingCode}.pdf`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                }

            } catch (error) {
                console.error("Errore durante l'aggiunta della prenotazione:", error);
                showMessage(`Errore critico (DB): ${error.message}. Riprova.`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Conferma e Genera PDF';
            }
        });

        async function generateCancellationPdf(data) {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return null;

            const doc = new jsPDF();
            doc.setFont('helvetica');

            doc.setFontSize(18);
            doc.setTextColor(185, 28, 28); 
            doc.text("Conferma Cancellazione Prenotazione", 10, 20);

            doc.setFontSize(11);
            doc.setTextColor(55, 65, 81);
            doc.text(`Codice Prenotazione Annullato: ${data.bookingCode}`, 10, 35);
            doc.text(`Data Annullamento: ${new Date().toLocaleDateString('it-IT')}`, 10, 42);
            doc.text(`Stage Annullato: ${data.courseName || 'N/D'} (Data originale: ${data.date ? new Date(data.date).toLocaleDateString('it-IT') : 'N/D'})`, 10, 49);


            doc.setDrawColor(200);
            doc.line(10, 55, 200, 55);

            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81);

            const cancellationText = `L'annullamento della prenotazione per lo stage con codice ${data.bookingCode} √® stato confermato con successo in data odierna. Il posto per lo stage √® stato ripristinato e reso disponibile per altri studenti.`;
            doc.text(cancellationText, 10, 65, { maxWidth: 190 });

            doc.setFontSize(10);
            const motivazioneText = `Motivazione fornita: ${data.cancellationReason || 'Nessuna motivazione fornita.'}`;
            doc.setTextColor(0, 0, 0);
            doc.text(motivazioneText, 10, 80, { maxWidth: 190 });

            doc.setFontSize(9);
            const noteText = "Si prega di notare che la cancellazione √® definitiva. Per una nuova prenotazione sar√† necessario utilizzare il modulo online, se i posti sono ancora disponibili.";
            doc.setTextColor(30, 58, 138); 
            doc.text(noteText, 10, 100, { maxWidth: 190 });

            doc.setFontSize(8);
            doc.setTextColor(156, 163, 175);
            doc.text(PDF_SIGNATURE, 10, 280);

            return doc.output('datauristring');
        }

        cancellationForm?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const confirmBtn = document.getElementById('confirm-cancellation-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<div class="spinner mr-2 border-red-500 border-t-red-700"></div> Cancellazione...';

            const bookingCode = document.getElementById('cancellation-code').value.trim().toUpperCase();
            const cancellationReason = document.getElementById('cancellation-reason').value.trim();

            if (!db) {
                showMessage("Errore: Database non pronto.", 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Annulla la mia Prenotazione';
                return;
            }

            try {
                const bookingsRef = collection(db, BOOKINGS_COLLECTION_PATH);
                const q = query(bookingsRef, where("bookingCode", "==", bookingCode));
                const bookingSnapshot = await getDocs(q);

                if (bookingSnapshot.empty) {
                    showMessage("Codice prenotazione non trovato o gi√† annullato. Controlla il codice.", 'error');
                    return;
                }

                const docToDelete = bookingSnapshot.docs[0];
                const bookingData = docToDelete.data();

                const cancellationLog = {
                    ...bookingData,
                    cancellationReason: cancellationReason,
                    cancelledAt: serverTimestamp(),
                    cancellationUserId: userId,
                    originalDocId: docToDelete.id, 
                };
                await addDoc(collection(db, CANCELLATIONS_COLLECTION_PATH), cancellationLog);

                await deleteDoc(docToDelete.ref);
                
                const pdfBase64 = await generateCancellationPdf(cancellationLog);
                
                showMessage("Cancellazione completata! Il posto √® stato ripristinato.", 'success');
                resetFormsAndModals();
                
                if (pdfBase64) {
                    const downloadLink = document.createElement('a');
                    downloadLink.href = pdfBase64;
                    downloadLink.download = `Conferma_Annullamento_${bookingCode}.pdf`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                }


            } catch (error) {
                console.error("Errore durante la cancellazione:", error);
                showMessage(`Errore critico durante l'annullamento: ${error.message}. Riprova.`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Annulla la mia Prenotazione';
            }
        });

        // Avvia l'inizializzazione Firebase all'avvio
        window.onload = () => {
            initializeFirebase();
        };

    </script>
</body>
</html>
