<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Stage ITSCG</title>
    <!-- Caricamento Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importazione librerie Firebase (Firestore e Auth) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, runTransaction, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Imposta il livello di log per vedere i messaggi di debug di Firebase
        setLogLevel('debug');

        // --- Variabili globali fornite dall'ambiente Canvas (OBBLIGATORIE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let unsubscribeBookings = null;
        let unsubscribeCancellations = null;
        let globalBookings = [];
        let globalCancellations = [];
        let dateCapacities = {}; // Mappa per tenere traccia della disponibilità

        // Percorsi Firestore (Dati Pubblici per l'app multi-utente)
        const BOOKINGS_COLLECTION_PATH = `artifacts/${appId}/public/data/itscg-stage-bookings`;
        const CANCELLATIONS_COLLECTION_PATH = `artifacts/${appId}/public/data/itscg-stage-cancellations`;
        
        // Codice Docente di MOCK (solo per simulazione, non sicuro)
        const DOCENTE_USERNAME = "docente";
        const DOCENTE_PASSWORD = "12345";
        let isDocente = false;

        // --- Modello Dati Corsi ---
        // Ho utilizzato l'anno 2024 per rendere le date concrete.
        const COURSES = [
            { id: "LSOSA", name: "Liceo Scientifico Opzione Scienze Applicate", description: "Il percorso ideale per chi ama la scienza, la tecnologia e l'innovazione, con un forte focus su materie scientifiche e laboratoriali.", icon: "desktop" },
            { id: "RIM", name: "Relazioni Internazionali per il Marketing", description: "Studia l'economia globale, il marketing e due lingue straniere per operare nei mercati internazionali.", icon: "globe" },
            { id: "LOG", name: "Logistica (Corso Quadriennale)", description: "Corso breve e intensivo per specializzarsi nella gestione dei flussi e della catena di fornitura, preparandoti al mondo del lavoro in 4 anni.", icon: "truck" },
            { id: "CAT", name: "Costruzione Ambiente e Territorio", description: "Impara a progettare, costruire e gestire il territorio in modo sostenibile, con competenze in edilizia e topografia.", icon: "home" },
            { id: "SM", name: "Sistema Moda", description: "Approfondisci la filiera tessile-moda, dal design alla produzione e al marketing, dal design alla produzione e al marketing, per una carriera nel settore del fashion.", icon: "shirt" }
        ];

        // Mappa delle date disponibili (DD/MM/YYYY OraStart-OraEnd, CapacityMax)
        const AVAILABLE_DATES = {
            LSOSA: [
                { date: "03/11/2024", time: "11:50-13:50", capacity: 10 },
                { date: "10/11/2024", time: "11:50-13:50", capacity: 10 },
                { date: "17/11/2024", time: "11:50-13:50", capacity: 10 },
                { date: "24/11/2024", time: "11:50-13:50", capacity: 10 },
                { date: "01/12/2024", time: "11:50-13:50", capacity: 10 },
                { date: "15/12/2024", time: "11:50-13:50", capacity: 10 },
                { date: "05/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "12/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "19/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "26/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "03/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "17/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "11:50-13:50", capacity: 10 } // Slot extra
            ].sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-'))),
            
            RIM: [
                { date: "03/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "10/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "17/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "24/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "01/12/2024", time: "12:50-14:40", capacity: 10 },
                { date: "15/12/2024", time: "12:50-14:40", capacity: 10 },
                { date: "05/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "12/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "19/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "26/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "03/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "17/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "13:00-14:40", capacity: 10 } // Slot extra
            ].sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-'))),
            
            LOG: [
                { date: "05/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "12/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "19/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "26/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "03/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "17/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "03/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "10/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "17/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "24/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "01/12/2024", time: "12:50-14:40", capacity: 10 },
                { date: "15/12/2024", time: "12:50-14:40", capacity: 10 }
            ].sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-'))),
            
            CAT: [
                { date: "03/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "10/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "17/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "24/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "01/12/2024", time: "12:50-14:40", capacity: 10 },
                { date: "15/12/2024", time: "12:50-14:40", capacity: 10 },
                { date: "05/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "12/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "19/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "26/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "03/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "17/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "13:00-14:40", capacity: 10 } // Slot extra
            ].sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-'))),
            
            SM: [
                { date: "03/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "10/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "17/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "24/11/2024", time: "12:50-14:40", capacity: 10 },
                { date: "01/12/2024", time: "12:50-14:40", capacity: 10 },
                { date: "15/12/2024", time: "12:50-14:40", capacity: 10 },
                { date: "05/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "12/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "19/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "26/11/2024", time: "08:50-10:50", capacity: 10 },
                { date: "03/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "17/12/2024", time: "08:50-10:50", capacity: 10 },
                { date: "10/12/2024", time: "13:00-14:40", capacity: 10 } // Slot extra
            ].sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-'))),
        };
        
        let selectedCourseId = null;
        let selectedDate = null;
        
        // --- Inizializzazione Firebase e Autenticazione ---

        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                showAppMessage("Errore: Configurazione Firebase mancante.", "error");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Opzionale: persistenza della sessione
                await setPersistence(auth, browserSessionPersistence);

                // Autenticazione (Anonima o con Token)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    userId = user?.uid || crypto.randomUUID(); // Usa UID se autenticato, altrimenti un ID casuale
                    
                    const loadingElement = document.getElementById('loading');
                    loadingElement.classList.add('hidden');
                    
                    document.getElementById('current-user-id').textContent = `ID Utente: ${user ? user.uid : 'Anonimo'}`;
                    
                    // Inizializza i listener solo dopo che l'autenticazione è pronta
                    setupFirestoreListeners();
                    renderCourseSelection();
                });

            } catch (error) {
                console.error("Errore durante l'inizializzazione di Firebase:", error);
                showAppMessage(`Errore DB: ${error.message}`, "error");
            }
        };
        
        // --- Funzioni di Utilità ---

        function showAppMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `fixed top-20 right-5 p-4 rounded-xl shadow-xl z-50 transition-opacity duration-300`;
            
            if (type === 'success') {
                box.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                box.classList.add('bg-red-600', 'text-white');
            } else {
                box.classList.add('bg-blue-500', 'text-white');
            }

            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('opacity-0');
                setTimeout(() => {
                    box.classList.add('hidden');
                    box.classList.remove('opacity-0');
                }, 300);
            }, 5000);
        }

        function generateBookingCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        function formatDateForTable(dateStr) {
            try {
                const [day, month, year] = dateStr.split('/');
                const date = new Date(`${year}-${month}-${day}T00:00:00`);
                if (isNaN(date)) return dateStr;
                return date.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } catch (e) {
                return dateStr;
            }
        }

        // --- Gestione Stato e Listener Firestore ---

        const setupFirestoreListeners = () => {
            if (!db || !isAuthReady) {
                console.warn("Firestore o Autenticazione non pronti per i listener.");
                return;
            }

            // Listener Prenotazioni Attive
            const bookingsQuery = collection(db, BOOKINGS_COLLECTION_PATH);
            unsubscribeBookings = onSnapshot(bookingsQuery, (snapshot) => {
                globalBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCapacities(globalBookings);
                renderDocenteBookings(globalBookings);
                // Aggiorna la vista date se l'utente è nella vista di selezione data
                if (selectedCourseId) {
                    renderDateSelection(selectedCourseId);
                }
            }, (error) => {
                console.error("Errore nel listener prenotazioni:", error);
                showAppMessage("Errore nel caricamento delle prenotazioni.", "error");
            });

            // Listener Storico Annullamenti
            const cancellationsQuery = collection(db, CANCELLATIONS_COLLECTION_PATH);
            unsubscribeCancellations = onSnapshot(cancellationsQuery, (snapshot) => {
                globalCancellations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDocenteCancellations(globalCancellations);
            }, (error) => {
                console.error("Errore nel listener annullamenti:", error);
            });
        };

        // Aggiorna la mappa delle capacità in base alle prenotazioni attive
        const updateCapacities = (bookings) => {
            dateCapacities = {};
            
            // Inizializza la mappa con le capacità massime da AVAILABLE_DATES
            Object.values(AVAILABLE_DATES).flat().forEach(slot => {
                const key = `${slot.date}|${slot.time}`;
                dateCapacities[key] = {
                    max: slot.capacity,
                    booked: 0
                };
            });

            // Conta le prenotazioni attive
            bookings.forEach(booking => {
                const key = `${booking.stageDate}|${booking.stageTime}`;
                if (dateCapacities[key]) {
                    dateCapacities[key].booked += 1;
                }
            });
        };

        // --- Funzioni di Rendering Viste Studente ---

        const renderCourseSelection = () => {
            const container = document.getElementById('courses-container');
            container.innerHTML = ''; // Pulisce il contenitore

            COURSES.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'card-course bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 hover:shadow-xl';
                courseCard.setAttribute('data-course-id', course.id);
                courseCard.innerHTML = `
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            ${getIconPath(course.icon)}
                        </svg>
                        <h4 class="text-xl font-bold text-gray-800">${course.name}</h4>
                    </div>
                    <p class="text-gray-600 text-sm">${course.description}</p>
                    <button class="mt-4 w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Vedi Date Disponibili
                    </button>
                `;
                courseCard.addEventListener('click', () => showDateSelection(course.id));
                container.appendChild(courseCard);
            });
            document.getElementById('course-selection-view').classList.remove('hidden');
            document.getElementById('date-selection-view').classList.add('hidden');
            selectedCourseId = null;
        };
        
        const getIconPath = (iconName) => {
            switch(iconName) {
                case 'desktop': return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1l-.75-3M3 14h18M5 14h14M12 4v10m-2 0h4"></path>';
                case 'globe': return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h6m-6 0h6m-6 0v2m6-2v2m-3 0V7m0 0a9 9 0 019 9m-9-9a9 9 0 00-9 9"></path>';
                case 'truck': return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 14.75V19m0-4.25H2M2 14.75v-1a2 2 0 012-2h1m1-4h14M8 12h8m-8-2h8m-3-4V4a2 2 0 00-2-2H9a2 2 0 00-2 2v2m12 10a2 2 0 11-4 0 2 2 0 014 0zM17 19a2 2 0 11-4 0 2 2 0 014 0z"></path>';
                case 'home': return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l-2 2m0 0v10a1 1 0 01-1 1h-3m-6 0a1 1 0 00-1 1m0 0h6m-6 0h-2"></path>';
                case 'shirt': return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1m-18 0H3m14.646-4.646l-.708-.708M7.06 7.06l-.707-.707M12 12a5 5 0 110-10 5 5 0 010 10z"></path>';
                default: return '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
            }
        }

        const showDateSelection = (courseId) => {
            selectedCourseId = courseId;
            const course = COURSES.find(c => c.id === courseId);

            document.getElementById('selected-course-title').textContent = course.name;
            document.getElementById('course-selection-view').classList.add('hidden');
            document.getElementById('date-selection-view').classList.remove('hidden');

            renderDateSelection(courseId);
        };

        const renderDateSelection = (courseId) => {
            const datesContainer = document.getElementById('dates-container');
            datesContainer.innerHTML = '';
            
            const dates = AVAILABLE_DATES[courseId] || [];

            if (dates.length === 0) {
                datesContainer.innerHTML = `<p class="text-center py-10 text-gray-500">Nessuna data di stage disponibile al momento per questo corso.</p>`;
                return;
            }

            dates.forEach(slot => {
                const key = `${slot.date}|${slot.time}`;
                const capacityInfo = dateCapacities[key] || { booked: 0, max: slot.capacity };
                const remaining = capacityInfo.max - capacityInfo.booked;
                
                const isFull = remaining <= 0;
                const statusColor = isFull ? 'bg-red-100 text-red-700 border-red-300' : 
                                     remaining <= 3 ? 'bg-yellow-100 text-yellow-700 border-yellow-300' :
                                                      'bg-green-100 text-green-700 border-green-300';
                
                const buttonHtml = isFull ? 
                    `<span class="px-3 py-1 bg-gray-300 text-gray-700 rounded-full text-xs font-bold">Posti Esauriti</span>` :
                    `<button class="book-date-btn px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md" data-date="${slot.date}" data-time="${slot.time}" data-course-id="${courseId}">Prenota</button>`;

                const dateCard = document.createElement('div');
                dateCard.className = `p-4 flex items-center justify-between rounded-xl shadow-md ${statusColor}`;
                dateCard.innerHTML = `
                    <div>
                        <p class="text-lg font-bold">${formatDateForTable(slot.date)}</p>
                        <p class="text-sm font-medium">${slot.time} (stage di due ore)</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold">${remaining} posti disponibili</p>
                        ${buttonHtml}
                    </div>
                `;
                datesContainer.appendChild(dateCard);
            });
            
            // Aggiunge listener ai pulsanti di prenotazione
            document.querySelectorAll('.book-date-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const date = e.target.getAttribute('data-date');
                    const time = e.target.getAttribute('data-time');
                    openBookingModal(courseId, date, time);
                });
            });
        };

        // --- Gestione Modali Studente (Prenotazione / Cancellazione) ---

        const openBookingModal = (courseId, date, time) => {
            selectedDate = { courseId, date, time };
            const course = COURSES.find(c => c.id === courseId);

            document.getElementById('modal-course-name').textContent = course.name;
            document.getElementById('modal-date').textContent = `${formatDateForTable(date)} | Ore ${time}`;
            document.getElementById('booking-course-id').value = courseId;
            document.getElementById('booking-date').value = `${date}|${time}`;
            document.getElementById('booking-modal').classList.remove('hidden');
        };

        const closeBookingModal = () => {
            document.getElementById('booking-modal').classList.add('hidden');
            document.getElementById('booking-form').reset();
            selectedDate = null;
        };

        const closeCancellationModal = () => {
             document.getElementById('cancellation-modal').classList.add('hidden');
             document.getElementById('cancellation-form').reset();
        }
        
        const openCancellationModal = () => {
             document.getElementById('cancellation-modal').classList.remove('hidden');
        }

        const openDocenteLoginModal = () => {
             document.getElementById('docente-login-modal').classList.remove('hidden');
        }

        const closeDocenteLoginModal = () => {
             document.getElementById('docente-login-modal').classList.add('hidden');
             document.getElementById('docente-login-form').reset();
        }

        // --- Logica Transazionale di Prenotazione ---

        const handleBookingSubmit = async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const studentName = form.elements['student-name'].value.trim();
            const studentSchool = form.elements['student-school'].value.trim();
            const studentEmail = form.elements['student-email'].value.trim();
            const studentPhone = form.elements['student-phone'].value.trim();
            const bookingCourseId = form.elements['booking-course-id'].value;
            const [stageDate, stageTime] = form.elements['booking-date'].value.split('|');
            const bookingCode = generateBookingCode();

            if (!studentName || !studentSchool || !studentEmail || !studentPhone) {
                showAppMessage("Compila tutti i campi richiesti.", "error");
                return;
            }

            document.getElementById('confirm-booking-btn').disabled = true;
            document.getElementById('confirm-booking-btn').textContent = "Prenotazione in corso...";

            try {
                // 1. Transaction per la verifica della capienza
                const newBookingRef = doc(collection(db, BOOKINGS_COLLECTION_PATH));
                
                await runTransaction(db, async (transaction) => {
                    // Query per contare le prenotazioni attive per quella data/ora
                    const bookingsSnapshot = await getDocs(
                        query(collection(db, BOOKINGS_COLLECTION_PATH), 
                              where('stageDate', '==', stageDate), 
                              where('stageTime', '==', stageTime))
                    );

                    const currentBooked = bookingsSnapshot.size;
                    const dateKey = `${stageDate}|${stageTime}`;
                    const maxCapacity = (dateCapacities[dateKey] || { max: 10 }).max; 

                    if (currentBooked >= maxCapacity) {
                        throw new Error("Posti esauriti per la data e ora selezionate. Riprova con un altro slot.");
                    }
                    
                    // 2. Registra la prenotazione
                    const course = COURSES.find(c => c.id === bookingCourseId);
                    
                    const bookingData = {
                        bookingId: bookingCode,
                        courseId: bookingCourseId,
                        courseName: course.name,
                        studentName,
                        studentSchool,
                        studentEmail,
                        studentPhone,
                        stageDate, // DD/MM/YYYY
                        stageTime, // HH:mm-HH:mm
                        reservationTimestamp: serverTimestamp(),
                        userId,
                    };

                    transaction.set(newBookingRef, bookingData);
                    
                    // 3. Genera il PDF (anche se è sincrono, lo lanciamo dopo la transazione)
                    generatePDFConfirmation(bookingData);
                });

                showAppMessage(`Prenotazione confermata! Codice: ${bookingCode}. Scarica il PDF.`, "success");
                closeBookingModal();
                
            } catch (e) {
                console.error("Errore durante la prenotazione:", e);
                showAppMessage(e.message.includes("Posti esauriti") ? e.message : "Errore: la prenotazione non è andata a buon fine. Riprova.", "error");
            } finally {
                document.getElementById('confirm-booking-btn').disabled = false;
                document.getElementById('confirm-booking-btn').textContent = "Conferma e Genera PDF";
            }
        };

        // --- Logica Cancellazione ---

        const handleCancellationSubmit = async (e) => {
            e.preventDefault();
            
            const cancellationCode = document.getElementById('cancellation-code').value.trim().toUpperCase();
            const reason = document.getElementById('cancellation-reason').value.trim();

            if (!cancellationCode || !reason) {
                 showAppMessage("Inserisci il codice e la motivazione dell'annullamento.", "error");
                 return;
            }

            document.getElementById('confirm-cancellation-btn').disabled = true;
            document.getElementById('confirm-cancellation-btn').textContent = "Annullamento in corso...";

            try {
                // 1. Trova la prenotazione attiva
                const activeBooking = globalBookings.find(b => b.bookingId === cancellationCode);

                if (!activeBooking) {
                    showAppMessage("Codice di prenotazione non trovato o già annullato.", "error");
                    return;
                }
                
                // 2. Crea il record di annullamento nello storico
                await addDoc(collection(db, CANCELLATIONS_COLLECTION_PATH), {
                    originalBookingId: activeBooking.bookingId,
                    courseName: activeBooking.courseName,
                    studentName: activeBooking.studentName,
                    studentSchool: activeBooking.studentSchool,
                    originalStageDate: activeBooking.stageDate,
                    originalStageTime: activeBooking.stageTime,
                    cancellationReason: reason,
                    cancellationTimestamp: serverTimestamp(),
                    cancelledByUserId: userId // Registra chi ha annullato
                });

                // 3. Elimina la prenotazione attiva
                await deleteDoc(doc(db, BOOKINGS_COLLECTION_PATH, activeBooking.id));

                showAppMessage(`Prenotazione con codice ${cancellationCode} annullata con successo.`, "success");
                closeCancellationModal();

            } catch (e) {
                console.error("Errore durante la cancellazione:", e);
                showAppMessage("Errore: Impossibile annullare la prenotazione. Riprova.", "error");
            } finally {
                document.getElementById('confirm-cancellation-btn').disabled = false;
                document.getElementById('confirm-cancellation-btn').textContent = "Conferma Cancellazione";
            }
        };

        // --- Dashboard Docente ---
        
        const showDocenteView = () => {
            isDocente = true;
            document.getElementById('student-main-view').classList.add('hidden');
            document.getElementById('docente-view').classList.remove('hidden');
            closeDocenteLoginModal();
            renderDocenteBookings(globalBookings);
            renderDocenteCancellations(globalCancellations);
            populateDateFilter(globalBookings);
        };

        const hideDocenteView = () => {
            isDocente = false;
            document.getElementById('student-main-view').classList.remove('hidden');
            document.getElementById('docente-view').classList.add('hidden');
        };

        const handleDocenteLogin = (e) => {
            e.preventDefault();
            const username = document.getElementById('docente-username').value;
            const password = document.getElementById('docente-password').value;

            if (username === DOCENTE_USERNAME && password === DOCENTE_PASSWORD) {
                showAppMessage("Accesso Docente riuscito!", "success");
                showDocenteView();
            } else {
                showAppMessage("Credenziali Docente errate.", "error");
                document.getElementById('docente-login-form').reset();
            }
        };
        
        const populateDateFilter = (bookings) => {
            const dateFilter = document.getElementById('date-filter');
            dateFilter.innerHTML = '<option value="">Tutte le Date</option>';

            const uniqueDates = [...new Set(bookings.map(b => b.stageDate))].sort((a, b) => {
                // Converte DD/MM/YYYY in YYYY-MM-DD per il confronto
                const dateA = new Date(a.split('/').reverse().join('-'));
                const dateB = new Date(b.split('/').reverse().join('-'));
                return dateA - dateB;
            });

            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = formatDateForTable(date);
                dateFilter.appendChild(option);
            });
        };

        const renderDocenteBookings = (bookings) => {
            if (!isDocente) return; // Non renderizzare se non loggato
            const tableBody = document.getElementById('bookings-table-body');
            const dateFilter = document.getElementById('date-filter').value;
            tableBody.innerHTML = '';
            
            // Filtra per data selezionata
            const filteredBookings = dateFilter 
                ? bookings.filter(b => b.stageDate === dateFilter)
                : bookings;

            if (filteredBookings.length === 0) {
                 document.getElementById('no-bookings-message').classList.remove('hidden');
                 return;
            }
            document.getElementById('no-bookings-message').classList.add('hidden');
            
            // Raggruppa per data/ora e ordina per nome (solo per la visualizzazione)
            const sortedBookings = filteredBookings.sort((a, b) => {
                 const nameA = a.studentName.toUpperCase();
                 const nameB = b.studentName.toUpperCase();
                 return nameA < nameB ? -1 : nameA > nameB ? 1 : 0;
            });

            sortedBookings.forEach(booking => {
                const dateKey = `${booking.stageDate}|${booking.stageTime}`;
                const capacityInfo = dateCapacities[dateKey] || { booked: 0, max: 10 };
                const occupancy = `${capacityInfo.booked}/${capacityInfo.max}`;
                
                const row = tableBody.insertRow();
                row.className = 'hover:bg-indigo-50 transition duration-100 text-sm';

                // Codice (w-1/12)
                row.insertCell().innerHTML = `<span class="font-mono text-xs font-semibold text-indigo-700">${booking.bookingId}</span>`;
                // Studente (w-2/12)
                row.insertCell().textContent = booking.studentName;
                // Corso (w-2/12)
                row.insertCell().innerHTML = `<span class="font-medium text-gray-800">${booking.courseName}</span>`;
                // Data Stage (w-1/12)
                row.insertCell().innerHTML = `${formatDateForTable(booking.stageDate)}<br><span class="text-xs text-gray-500">${booking.stageTime}</span>`;
                // Scuola Media (w-3/12)
                row.insertCell().textContent = booking.studentSchool;
                // Email/Tel (w-2/12)
                row.insertCell().innerHTML = `<div class="truncate">${booking.studentEmail}</div><div class="text-xs text-gray-500">${booking.studentPhone}</div>`;
                // Data Iscrizione (w-1/12)
                row.insertCell().textContent = booking.reservationTimestamp ? new Date(booking.reservationTimestamp.toDate()).toLocaleDateString('it-IT') : 'N/D';
            });
        };
        
        const renderDocenteCancellations = (cancellations) => {
            if (!isDocente) return;
            const tableBody = document.getElementById('cancellations-table-body');
            tableBody.innerHTML = '';
            
            if (cancellations.length === 0) {
                 document.getElementById('no-cancellations-message').classList.remove('hidden');
                 return;
            }
            document.getElementById('no-cancellations-message').classList.add('hidden');

            // Ordina per data di annullamento (più recente in alto)
            const sortedCancellations = cancellations.sort((a, b) => 
                b.cancellationTimestamp?.toDate() - a.cancellationTimestamp?.toDate()
            );

            sortedCancellations.forEach(c => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-red-50 transition duration-100 text-sm';

                // Codice Originale (w-1/12)
                row.insertCell().innerHTML = `<span class="font-mono text-xs font-semibold text-red-700">${c.originalBookingId}</span>`;
                // Studente (w-2/12)
                row.insertCell().textContent = c.studentName;
                // Corso (w-1/12)
                row.insertCell().textContent = c.courseName.split(' ')[0]; // Nome breve
                // Data Stage Originale (w-1/12)
                row.insertCell().innerHTML = `${formatDateForTable(c.originalStageDate)}<br><span class="text-xs text-gray-500">${c.originalStageTime}</span>`;
                // Annullato il (w-2/12)
                row.insertCell().textContent = c.cancellationTimestamp ? new Date(c.cancellationTimestamp.toDate()).toLocaleDateString('it-IT') : 'N/D';
                // Motivazione (w-5/12)
                row.insertCell().innerHTML = `<div class="truncate italic text-gray-600">${c.cancellationReason}</div>`;
            });
        };
        
        const switchDocenteTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('tab-active'));

            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('tab-active');
        }

        // --- Esportazione e Cancellazione Dati ---

        const exportBookingsToCSV = () => {
            if (globalBookings.length === 0) {
                showAppMessage("Nessuna prenotazione da esportare.", "info");
                return;
            }
            
            // Definisce le colonne del CSV
            const headers = [
                "ID Prenotazione", "Nome Studente", "Scuola Media", "Corso ID", "Nome Corso", 
                "Data Stage", "Ora Stage", "Email", "Telefono", "Data Iscrizione"
            ];
            
            const rows = globalBookings.map(b => [
                b.bookingId, b.studentName, b.studentSchool, b.courseId, b.courseName,
                b.stageDate, b.stageTime, b.studentEmail, b.studentPhone, 
                b.reservationTimestamp ? new Date(b.reservationTimestamp.toDate()).toLocaleString('it-IT') : 'N/D'
            ]);

            let csvContent = headers.join(";") + "\n";
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(";") + "\n";
            });

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // Aggiunge BOM per Excel
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `prenotazioni_stage_itscg_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAppMessage("Dati esportati con successo in CSV!", "success");
        };

        const openDeleteAllModal = () => {
             // Utilizzo di una modale custom invece di window.confirm
             const confirmation = prompt("ATTENZIONE: Stai per cancellare TUTTI i dati di prenotazione e annullamento. Per confermare, digita 'CANCELLA TUTTO'.");
             if (confirmation === 'CANCELLA TUTTO') {
                 deleteAllData();
             } else if (confirmation !== null) {
                 showAppMessage("Cancellazione annullata o codice non corretto.", "info");
             }
        };

        const deleteAllData = async () => {
            if (!isDocente) {
                showAppMessage("Accesso negato.", "error");
                return;
            }
            
            showAppMessage("Avvio cancellazione massiva...", "info");

            try {
                const deleteCollection = async (collectionPath) => {
                    const collectionRef = collection(db, collectionPath);
                    const querySnapshot = await getDocs(collectionRef);
                    const batch = writeBatch(db);

                    querySnapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    return querySnapshot.size;
                };

                const deletedBookings = await deleteCollection(BOOKINGS_COLLECTION_PATH);
                const deletedCancellations = await deleteCollection(CANCELLATIONS_COLLECTION_PATH);

                showAppMessage(`Cancellati ${deletedBookings} prenotazioni attive e ${deletedCancellations} annullamenti. Database pulito.`, "success");

            } catch (e) {
                 console.error("Errore cancellazione massiva:", e);
                 showAppMessage("Errore critico durante la cancellazione massiva. Controlla la console.", "error");
            }
        };
        
        // --- Generazione PDF (Funzione Sincrona) ---
        
        const generatePDFConfirmation = (bookingData) => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFont('Helvetica', 'Bold');
                doc.setFontSize(20);
                doc.text('CONFERMA PRENOTAZIONE MINISTAGE', 10, 20);

                doc.setFont('Helvetica', 'Normal');
                doc.setFontSize(12);
                doc.text(`ITSCG "Primo Levi" di Seregno`, 10, 30);
                doc.text(`Via Briantina 68`, 10, 37);

                // Linea di separazione
                doc.setDrawColor(79, 70, 229); // Indigo-600
                doc.line(10, 45, 200, 45);

                doc.setFontSize(14);
                doc.setFont('Helvetica', 'Bold');
                doc.text('Dettagli Studente e Stage:', 10, 55);

                doc.setFont('Helvetica', 'Normal');
                doc.text(`Nome Completo: ${bookingData.studentName}`, 10, 65);
                doc.text(`Scuola Media: ${bookingData.studentSchool}`, 10, 72);
                doc.text(`Email: ${bookingData.studentEmail}`, 10, 79);
                doc.text(`Telefono: ${bookingData.studentPhone}`, 10, 86);

                doc.setFont('Helvetica', 'Bold');
                doc.setFontSize(16);
                doc.setTextColor(79, 70, 229); // Indigo-600
                doc.text(`Stage Selezionato: ${bookingData.courseName}`, 10, 100);
                doc.setTextColor(0, 0, 0); // Nero

                doc.setFontSize(14);
                doc.text(`Data: ${formatDateForTable(bookingData.stageDate)}`, 10, 110);
                doc.text(`Orario: ${bookingData.stageTime}`, 10, 117);

                // Codice di Prenotazione in Evidenza
                doc.setDrawColor(0);
                doc.setFillColor(254, 202, 202); // Red-200
                doc.rect(10, 130, 180, 25, 'FD'); // Area evidenziata
                
                doc.setFontSize(18);
                doc.setFont('Helvetica', 'Bold');
                doc.text('CODICE DI PRENOTAZIONE UNIVOCO:', 15, 138);
                doc.setFontSize(24);
                doc.setTextColor(185, 28, 28); // Red-700
                doc.text(bookingData.bookingId, 15, 148);
                doc.setTextColor(0, 0, 0); // Nero
                
                // Istruzioni
                doc.setFontSize(12);
                doc.text("⚠️ ISTRUZIONI IMPORTANTI:", 10, 170);
                doc.setFontSize(10);
                doc.text("1. Questo documento è la tua prova di iscrizione. Conservalo con cura.", 10, 177);
                doc.text("2. Presenta il PDF (digitale o stampato) all'ingresso dell'Istituto il giorno dello Stage.", 10, 184);
                doc.text("3. L'esperienza ha una durata di circa due ore (come da orario indicato).", 10, 191);
                doc.text("4. Per annullare la prenotazione, utilizza l'apposito pulsante nell'applicazione web, inserendo il codice qui sopra.", 10, 198);
                
                // Salva il file
                doc.save(`Conferma_Stage_ITSCG_${bookingData.bookingId}.pdf`);

            } catch (error) {
                console.error("Errore nella generazione del PDF:", error);
                showAppMessage("Errore: Impossibile generare il PDF. Riprova o salva questa schermata.", "error");
            }
        };

        // --- Inizializzazione e Event Listeners DOM ---

        window.onload = () => {
            initFirebase();
            
            // Listener per il pulsante "Torna agli Indirizzi"
            document.getElementById('back-to-courses-btn').addEventListener('click', renderCourseSelection);

            // Listener per l'apertura/chiusura modali
            document.getElementById('close-modal-btn').addEventListener('click', closeBookingModal);
            document.getElementById('open-cancellation-modal-btn').addEventListener('click', openCancellationModal);
            document.getElementById('close-cancellation-modal-btn').addEventListener('click', closeCancellationModal);
            document.getElementById('open-docente-login-btn').addEventListener('click', openDocenteLoginModal);
            
            // Listener per i form
            document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
            document.getElementById('cancellation-form').addEventListener('submit', handleCancellationSubmit);
            document.getElementById('docente-login-form').addEventListener('submit', handleDocenteLogin);
            
            // Listener per la Dashboard Docente
            document.getElementById('logout-docente-btn').addEventListener('click', hideDocenteView);
            document.getElementById('export-csv-btn').addEventListener('click', exportBookingsToCSV);
            document.getElementById('open-delete-modal-btn').addEventListener('click', openDeleteAllModal);
            
            // Listener per il filtro date Docente
            document.getElementById('date-filter').addEventListener('change', () => renderDocenteBookings(globalBookings));
            
            // Listener per il cambio Tab Docente
            document.getElementById('tab-bookings').addEventListener('click', () => switchDocenteTab('bookings'));
            document.getElementById('tab-cancellations').addEventListener('click', () => switchDocenteTab('cancellations'));
        };

    </script>
    
    <!-- Importazione librerie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Stile personalizzato per un look moderno */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card-course { transition: all 0.3s ease-in-out; cursor: pointer; }
        .card-course:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top-color: #3b82f6; border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Stile per i modali */
        .modal-content { max-height: 80vh; overflow-y: auto; }
        .table-container { max-height: 70vh; overflow-y: auto; }
        
        /* Stile per i pulsanti */
        .docente-access-btn {
            background-image: linear-gradient(to right, #4f46e5 0%, #3b82f6 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(65, 132, 246, 0.5);
        }
        .docente-access-btn:hover {
            background-position: right center;
            box-shadow: 0 6px 20px 0 rgba(65, 132, 246, 0.7);
        }
        .cancellation-btn-fixed {
            background-color: #fca5a5; 
            color: #991b1b; 
            border: 2px solid #ef4444; 
            transition: all 0.3s ease;
        }

        .cancellation-btn-fixed:hover {
            background-color: #ef4444; 
            color: white;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        /* Stili per le tab della dashboard docente */
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5; /* Indigo-600 */
            color: #1e3a8a; /* Blue-900 */
            font-weight: 700;
            background-color: #e0f2f1; /* Light background for active tab */
        }
        
        /* Stile per la tabella Docenti per migliorare la leggibilità e ridurre l'ampiezza */
        #bookings-table th, #cancellations-table th {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #bookings-table td, #cancellations-table td {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            vertical-align: top;
        }
    </style>
    <!-- Configurazione per il font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<!-- Header compatto con logo -->
<header class="bg-white shadow-md sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
        <div class="flex items-center">
            <img src="Levi.png" 
                 onerror="this.onerror=null; this.src='https://placehold.co/48x48/4f46e5/ffffff?text=L';" 
                 alt="Logo Primo Levi" 
                 class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-indigo-500 mr-2">
            <h1 class="text-lg sm:text-xl font-semibold text-gray-900">
                Stage Orientamento <span class="text-indigo-600 font-bold">ITSCG Primo Levi</span>
            </h1>
        </div>
        
        <div class="flex items-center space-x-4">
            <a href="chatbot.html" 
               class="px-3 py-1.5 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.669A9.76 9.76 0 0112 4c4.97 0 9 3.582 9 8z"></path></svg>
                Chatbot AI (FAQ)
            </a>
            <div id="auth-status" class="text-xs text-gray-400 truncate">
                <div id="current-user-id">ID: In attesa...</div>
            </div>
        </div>
        </div>
</header>
    
    <main class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <!-- Message Box per feedback utente -->
        <div id="message-box" class="hidden fixed top-20 right-5 p-4 rounded-xl shadow-xl text-white z-50 transition-opacity duration-300"></div>
        
        <!-- Indicatore di caricamento del DB -->
        <div id="loading" class="flex justify-center items-center py-4 text-gray-600">
              <div id="loading-spinner" class="spinner mr-3"></div>
            <span id="loading-status" class="text-lg font-medium">Connessione al database in corso...</span>
        </div>

        <!-- Vista Docente (Inizialmente nascosta) -->
        <section id="docente-view" class="hidden">
            <h2 class="text-4xl font-extrabold text-indigo-800 text-center mb-6 border-b-4 border-indigo-600 pb-2">Area Docenti - Monitoraggio Stage</h2>
            
            <!-- Controlli Docente -->
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4 bg-gray-100 p-4 rounded-xl shadow-md">
                <button id="logout-docente-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md w-full sm:w-auto">
                    Logout Docente
                </button>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                    <button id="export-csv-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 shadow-md flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Esporta in CSV (Excel)
                    </button>
                    <!-- Pulsante Elimina Dati Totale -->
                    <button id="open-delete-modal-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-800 rounded-lg hover:bg-red-900 transition duration-150 shadow-md flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        Cancella TUTTI i Dati
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-300 mb-6">
                <button id="tab-bookings" data-tab="bookings" class="tab-button px-6 py-3 text-gray-600 hover:text-indigo-600 hover:border-indigo-300 border-b-2 border-transparent tab-active">
                    Prenotazioni Attive
                </button>
                <button id="tab-cancellations" data-tab="cancellations" class="tab-button px-6 py-3 text-gray-600 hover:text-red-600 hover:border-red-300 border-b-2 border-transparent">
                    Storico Annullamenti
                </button>
            </div>" 
            
            <!-- Contenuto Tab: Prenotazioni Attive -->
            <div id="content-bookings" class="tab-content">
                <h3 class="text-2xl font-bold text-gray-700 mb-4">Elenco Prenotazioni Attive</h3>
                
                <!-- FILTRO PER DATA -->
                <div class="mb-4 flex items-center space-x-4 bg-white p-4 rounded-xl shadow-inner border border-gray-200">
                    <label for="date-filter" class="text-sm font-medium text-gray-700">Filtra per Data Stage:</label>
                    <select id="date-filter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-auto">
                        <!-- Opzioni popolate da JS -->
                    </select>
                </div>
                <!-- FINE FILTRO -->

                <div class="table-container bg-white rounded-xl shadow-lg p-6">
                    <table id="bookings-table" class="min-w-full divide-y divide-gray-200 table-fixed">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Studente</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Corso</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Stage</th>
                                <th class="w-3/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scuola Media</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email/Tel</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Iscrizione</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Righe prenotazioni caricate qui -->
                        </tbody>
                    </table>
                    <p id="no-bookings-message" class="text-center py-10 text-gray-500 hidden">Nessuna prenotazione attiva trovata per la data selezionata.</p>
                </div>
            </div>

            <!-- Contenuto Tab: Storico Annullamenti -->
            <div id="content-cancellations" class="tab-content hidden">
                <h3 class="text-2xl font-bold text-gray-700 mb-4">Storico Prenotazioni Annullate</h3>
                <div class="table-container bg-white rounded-xl shadow-lg p-6 border-2 border-red-200">
                    <table id="cancellations-table" class="min-w-full divide-y divide-gray-200 table-fixed">
                        <thead class="bg-red-50 sticky top-0">
                            <tr>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Studente</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Corso</th>
                                <th class="w-1/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Stage Originale</th>
                                <th class="w-2/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Annullato il</th>
                                <th class="w-5/12 px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivazione</th>
                            </tr>
                        </thead>
                        <tbody id="cancellations-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Righe annullamenti caricate qui -->
                        </tbody>
                    </table>
                    <p id="no-cancellations-message" class="text-center py-10 text-gray-500 hidden">Nessuna cancellazione registrata.</p>
                </div>
            </div>
        </section>

        <!-- Vista Studente (Inizialmente mostrata) -->
        <section id="student-main-view">
            
            <!-- CONTROLLI UTENTE FISSI (Annulla e Docente) -->
            <div class="flex flex-col sm:flex-row justify-center sm:justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                <!-- Pulsante Annulla Prenotazione -->
                <button id="open-cancellation-modal-btn" class="cancellation-btn-fixed inline-flex items-center px-6 py-2 text-sm font-bold rounded-xl shadow-md transition duration-300 w-full sm:w-auto justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Annulla la mia Prenotazione
                </button>
                <!-- Pulsante Accesso Docenti -->
                <button id="open-docente-login-btn" class="docente-access-btn px-6 py-2 text-sm font-bold text-white rounded-xl transition duration-300 w-full sm:w-auto justify-center flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1m18-7V9a3 3 0 00-3-3h-2M11 5V4a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h2"></path></svg>
                    Area Riservata Docenti
                </button>
            </div>


            <!-- WARNING Message (TESTO MODIFICATO) -->
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8 rounded-xl shadow-md" role="alert">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <p class="font-bold text-lg">⚠️ ATTENZIONE: Documento di Conferma Importante!</p>
                </div>
                <p class="mt-2 text-sm">
                    È fondamentale conservare il PDF di conferma generato al momento della prenotazione e presentarlo all'ingresso il giorno dello Stage. 
                </p>
            </div>

        <div class="container mx-auto p-4 sm:p-6 lg:p-10 max-w-5xl">
            <!-- HEADER PRINCIPALE -->
            <header class="bg-white p-6 md:p-10 rounded-xl shadow-xl mb-8 border-t-4 border-indigo-600">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                    Il Ministage di Orientamento ITSCG Primo Levi
                </h1>
                <p class="text-lg text-gray-600 mt-4 leading-relaxed">
                    Per supportare al meglio l'importante scelta della scuola superiore, il nostro Istituto organizza dei Ministage di Orientamento, che permetteranno agli studenti di terza media di vivere un'esperienza diretta all'interno delle nostre aule. L'esperienza complessiva dura circa due ore.
                </p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- SEZIONE 1: COS'È UN MINISTAGE -->
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
                        <h2 class="text-2xl font-bold text-gray-800">Cos'è un Ministage?</h2>
                    </div>
                    <p class="text-gray-700">
                        È un'opportunità per gli studenti di terza media di trascorrere alcune ore presso la nostra scuola, inseriti direttamente in una classe. Lo scopo è far sperimentare in modo immersivo l'ambiente scolastico, i metodi di insegnamento e le materie di studio, facilitando così una scelta più consapevole.
                    </p>
                </section>

                <!-- SEZIONE 2: COME SI SVOLGE -->
                <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition duration-300">
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.001 12.001 0 002.944 12v6.655c0 .245.09.48.257.653L7 22l-1.92-2.195"></path></svg>
                        <h2 class="text-2xl font-bold text-gray-800">Come si svolge?</h2>
                    </div>
                    <ul class="space-y-3 text-gray-700 list-none pl-0">
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Assegnazione a una classe e accoglienza da un docente o tutor.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Partecipazione come uditore attivo a due ore di lezione consecutive curricolari.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Durata complessiva dell'esperienza: circa due ore.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Tutoraggio costante per supporto e domande.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-500 font-extrabold text-xl mr-2">&bull;</span>
                            <span>Tutti i Lunedì e Mercoledì di Novembre e i primi tre di Dicembre i ragazzi seguiranno due ore di lezione (2°e3° oppure 5°-6° o 7°) presso il nostro istituto.</span>
                        </li>
                    </ul>
                </section>

                <!-- SEZIONE 3: OBIETTIVI (Ora occupa l'intera riga) -->
                <section class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg border-l-4 border-teal-500">
                    <div class="flex items-center mb-4">
                        <svg class="w-8 h-8 text-teal-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v14c-1.4 1.4-3.5 1.7-6 1.7s-4.6-.3-6-1.7zm12-14v14c-1.4 1.4-3.5 1.7-6 1.7s-4.6-.3-6-1.7"></path></svg>
                        <h2 class="text-2xl font-bold text-gray-800">Obiettivi principali</h2>
                    </div>
                    <ul class="space-y-2 text-gray-700 list-disc pl-5">
                        <li>Valutare l'ambiente e interagire con gli studenti.</li>
                        <li>Comprendere l'approccio didattico e il livello richiesto.</li>
                        <li>Sciogliere i dubbi sul percorso di studi.</li>
                    </ul>
                </section>
            </main>

            <!-- SEZIONE 4: ORGANIZZAZIONE E CONTATTI (Footer-like) -->
            <footer class="mt-8 pt-6 border-t border-gray-300">
                <div class="bg-gray-100 p-6 rounded-xl text-center shadow-inner">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Organizzazione e Contatti</h3>
                    <p class="text-gray-700 mb-4">Organizzazione a cura delle Funzioni Orientamento:</p>

                    <div class="space-y-1">
                        <p class="text-lg font-medium text-indigo-700">
                            Prof. ssa Laura Corvi e Prof. ssa Mariagrazia Calabrese
                        </p>
                        <p class="text-gray-600">
                            ITSCG PRIMO LEVI DI SEREGNO
                        </p>
                        <p class="text-gray-600">
                            VIA BRIANTINA 68
                        </p>
                    </div>
                </div>
            </footer>
            
            <!-- Contenitori per le due viste Studente (Home e Dettaglio Date) -->
            <h2 class="text-4xl font-extrabold text-gray-800 text-center mb-10 mt-12">Scegli il tuo Indirizzo</h2>
            
            <!-- Vista 1: Selezione Corso -->
            <div id="course-selection-view" class="space-y-12">
                <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Le schede dei corsi saranno generate qui (SOLO NOMI) -->
                </div>
            </div>
            
            <!-- Vista 2: Selezione Data per Corso Specifico (Nascosta inizialmente) -->
            <div id="date-selection-view" class="hidden space-y-6 p-6 bg-white rounded-xl shadow-lg">
                <button id="back-to-courses-btn" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 transition duration-150 border border-indigo-200 flex items-center">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Torna agli Indirizzi
                </button>
                <h3 class="text-3xl font-bold text-gray-800 border-b pb-2">Date disponibili per: <span id="selected-course-title" class="text-indigo-600"></span></h3>
                <div id="dates-container" class="space-y-4">
                    <!-- Le date disponibili per il corso selezionato saranno generate qui -->
                </div>
            </div>

        </section>


        <!-- Modale di Prenotazione -->
        <div id="booking-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-lg rounded-xl shadow-2xl">
                <h3 class="text-2xl font-bold mb-4 text-indigo-600">Conferma Prenotazione Stage</h3>
                <p class="text-gray-600 mb-2">Stage: <span id="modal-course-name" class="font-bold"></span></p>
                <p class="text-gray-600 mb-4">Data: <span id="modal-date" class="font-bold"></span></p>
                
                <form id="booking-form" class="space-y-4">
                    <input type="hidden" id="booking-course-id">
                    <input type="hidden" id="booking-date">

                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Nome e Cognome dello Studente</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-school" class="block text-sm font-medium text-gray-700">Scuola Media di Provenienza</label>
                        <input type="text" id="student-school" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome completo della tua scuola media">
                    </div>
                    <div>
                        <label for="student-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="student-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-phone" class="block text-sm font-medium text-gray-700">Cellulare</label>
                        <input type="tel" id="student-phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="close-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                        <button type="submit" id="confirm-booking-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">Conferma e Genera PDF</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modale di Cancellazione -->
        <div id="cancellation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-lg rounded-xl shadow-2xl">
                <h3 class="text-2xl font-bold mb-6 text-red-600">Cancellazione Prenotazione</h3>
                
                <p class="text-gray-600 mb-4 text-sm">Per annullare, inserisci il codice di prenotazione univoco che trovi nel PDF di conferma. L'annullamento è immediato.</p>
                
                <form id="cancellation-form" class="space-y-4">
                    <div>
                        <label for="cancellation-code" class="block text-sm font-medium text-gray-700">Codice Prenotazione</label>
                        <input type="text" id="cancellation-code" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Esempio: X3H4K9J2">
                    </div>
                    <div>
                        <label for="cancellation-reason" class="block text-sm font-medium text-gray-700">Motivazione della Cancellazione</label>
                        <textarea id="cancellation-reason" rows="2" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Es. Ho già partecipato ad un altro stage."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="close-cancellation-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-150">Annulla</button>
                        <button type="submit" id="confirm-cancellation-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150 shadow-md">Conferma Cancellazione</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modale Login Docente -->
        <div id="docente-login-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
            <div class="modal-content relative bg-white p-6 sm:p-8 w-full max-w-sm rounded-xl shadow-2xl border-t-8 border-indigo-700">
                <div class="text-center mb-6">
                    <svg class="w-12 h-12 mx-auto text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-1a3 3 0 00-3-3H8a3 3 0 00-3 3v1h12zm-9-10a4 4 0 11-8 0 4 4 0 018 0zm-7 0a7 7 0 1014 0 7 7 0 00-14 0zm15 10a4 4 0 100-8 4 4 0 000 8zM12 11a4 4 0 100-8 4 4 0 000 8z"></path></svg>
                    <h3 class="text-2xl font-bold mt-3 text-indigo-800">Accesso Riservato Docenti</h3>
                    <p class="text-gray-500 text-sm">Inserisci le credenziali ITSCG.</p>
                </div>
                
                <form id="docente-login-form" class="space-y-4">
                    <div>
                        <label for="docente-username" class="block text-sm font-medium text-gray-700">Nome Utente</label>
                        <input type="text" id="docente-username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" value="docente">
                    </div>
                    <div>
                        <label for="docente-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="docente-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" value="12345">
                    </div>
                    
                    <div class="flex justify-end pt-4">
                        <button type="submit" id="confirm-docente-login-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">Accedi</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
</body>
</html>
