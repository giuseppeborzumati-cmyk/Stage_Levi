
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot AI - ITSCG Primo Levi Seregno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animazione per lo sfondo sfumato */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            /* Colori dal file originale: blu profondo, rosso, blu chiaro, giallo */
            background: linear-gradient(-45deg, #1d4ed8, #ef4444, #3182ce, #eab308);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            font-family: 'Inter', sans-serif;
            color: #1a202c;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Allineamento in alto per non forzare l'altezza */
            align-items: center;
            min-height: 100vh;
            padding: 1rem 1rem 3rem 1rem; /* Più padding in basso */
            margin: 0;
        }
        .main-content {
            display: flex;
            flex-direction: column; /* Stacks elements vertically: Chatbot SOPRA, Info SOTTO */
            gap: 2.5rem;
            align-items: center;
            width: 100%;
            max-width: 1000px; /* Aumentato il limite massimo di larghezza per il chatbot */
            padding: 0;
        }

        .text-box, .chatbot-box {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            border: 4px solid;
            width: 100%; /* Entrambi usano l'intera larghezza del main-content (max 1000px) */
        }
        .text-box {
            border-image: linear-gradient(45deg, #1d4ed8, #3b82f6, #93c5fd) 1;
        }
        .chatbot-box {
            min-height: 500px; /* Altezza minima per la chat */
            border-image: linear-gradient(45deg, #eab308, #f59e0b, #ef4444) 1;
        }
        
        .text-box h1 {
            color: #1d4ed8;
        }
        
        .chatbot-window {
            height: 100%;
            width: 100%;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chatbot-header {
            background: linear-gradient(90deg, #1d4ed8, #3b82f6);
            color: white;
            padding: 1.25rem;
            border-bottom: 2px solid #2563eb;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message-container {
            display: flex;
            margin-bottom: 1rem;
        }
        /* Stili per messaggi User e Bot - Aggiungo word-break per prevenire overflow */
        .bot-message {
            background-color: #e0f2fe; /* Light Blue */
            color: #1e40af; /* Darker Blue text */
            border-radius: 16px 16px 16px 4px;
            padding: 1rem 1.25rem;
            max-width: 85%;
            align-self: flex-start;
            font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            white-space: pre-wrap;
            word-break: break-word; /* FIX: Evita che le parole lunghe escano dal riquadro */
            box-sizing: border-box;
        }
        .user-message {
            background-color: #3b82f6; /* Primary Blue */
            color: white;
            border-radius: 16px 16px 4px 16px;
            padding: 1rem 1.25rem;
            max-width: 85%;
            align-self: flex-end;
            font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            word-break: break-word; /* FIX: Evita che le parole lunghe escano dal riquadro */
            box-sizing: border-box;
        }
        .suggested-questions-container {
            padding: 1rem;
            border-top: 2px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }
        .suggested-question-button {
            background-color: #f3f4f6;
            color: #1f2937;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            text-align: center;
            border: 1px solid #d1d5db;
        }
        .suggested-question-button:hover {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }
        .animated-logo {
            animation: rotate 10s infinite linear;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-indicator {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            padding: 1rem 1.25rem;
            background-color: #e0f2fe;
            border-radius: 16px 16px 16px 4px;
            align-self: flex-start;
        }
        .dot {
            width: 8px;
            height: 8px;
            background-color: #1e40af;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
            .dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
    </style>
</head>
<body>
    <div class="main-content">
        <!-- CHATBOT AREA (ORA IL PRIMO ELEMENTO PER STARE SOPRA) -->
        <div class="chatbot-box">
            <div class="chatbot-window">
                <div class="chatbot-header flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <!-- Icona SVG per il logo -->
                        <svg class="animated-logo w-8 h-8 text-yellow-300" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-3.95-.49-7-3.85-7-7.93s3.05-7.44 7-7.93v15.86zM13 4.07c3.95.49 7 3.85 7 7.93s-3.05 7.44-7 7.93V4.07z"/>
                        </svg>
                        <h2 class="text-xl font-semibold">Chatbot AI ITSCG "Primo Levi"</h2>
                    </div>
                </div>
                
                <!-- Area Messaggi -->
                <div id="chat-messages" class="chat-messages">
                    <div class="message-container">
                        <div class="bot-message">Ciao! Sono il tuo assistente virtuale. Chiedimi degli indirizzi, dei laboratori o delle date degli Open Day dell'ITSCG Primo Levi di Seregno.</div>
                    </div>
                </div>
                
                <!-- Pulsanti Suggeriti (MANTENUTI E FUNZIONANTI) -->
                <div id="suggested-questions" class="suggested-questions-container">
                    <button class="suggested-question-button" data-question="Quali indirizzi offre la scuola?">Indirizzi offerti</button>
                    <button class="suggested-question-button" data-question="Quando sono i prossimi Open Day?">Open Day 2025</button>
                    <button class="suggested-question-button" data-question="Cosa si intende per Apprendimento Attivo?">Apprendimento Attivo</button>
                </div>

                <!-- Input Chat -->
                <div class="p-4 border-t border-gray-200 flex gap-2 bg-white">
                    <input type="text" id="user-input" placeholder="Scrivi la tua domanda qui..." 
                           class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-800"
                           autocomplete="off" onkeypress="if(event.key === 'Enter') document.getElementById('send-button').click()">
                    <button id="send-button"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        Invia
                    </button>
                </div>
            </div>
        </div>

        <!-- INFORMATION AREA (ORA IL SECONDO ELEMENTO PER STARE SOTTO) -->
        <div class="text-box w-full">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-6 text-center">Informazioni Essenziali per l'Orientamento</h1>
            
            <div class="flex flex-col items-center justify-center gap-6 mb-8">
                <!-- Immagine Placeholder -->
                <img src="https://placehold.co/400x250/3b82f6/ffffff?text=ITSCG+Primo+Levi" alt="Immagine placeholder dell'Istituto Primo Levi Seregno" class="w-full max-w-sm h-auto rounded-lg shadow-xl border-4 border-gray-300 object-cover">
                <p class="text-lg text-gray-700 leading-relaxed text-justify mt-4">
                    Questo strumento è stato ideato per fornire un accesso rapido e guidato alle informazioni chiave dell'ITSCG Primo Levi di Seregno. Le risposte sono tratte direttamente dai documenti ufficiali e dalle **opportunità di indirizzo** presentate agli Open Day.
                </p>
            </div>
            
            <h2 class="text-2xl font-bold mb-6 text-blue-600 text-left">Indirizzi e Dati di Contatto Ufficiali</h2>
            
            <!-- SEZIONE DATI RISTRUTTURATA -->
            <div class="space-y-6">
                <!-- Offerta Formativa -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-xl font-semibold mb-3 text-blue-600 border-b pb-2">Offerta Formativa</h3>
                    <ul class="text-lg text-gray-800 space-y-3 text-left">
                        <li><strong class="text-blue-700 block mb-1">Indirizzi Tecnici:</strong> Costruzioni Ambiente e Territorio (CAT), Logistica (anche corso Quadriennale), Sistema Moda, Relazioni Internazionali per il Marketing.</li>
                        <li><strong class="text-blue-700 block mb-1">Indirizzi Liceali:</strong> Liceo Scientifico Scienze Applicate.</li>
                    </ul>
                </div>

                <!-- Contatti e Sede -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-xl font-semibold mb-3 text-blue-600 border-b pb-2">Contatti e Sede</h3>
                    <ul class="text-lg text-gray-800 space-y-3 text-left">
                        <li class="flex items-start gap-3">
                            <!-- Icona Sede (Mappa) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-red-500 flex-shrink-0"><path d="M20 10V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h4"/><path d="M10 22V6c0-1.1.9-2 2-2h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4"/><path d="M15 16h4"/></svg>
                            <span><strong class="text-blue-700 block">Sede:</strong> Via Briantina, 68 - 20831 Seregno (MB)</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <!-- Icona Telefono -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-red-500 flex-shrink-0"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-3.67-2.94L3 9.7a2 2 0 0 1 2-2h3"/><path d="M12 18h4"/><path d="M18 12h4"/><path d="M12 6h4"/><path d="M18 6h4"/></svg>
                            <span><strong class="text-blue-700 block">Telefono:</strong> <a href="tel:+390362224164" class="hover:underline text-blue-600">0362 224164</a></span>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- FINE SEZIONE DATI RISTRUTTURATA -->
        </div>
    </div>

    <script>
        // --- Configurazione e Stato AI (Mantenuto) ---
        let chatHistory = [];
        let isSending = false;
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // Informazioni specifiche dell'Istituto da contestualizzare per l'AI
        const CONTEXT_INFO = `
            Sei un assistente virtuale per l'orientamento dell'ITSCG "Primo Levi" di Seregno. Il tuo scopo principale è fornire informazioni precise e aggiornate sulla scuola, con particolare enfasi sui programmi di **Orientamento** e sulle opportunità di **Stage (alternanza scuola-lavoro/PCTO)**.
            Rispondi in modo estremamente preciso, cordiale e conciso.
            
            Istruzioni per la Ricerca: DEVI usare la ricerca Google (grounding) per trovare informazioni precise e attuali, specialmente quando l'utente chiede dettagli su:
            1. Stage, PCTO, Alternanza Scuola-Lavoro, o Convenzioni aziendali.
            2. Pagine specifiche di Orientamento, eventi, o programmi didattici.
            3. Dettagli che potrebbero essere presenti solo sulle pagine web ufficiali dell'ITSCG Primo Levi.
            
            Informazioni Istituzionali CHIAVE (Usa queste se non trovi dati più recenti tramite ricerca):
            - Indirizzi Tecnici: Costruzioni, Ambiente e Territorio (CAT), Logistica (anche corso Quadriennale), Sistema Moda, Relazioni Internazionali per il Marketing.
            - Indirizzi Liceali: Liceo Scientifico Scienze Applicate.
            - Filosofia: Promuove l'Apprendimento Attivo, laboratori innovativi (Scuola 4.0, PNRR) e l'Internazionalizzazione del curricolo.
            - Open Day 2025: 15 NOVEMBRE, 29 NOVEMBRE, 13 DICEMBRE (prenotazione obbligatoria).
            - Sede: Via Briantina, 68 - 20831 Seregno (MB).
            - Telefono: 0362 224164.
            
            Integra le informazioni di ricerca con la tua base di conoscenza statica per dare una risposta completa e ben contestualizzata.
        `;

        // --- Funzioni di Utilità UI (Mantenute) ---

        /** Aggiunge un messaggio alla chat e fa lo scroll automatico. */
        function addMessage(text, sender, messageId = null) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container');
            
            const messageBubble = document.createElement('div');
            messageBubble.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            messageBubble.innerHTML = formatTextToHtml(text);
            
            if (messageId) {
                messageBubble.id = messageId;
            }

            messageContainer.appendChild(messageBubble);
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageBubble;
        }

        /** Converte markdown di base (bold, newlines) in HTML. */
        function formatTextToHtml(text) {
            if (!text) return '';
            // Converte grassetto **testo** in <strong>testo</strong>
            let htmlText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Converte le nuove linee in <br>
            htmlText = htmlText.replace(/\n/g, '<br>');
            return htmlText;
        }

        /** Aggiunge l'indicatore di caricamento del bot. */
        function addLoadingIndicator() {
            const loadingContainer = document.createElement('div');
            loadingContainer.classList.add('message-container', 'loading-indicator-container');
            
            const indicator = document.createElement('div');
            indicator.classList.add('loading-indicator');
            indicator.id = 'loading-indicator';
            indicator.innerHTML = `
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            `;
            
            loadingContainer.appendChild(indicator);
            chatMessages.appendChild(loadingContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingContainer;
        }

        /** Rimuove l'indicatore di caricamento. */
        function removeLoadingIndicator() {
            const indicatorContainer = document.querySelector('.loading-indicator-container');
            if (indicatorContainer) {
                indicatorContainer.remove();
            }
        }

        // --- Logica Chatbot Gemini API (Mantenuta) ---

        /** Gestisce la chiamata all'API di Gemini con backoff esponenziale. */
        async function callGeminiAPI(query, systemInstruction, maxRetries = 3) {
            const apiKey = ""; // Lascia vuoto: l'ambiente Canvas lo fornirà
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: chatHistory.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                })).concat([{ parts: [{ text: query }] }]), // Aggiunge la query corrente
                
                tools: [{ "google_search": {} }], // Abilita Google Search Grounding
                
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        // Gestione 429 (Too Many Requests) con backoff esponenziale
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Errore sconosciuto'}`);
                    }

                    return response.json();

                } catch (error) {
                    console.error("Errore nella chiamata API:", error);
                    if (i === maxRetries - 1) {
                        throw new Error("Impossibile connettersi all'AI dopo diversi tentativi.");
                    }
                }
            }
        }

        /** Invia il messaggio dell'utente e gestisce la risposta dell'AI. */
        async function sendMessage() {
            const query = userInput.value.trim();
            if (!query || isSending) return;

            // 1. Inizializzazione e Stato
            isSending = true;
            userInput.value = '';
            sendButton.disabled = true;

            // 2. Aggiungi messaggio utente alla UI e alla history
            addMessage(query, 'user');
            chatHistory.push({ role: 'user', text: query });

            // 3. Aggiungi indicatore di caricamento
            const loading = addLoadingIndicator();

            try {
                // 4. Chiama l'API
                const result = await callGeminiAPI(query, CONTEXT_INFO);
                
                removeLoadingIndicator();

                const candidate = result.candidates?.[0];
                let botText = "Mi scuso, ho riscontrato un problema nel recuperare le informazioni. Per favore, riprova più tardi.";

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    botText = candidate.content.parts[0].text;
                }

                // 5. Aggiungi risposta del bot alla UI e alla history
                addMessage(botText, 'bot');
                chatHistory.push({ role: 'bot', text: botText });
                
            } catch (error) {
                console.error("Errore fatale:", error);
                removeLoadingIndicator();
                addMessage("Si è verificato un errore critico: " + error.message, 'bot');
                // Non aggiungiamo questo errore alla chatHistory per evitare di inquinare le conversazioni successive
            } finally {
                // 6. Ripristina lo stato
                isSending = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        // --- Event Listeners (Mantenuti) ---
        document.getElementById('send-button').addEventListener('click', sendMessage);

        document.querySelectorAll('.suggested-question-button').forEach(button => {
            button.addEventListener('click', () => {
                const question = button.dataset.question;
                userInput.value = question;
                sendMessage();
            });
        });

        // Focalizza l'input al caricamento
        window.onload = () => {
             userInput.focus();
        };

    </script>
</body>
</html>
